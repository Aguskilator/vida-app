<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDA - Asistente de Donaci√≥n</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Roboto as requested -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- three.js for interactive background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Custom Styles and Animations -->
    <style>
        /* New Color Palette and Font from the design specification */
        :root {
            --vida-bg: #E3F2FD; /* Azul cielo claro */
            --vida-text-dark: #0D47A1; /* Azul oscuro m√©dico */
            --vida-btn-green: #66BB6A; /* Verde esperanza suave */
            --vida-btn-green-hover: #43A047;
            --vida-text-secondary: #757575; /* Gris medio */
            --vida-bg-footer: #F5F5F5; /* Gris claro */
            --vida-chat-bot-bg: #F9F9F9; /* Gris claro para burbuja del bot */
            --vida-chat-user-bg: #E8F5E9; /* Verde muy claro para burbuja de usuario */
            --vida-btn-feedback: #4FC3F7; /* Azul cielo para feedback */
            --vida-suggest-btn-bg: #E0F2F7; /* Azul muy claro para bot√≥n de sugerencia */
            --vida-suggest-btn-hover: #B3E5FC; /* Azul m√°s claro para hover */
            --vida-module-btn-bg: #E0F2F7; /* Color para botones de m√≥dulo */
            --vida-module-btn-hover: #B3E5FC; /* Color hover para botones de m√≥dulo */
            --vida-module-btn-text: #0D47A1; /* Color de texto para botones de m√≥dulo */
            --vida-quiz-btn-correct: #4CAF50; /* Verde para respuesta correcta */
            --vida-quiz-btn-incorrect: #F44336; /* Rojo para respuesta incorrecta */
            --vida-quiz-btn-disabled: #BDBDBD; /* Gris para botones deshabilitados */
        }

        body {
            font-family: 'Roboto', sans-serif;
            /* Fondo con degradado suave y tenue como el quiz */
            background-color: #f0f9ff;
            background-image: 
                radial-gradient(at 47% 33%, hsl(200.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 9% 62%, hsl(215.00, 80%, 80%) 0px, transparent 50%),
                radial-gradient(at 82% 65%, hsl(140.00, 80%, 80%) 0px, transparent 50%),
                radial-gradient(at 24% 88%, hsl(20.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 75% 8%, hsl(340.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 56% 33%, hsl(260.00, 80%, 85%) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
        }



        /* Canvas para part√≠culas interactivas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        /* Estilo especial para el t√≠tulo principal */
        .vida-main-title {
            color: #0F1B3C;
            font-weight: 900;
            letter-spacing: 0.02em;
            /* Sombra y destello elegante */
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(255, 255, 255, 0.6),
                0 2px 8px rgba(15, 27, 60, 0.4),
                0 4px 16px rgba(15, 27, 60, 0.2);
            filter: 
                drop-shadow(0 0 15px rgba(255, 255, 255, 0.7))
                drop-shadow(0 2px 8px rgba(15, 27, 60, 0.3));
            /* Animaci√≥n sutil de resplandor */
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% {
                text-shadow: 
                    0 0 20px rgba(255, 255, 255, 0.8),
                    0 0 40px rgba(255, 255, 255, 0.6),
                    0 2px 8px rgba(15, 27, 60, 0.4),
                    0 4px 16px rgba(15, 27, 60, 0.2);
            }
            100% {
                text-shadow: 
                    0 0 25px rgba(255, 255, 255, 0.9),
                    0 0 50px rgba(255, 255, 255, 0.7),
                    0 2px 8px rgba(15, 27, 60, 0.5),
                    0 4px 16px rgba(15, 27, 60, 0.3);
            }
        }
        /* Subt√≠tulo con color y formato mejorado */
        .vida-main-subtitle {
            color: #0D1B2A;
            font-size: 1.35rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            /* Sombra de texto para mejor contraste */
            text-shadow: 0 1px 4px rgba(255, 255, 255, 0.9), 0 2px 8px rgba(13, 27, 42, 0.25);
            /* A√±adir un resplandor sutil */
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
        }

        /* Estilos espec√≠ficos para cada l√≠nea del subt√≠tulo */
        .subtitle-line-1 {
            font-size: 1.4rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .subtitle-line-2 {
            font-size: 1.25rem;
            font-weight: 400;
            line-height: 1.6;
            opacity: 0.95;
        }

        .subtitle-line-1 .font-semibold,
        .subtitle-line-2 .font-semibold {
            font-weight: 700;
            color: #1A237E;
        }

        /* Banner hero principal */
        .vida-hero-banner {
            position: relative;
            padding: 0.75rem 0.75rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(255, 255, 255, 0.88) 50%, 
                rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 6px 20px rgba(13, 27, 42, 0.08),
                0 3px 10px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            max-width: 100%;
            margin: 0 auto;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        @media (min-width: 640px) {
            .vida-hero-banner {
                padding: 2rem 2rem;
                border-radius: 1.5rem;
                box-shadow: 
                    0 10px 35px rgba(13, 27, 42, 0.12),
                    0 5px 15px rgba(255, 255, 255, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }
        }

        @media (min-width: 1024px) {
            .vida-hero-banner {
                max-width: 42rem;
                margin: 0;
                padding: 2.5rem 2.5rem;
            }
        }

        .vida-hero-banner:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(26, 35, 126, 0.15),
                0 6px 20px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        /* Efecto decorativo en el banner */
        .vida-hero-banner::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(135deg, 
                rgba(26, 35, 126, 0.1) 0%, 
                rgba(13, 71, 161, 0.08) 25%, 
                rgba(25, 118, 210, 0.06) 50%, 
                rgba(13, 71, 161, 0.08) 75%, 
                rgba(26, 35, 126, 0.1) 100%);
            border-radius: 2rem;
            z-index: -1;
        }

        /* Fade-in animation for a smooth load */
        .fade-in-element {
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Justify chat text */
        .chat-bubble-text {
            text-align: justify;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #FFFFFF; }
        .chat-messages::-webkit-scrollbar-thumb { background: #BDBDBD; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--vida-text-secondary); }

        /* Initially hide these screens/modals */
        #chat-screen, #about-modal, #feedback-modal, #privacy-modal { display: none; }
        
        /* Styles for radio buttons in feedback form */
        .feedback-radio-group label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        /* Styles for quiz question card */
        .quiz-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .quiz-buttons button {
            transition: all 0.2s;
        }

        /* Styling for the custom SVG robot */
        /* Base styles for the SVG robot to ensure consistent appearance */
        .robot-svg-icon { /* Class for the SVG element itself */
            width: 100%;
            height: 100%;
        }
        .robot-svg-icon .heart-icon {
            fill: #EF5350; /* Red heart */
        }
        .robot-svg-icon .head-shape, .robot-svg-icon .torso {
            fill: #FFFFFF; /* White parts */
            stroke: #D1D5DB; /* Light gray border */
            stroke-width: 2;
        }
        .robot-svg-icon .neck {
            fill: #90A4AE; /* Gray neck */
        }
        .robot-svg-icon .arm-left, .robot-svg-icon .arm-right {
            stroke: #42A5F5; /* Blue arms */
            stroke-width: 15;
            fill: none;
            stroke-linecap: round;
        }
        .robot-svg-icon .screen {
            fill: #1F2937; /* Dark screen */
            rx: 10;
        }
        .robot-svg-icon .eye {
            fill: #40C4FF; /* Light blue eyes */
        }
        .robot-svg-icon .smile {
            stroke: #40C4FF; /* Light blue smile */
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }

        /* Animations for the robot SVG */
        @keyframes float-animation {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes typing-animation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(-2px); }
            100% { transform: translateY(0px); }
        }
        
        /* Apply animations to specific elements by ID or Class for different contexts */
        #main-robot-container svg { /* Target the SVG inside the main container */
            animation: float-animation 3s ease-in-out infinite;
        }
        /* Specific targeting for heart and head within message/typing indicator SVGs */
        .message-robot-avatar .heart-icon {
            animation: heart-beat 1.5s infinite;
        }
        .typing-indicator-robot .head {
            animation: typing-animation 0.7s infinite;
        }

        /* Fondo exclusivo para la pantalla de conversaci√≥n del chatbot */
        #chat-screen {
            background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 50%, #e3f2fd 100%);
        }

        /* Robot Circle Styles mejorados con glassmorphism */
        .robot-circle-bg {
            width: 420px;
            height: 420px;
            min-width: 320px;
            min-height: 320px;
            max-width: 450px;
            max-height: 450px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(255, 255, 255, 0.75) 50%, 
                rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 
                0 15px 45px rgba(13, 27, 42, 0.12), 
                0 8px 25px rgba(255, 255, 255, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: breathe 4s ease-in-out infinite;
        }

        .robot-circle-bg:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 
                0 20px 55px rgba(13, 27, 42, 0.15), 
                0 10px 30px rgba(255, 255, 255, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.9);
        }

        @media (max-width: 640px) {
            .robot-circle-bg {
                width: 240px;
                height: 240px;
                min-width: 200px;
                min-height: 200px;
                max-width: 260px;
                max-height: 260px;
            }
        }

        .robot-img-main {
            width: 115%;
            height: 115%;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            transition: all 0.4s ease;
        }

        /* Animaci√≥n mejorada de respiraci√≥n del robot */
        @keyframes enhancedBreathing {
            0% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            }
            50% { 
                transform: scale(1.02) rotate(0.5deg); 
                filter: drop-shadow(0 6px 24px rgba(76,175,80,0.15));
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            }
        }

        #main-robot-container svg,
        #main-robot-container img {
            animation: enhancedBreathing 4s ease-in-out infinite;
        }

        /* Efectos de hover mejorados para botones */
        .enhanced-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .enhanced-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .enhanced-button:hover::before {
            left: 100%;
        }

        .enhanced-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }

        /* Botones premium mejorados */
        .btn-primary-enhanced {
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            border: none;
            min-width: 220px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .btn-secondary-enhanced {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            border: none;
            min-width: 220px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        /* Glassmorphism para cards/modales */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        /* Clase espec√≠fica para modales con mejor legibilidad */
        .modal-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.25);
        }

        /* Espec√≠fico para m√≥viles - manejo del teclado virtual */
        :root {
            --vh: 1vh;
        }
        
        @supports (-webkit-touch-callout: none) {
            #chat-screen {
                /* Usar viewport fijo para iOS */
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
        }
        
        /* Mejoras para el chat en m√≥viles */
        @media (max-width: 640px) {
            /* Solo prevenir el scroll cuando el chat est√° abierto */
            body.chat-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            html.chat-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            #chat-screen {
                /* Prevenir zoom en inputs en iOS */
                -webkit-text-size-adjust: 100%;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 100vh !important;
                height: calc(var(--vh, 1vh) * 100) !important;
                width: 100vw !important;
                overflow: hidden;
            }
            
            #chat-screen > div {
                height: 100vh !important;
                height: calc(var(--vh, 1vh) * 100) !important;
                max-height: 100vh !important;
                max-height: calc(var(--vh, 1vh) * 100) !important;
                display: flex;
                flex-direction: column;
            }
            
            #chat-input {
                /* Prevenir zoom en inputs */
                font-size: 16px !important;
                -webkit-appearance: none;
                appearance: none;
                border-radius: 25px;
                /* Prevenir el scroll autom√°tico al enfocar */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
            
            /* Asegurar que el footer se mantenga visible */
            #chat-screen footer {
                position: relative;
                z-index: 10;
                flex-shrink: 0;
                bottom: 0;
            }
            
            /* Mejorar el scroll del contenedor de mensajes */
            #chat-container-wrapper {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Prevenir el rebote del scroll */
                overscroll-behavior: contain;
            }
            
            /* Prevenir el zoom en toda la pantalla de chat */
            #chat-screen * {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
        }
        
        /* Viewport din√°mico para m√≥viles modernos */
        @media (max-width: 640px) and (max-height: 800px) {
            #chat-screen .w-full.h-full {
                height: 100vh;
                height: 100dvh;
                min-height: 100vh;
                min-height: 100dvh;
            }
        }
    </style>
</head>
<body class="text-slate-800 antialiased">
    <canvas id="bg-canvas"></canvas>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="w-full p-4 sm:p-6 bg-transparent fade-in-element" style="animation-delay: 0.2s;">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-0.5 sm:space-x-2 lg:space-x-2">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 lg:w-14 lg:h-14 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center shadow-lg">
                        <!-- Heart Icon for VIDA logo -->
                        <svg class="h-4 w-4 sm:h-6 sm:w-6 lg:h-8 lg:w-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-16 w-auto sm:h-10 sm:w-auto lg:h-28 lg:w-auto object-contain max-w-[220px] sm:max-w-[140px] lg:max-w-[350px]" onerror="this.onerror=null;this.src='https://placehold.co/300x90/E3F2FD/0D47A1?text=VIDA';" />
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <!-- Privacy button -->
                    <button id="privacy-btn" class="text-[var(--vida-text-dark)] font-semibold py-1 px-2 sm:py-2 sm:px-4 text-xs sm:text-sm rounded-lg transition hover:bg-blue-200/50">Aviso de Privacidad</button>
                    <!-- About button -->
                    <button id="about-btn" class="px-2 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm rounded-lg bg-[var(--vida-btn-green)] text-white font-semibold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] focus:ring-offset-2 enhanced-button">
                        ¬øQu√© hace VIDA?
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col lg:flex-row items-center justify-center container mx-auto px-4 py-6 sm:py-8 lg:py-8 text-center lg:text-left gap-6 sm:gap-8 lg:gap-12">
            <div class="lg:w-3/5 flex flex-col items-center lg:items-start space-y-4 sm:space-y-6">
                <!-- Banner principal con dise√±o elegante -->
                <div class="vida-hero-banner fade-in-element w-full" style="animation-delay: 0.3s;">
                    <h2 class="vida-main-title text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl font-bold text-[var(--vida-text-dark)] fade-in-element leading-tight" style="animation-delay: 0.4s;">
                        Voz de Informaci√≥n y Donaci√≥n Asistida
                    </h2>
                    <div class="vida-main-subtitle text-xs sm:text-base md:text-lg lg:text-xl mt-2 sm:mt-5 fade-in-element" style="animation-delay: 0.6s;">
                        <p class="subtitle-line-1 mb-1 sm:mb-3 text-center lg:text-left text-xs sm:text-base">
                            <span class="font-semibold">Tu aliado informativo</span> en momentos cr√≠ticos
                        </p>
                        <p class="subtitle-line-2 text-center lg:text-left leading-relaxed text-xs sm:text-base">
                            Estoy aqu√≠ para ayudarte a tomar decisiones 
                            <span class="font-semibold">claras, humanas y fundamentadas</span>
                        </p>
                    </div>
                </div>
                
                <!-- Botones de acci√≥n debajo del banner, centrados con respecto al banner -->
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center items-center self-center w-full max-w-2xl fade-in-element lg:justify-start lg:self-start" style="animation-delay: 0.8s;">
                    <button id="start-chat-btn" class="btn-primary-enhanced bg-[var(--vida-btn-green)] text-white font-bold py-2 px-4 sm:py-4 sm:px-8 text-xs sm:text-base rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 enhanced-button flex items-center justify-center gap-2 w-full sm:w-auto">
                        <svg class="h-3 w-3 sm:h-5 sm:w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4.913 2.658c2.075-.27 4.19-.408 6.337-.408 2.147 0 4.262.139 6.337.408 1.922.25 3.291 1.861 3.405 3.727a4.403 4.403 0 00-1.032-.211 50.89 50.89 0 00-8.42 0c-2.358.196-4.04 2.19-4.04 4.434v4.286a4.47 4.47 0 002.433 3.984L7.28 21.53A.75.75 0 016 21v-4.03a48.527 48.527 0 01-1.087-.128C2.905 16.58 1.5 14.833 1.5 12.862V6.638c0-1.97 1.405-3.718 3.413-3.979z"/>
                            <path d="M15.75 7.5c-1.376 0-2.739.057-4.086.169C10.124 7.797 9 9.103 9 10.609v4.285c0 1.507 1.128 2.814 2.67 2.94 1.243.102 2.5.157 3.768.165l2.782 2.781a.75.75 0 001.28-.53v-2.39l.33-.026c1.542-.125 2.67-1.433 2.67-2.940v-4.286c0-1.505-1.125-2.811-2.664-2.94A49.392 49.392 0 0015.75 7.5z"/>
                        </svg>
                        Iniciar conversaci√≥n
                    </button>
                    <!-- New Quiz Module Button -->
                    <button id="start-quiz-btn" class="btn-secondary-enhanced bg-[var(--vida-btn-feedback)] text-white font-bold py-2 px-4 sm:py-4 sm:px-8 text-xs sm:text-base rounded-full shadow-lg hover:bg-blue-400 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center gap-2 enhanced-button w-full sm:w-auto">
                        <svg class="h-3 w-3 sm:h-5 sm:w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                        </svg>
                        ¬øQu√© tanto sabes sobre donar?
                    </button>
                </div>
            </div>
            
            <!-- Robot Image mejorado -->
            <div id="main-robot-container" class="lg:w-2/5 flex items-center justify-center lg:items-start lg:justify-start mt-6 sm:mt-8 lg:mt-[-2rem] lg:ml-[-3rem] fade-in-element" style="animation-delay: 1s;">
                <div class="robot-circle-bg">
                    <img src="robot.png" alt="Robot VIDA" class="robot-img-main" onerror="this.onerror=null;this.src='https://placehold.co/437x437/FFFFFF/FFFFFF?text=Robot';" />
                </div>
            </div>
        </main>

        <footer class="w-full py-1 px-0 sm:p-1 bg-[var(--vida-bg-footer)] fade-in-element" style="animation-delay: 1.2s;">
            <div class="container mx-auto max-w-xl lg:max-w-2xl px-4 sm:px-12 lg:px-16">
                <div class="flex flex-col items-center justify-center py-1 sm:py-2">
                    <p class="text-[10px] sm:text-base md:text-xs text-slate-700 font-medium mb-0 leading-tight max-w-xs sm:max-w-md lg:max-w-lg text-center">
                        VIDA es una herramienta informativa. No sustituye la atenci√≥n m√©dica.<br class="hidden sm:block">
                        <span class="block sm:inline">Versi√≥n piloto para donaci√≥n.</span>
                    </p>
                    <a href="https://www.gob.mx/cenatra" target="_blank" class="text-[10px] sm:text-xs text-[var(--vida-btn-feedback)] underline font-semibold hover:text-[var(--vida-text-dark)] transition-colors block mt-0 text-center">
                        Ir a CENATRA
                    </a>
                </div>
            </div>
        </footer>
    </div>
    
    <button id="feedback-btn" class="fixed bottom-16 sm:bottom-5 left-5 bg-[var(--vida-btn-feedback)] text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:scale-105 transition-transform z-20 flex items-center gap-2 enhanced-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.08-3.239A8.939 8.939 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.416 11.603a.75.75 0 00-.029.048l.029-.048zM5.022 13.013a.75.75 0 00.213.024l.028-.024z" clip-rule="evenodd" /></svg>
        Danos tu opini√≥n
    </button>
    
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative max-h-[85vh] sm:max-h-[90vh] overflow-y-auto">
            <button id="close-about-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-2 sm:mb-4 pr-8">¬øQu√© hace VIDA?</h3>
            <div class="text-slate-700 text-justify space-y-2 sm:space-y-3 text-xs sm:text-base" style="text-align: justify;">
                <p>VIDA es un asistente conversacional creado para brindar orientaci√≥n emp√°tica, clara y confiable sobre la donaci√≥n de √≥rganos, tejidos y sangre en M√©xico.</p>
                <p>Fue desarrollado como una herramienta informativa para acompa√±ar a personas que tienen dudas, miedo o simplemente desean entender mejor c√≥mo funciona la donaci√≥n, ya sea como donadores voluntarios o como familiares que enfrentan una decisi√≥n en un momento dif√≠cil.</p>
                <p>VIDA no sustituye atenci√≥n m√©dica ni asesor√≠a profesional directa, pero est√° dise√±ada para ayudarte a:</p>
                <ul class="list-disc pl-3 sm:pl-6 space-y-1 text-xs sm:text-base">
                    <li>Entender qu√© √≥rganos, tejidos y componentes sangu√≠neos se pueden donar.</li>
                    <li>Saber qui√©n puede ser donador y en qu√© momentos.</li>
                    <li>Desmitificar ideas falsas sobre la donaci√≥n.</li>
                    <li>Reflexionar con libertad sobre el acto de donar.</li>
                    <li>Obtener enlaces seguros y oficiales para registrarte como donador voluntario o encontrar centros de donaci√≥n.</li>
                </ul>
                <p>VIDA es una voz que informa sin juzgar, acompa√±a sin presionar, y cree que donar es un acto de amor y conciencia.</p>
            </div>
        </div>
    </div>
    
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative max-h-[85vh] sm:max-h-[90vh] overflow-y-auto">
            <button id="close-privacy-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-2 sm:mb-4 pr-8">Aviso de Privacidad ‚Äì VIDA</h3>
            <div class="text-slate-700 text-justify text-xs sm:text-base" style="text-align: justify;">
                <p class="mb-2 sm:mb-3">VIDA (Voz de Informaci√≥n y Donaci√≥n Asistida) es una herramienta informativa que opera sin recopilar datos personales sensibles. No se almacenan nombres, ubicaciones, correos electr√≥nicos ni respuestas espec√≠ficas de los usuarios. Las conversaciones no son monitoreadas ni utilizadas para fines comerciales o de perfilamiento.</p>
                <p class="mb-2 sm:mb-3">El uso de esta plataforma es completamente an√≥nimo y su √∫nico prop√≥sito es ofrecer orientaci√≥n general sobre procesos de donaci√≥n post mortem, con base en informaci√≥n p√∫blica y normativa mexicana vigente.</p>
                <p class="mb-2 sm:mb-3">VIDA no sustituye asesor√≠a m√©dica, psicol√≥gica ni legal. Si requiere atenci√≥n m√©dica o desea formalizar su voluntad de donar, debe acudir a las instancias oficiales correspondientes (CENATRA, IMSS, ISSSTE, etc.).</p>
                <p>Para cualquier comentario, puede escribir al desarrollador del proyecto a trav√©s del formulario de contacto disponible.</p>
            </div>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative overflow-hidden max-h-[85vh] sm:max-h-[90vh]">
            <div id="feedback-form-container" class="overflow-y-auto max-h-full">
                 <button id="close-feedback-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
                <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-1 sm:mb-2 pr-8">Encuesta an√≥nima de satisfacci√≥n ‚Äì VIDA</h3>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 sm:mb-6">Responde en menos de 1 minuto:</p>
                <form id="feedback-form">
                    <div class="space-y-3 sm:space-y-6">
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">1. ¬øLa informaci√≥n que recibiste fue clara y √∫til?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="clarity" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="clarity" value="parcialmente" class="mr-2"> Parcialmente</label>
                                <label><input type="radio" name="clarity" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">2. ¬øEl lenguaje utilizado te pareci√≥ comprensible?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="language" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="language" value="regular" class="mr-2"> Regular</label>
                                <label><input type="radio" name="language" value="dificil" class="mr-2"> Dif√≠cil de entender</label>
                            </div>
                        </div>
                         <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">3. ¬øTe ayud√≥ a resolver tus dudas sobre donaci√≥n?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="solved_doubts" value="si" class="mr-2" required> S√≠ completamente</label>
                                <label><input type="radio" name="solved_doubts" value="algunas" class="mr-2"> Algunas</label>
                                <label><input type="radio" name="solved_doubts" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">4. ¬øRecomendar√≠as esta herramienta a otros usuarios?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="recommend" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="recommend" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <label for="comments" class="font-semibold text-gray-700 mb-1 sm:mb-2 block text-xs sm:text-base">Comentarios adicionales</label>
                            <textarea id="comments" name="comments" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-feedback)] text-xs sm:text-sm"></textarea>
                        </div>
                    </div>
                    <div class="mt-4 sm:mt-8 text-right">
                        <button type="submit" class="bg-[var(--vida-btn-green)] text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors text-xs sm:text-base">Enviar respuesta</button>
                    </div>
                </form>
            </div>
             <div id="feedback-thanks" class="hidden text-center">
                 <svg class="mx-auto h-12 w-12 sm:h-16 sm:w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mt-2 sm:mt-4 text-lg sm:text-2xl font-bold text-[var(--vida-text-dark)]">¬°Gracias!</h3>
                <p class="mt-1 sm:mt-2 text-gray-600 text-sm sm:text-base">Tu opini√≥n nos importa y nos ayuda a mejorar VIDA.</p>
            </div>
        </div>
    </div>


    <div id="chat-screen" class="fixed inset-0 bg-slate-100 flex items-stretch justify-center p-0 sm:p-4 z-40 transition-opacity duration-300 opacity-0">
        <div class="w-full h-full sm:max-w-4xl sm:h-[90vh] bg-white sm:rounded-2xl shadow-2xl flex flex-col relative overflow-hidden">
            <header class="bg-white border-b border-gray-200 p-3 sm:p-4 sm:rounded-t-2xl flex items-center justify-between shadow-sm flex-shrink-0">
                 <div class="flex items-center space-x-1">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center mr-1">
                        <!-- Heart Icon for VIDA logo in chat header -->
                        <svg class="h-5 w-5 sm:h-7 sm:w-7 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-10 sm:h-13 w-auto object-contain max-w-[80px] sm:max-w-[90px]" onerror="this.onerror=null;this.src='https://placehold.co/90x40/E3F2FD/0D47A1?text=VIDA';" />
                 </div>
                <button id="close-chat-btn" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                     <svg class="h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <main class="flex-1 flex overflow-hidden min-h-0">
                <div id="chat-container-wrapper" class="flex-1 flex flex-col p-3 sm:p-4 lg:p-6 overflow-y-auto chat-messages">
                     <div id="chat-container" class="flex flex-col space-y-3 sm:space-y-4"></div>
                </div>
                <aside class="w-1/3 bg-slate-50 p-6 border-l border-slate-200 hidden lg:flex flex-col items-center justify-center">
                    <!-- chat-robot-avatar element: using the provided image for the large avatar -->
                    <div id="chat-robot-avatar-large" class="w-48 h-48 mb-4 rounded-full flex items-center justify-center shadow-lg overflow-hidden">
                        <img src="robot.png" alt="Robot VIDA" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/192x192/FFFFFF/FFFFFF?text=Robot';" />
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-lg text-[var(--vida-text-dark)]">Estoy para ayudarte</h3>
                        <p class="text-sm text-[var(--vida-text-secondary)] mt-1">Preg√∫ntame sobre el proceso de donaci√≥n de √≥rganos y tejidos.</p>
                    </div>
                </aside>
            </main>
            <footer class="p-2 sm:p-3 bg-white border-t border-gray-200 sm:rounded-b-2xl flex-shrink-0">
                <div id="suggested-questions-container" class="flex flex-wrap gap-2 mb-2 sm:mb-3 hidden"></div>

                <form id="chat-form" class="flex items-center space-x-2 sm:space-x-3">
                    <button type="button" id="suggest-questions-btn" class="bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] rounded-full p-2 sm:p-2.5 
                                     hover:bg-[var(--vida-suggest-btn-hover)] transition-colors focus:outline-none focus:ring-4 focus:ring-blue-100 
                                     disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0">
                        <svg class="h-4 w-4 sm:h-5 sm:w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        <span id="suggest-button-text" class="ml-1 text-xs sm:text-sm font-semibold hidden sm:inline">Sugiere</span> </button>
                    <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..." autocomplete="off" class="flex-1 w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] transition text-sm sm:text-base">
                    <button type="submit" class="bg-[var(--vida-btn-green)] text-white rounded-full p-2 sm:p-3 hover:bg-[var(--vida-btn-green-hover)] transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatBtn = document.getElementById('start-chat-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn'); 

        // --- Quiz Integration ---
        if (startQuizBtn) {
            startQuizBtn.addEventListener('click', () => {
                // Opci√≥n 1: Abrir quiz en nueva ventana
                // window.open('quiz.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                // Opci√≥n 2: Redirigir a la p√°gina del quiz
                window.location.href = 'quiz.html';
            });
        }

        // --- More DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const chatContainerWrapper = document.getElementById('chat-container-wrapper');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const aboutBtn = document.getElementById('about-btn');
        const closeModalBtn = document.getElementById('close-about-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const feedbackBtn = document.getElementById('feedback-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeFeedbackModalBtn = document.getElementById('close-feedback-modal-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackFormContainer = document.getElementById('feedback-form-container');
        const feedbackThanks = document.getElementById('feedback-thanks');
        const suggestQuestionsBtn = document.getElementById('suggest-questions-btn'); 
        const suggestedQuestionsContainer = document.getElementById('suggested-questions-container'); 
        const suggestButtonText = document.getElementById('suggest-button-text'); 
        const privacyBtn = document.getElementById('privacy-btn');
        const privacyModal = document.getElementById('privacy-modal');
        const closePrivacyModalBtn = document.getElementById('close-privacy-modal-btn');

        // --- State ---
        let chatHistory = [];
        let currentDonorPathStep = null;
        let currentQuizQuestionIndex = -1;
        let quizQuestions = [];

        // --- Module Content Definition ---
        const donorPathModule = {
            // The 'initial' step is now just a trigger. The conversation starts with 'introduction'.
            initial: {}, 
            introduction: {
                text: "¬°Qu√© decisi√≥n tan valiosa est√°s considerando! Aqu√≠ te acompa√±o paso a paso en tu camino como donante.",
                buttons: [
                    { text: "Iniciar camino como donante", action: "donor_path_step1" },
                    { text: "Prefiero hacer una pregunta diferente", action: "reset_chat" }
                ]
            },
            step1: {
                text: "Para poder decidir, es importante que sepas qu√© significa donar. En M√©xico, se puede donar √≥rganos y tejidos despu√©s de fallecer, ya sea por Muerte encef√°lica (cuando el cerebro deja de funcionar por completo) o por Paro card√≠aco (cuando el coraz√≥n deja de latir y ya no se puede revivir). En ambos casos, la donaci√≥n puede salvar vidas o mejorar la salud de muchas personas.",
                buttons: [
                    { text: "S√≠, por favor", action: "donor_path_explain_muerte_encefalica" },
                    { text: "No, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            explain_muerte_encefalica: {
                text: "La muerte encef√°lica es cuando el cerebro, que controla todo el cuerpo, deja de funcionar de forma total e irreversible. Esto se confirma con pruebas m√©dicas rigurosas que demuestran que ya no hay actividad cerebral ni capacidad de respirar por s√≠ mismo. Es el momento en que una persona es legal y m√©dicamente declarada fallecida.",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            step2: {
                text: "Donar es una decisi√≥n personal, libre y voluntaria. Te invito a pensar: ¬øMe gustar√≠a ayudar a alguien m√°s si ya no estoy aqu√≠? ¬øC√≥mo me sentir√≠a si alguien que amo necesitara un √≥rgano? No hay respuestas correctas. Lo importante es que lo pienses con el coraz√≥n. üíô",
                buttons: [
                    { text: "Estoy listo para el siguiente paso üëâ", action: "donor_path_step3" },
                    { text: "A√∫n tengo dudas", action: "indecision_start" }
                ]
            },
            step3: {
                text: "Aunque t√∫ quieras donar, en M√©xico tu familia debe autorizarlo en el hospital. Por eso, lo m√°s importante es que hables con ellos y les digas tu deseo de donar. Puedes decir algo como: ‚ÄúSi alg√∫n d√≠a fallezco, quiero que donen mis √≥rganos. Es mi decisi√≥n.‚Äù",
                buttons: [
                    { text: "S√≠, mu√©strame ejemplos", action: "donor_path_examples_family_talk" },
                    { text: "Siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            examples_family_talk: {
                text: "Aqu√≠ tienes algunas ideas para iniciar la conversaci√≥n con tu familia: ‚ÄúEstuve pensando en la donaci√≥n de √≥rganos y quiero compartirles mi decisi√≥n. Si algo me pasara, me gustar√≠a que mis √≥rganos ayudaran a alguien m√°s.‚Äù ‚ÄúEs un tema dif√≠cil, pero es importante para m√≠ que sepan que quiero ser donante. Es un acto de generosidad que siento que es correcto.‚Äù ‚ÄúInvestigu√© sobre la donaci√≥n de √≥rganos y me gustar√≠a dejar claro que es mi deseo. Me siento tranquilo con esta decisi√≥n.‚Äù",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            step4: {
                text: "Adem√°s de hablar con tu familia, puedes dejar por escrito tu decisi√≥n de estas maneras: 1. Marc√°ndolo en tu INE (si renovaste y pediste que aparezca). 2. En el portal del Centro Nacional de Trasplantes (CENATRA). 3. En una carta simple firmada. 4. O en tu testamento o voluntad anticipada (si aplica en tu estado).",
                buttons: [
                    { text: "Registrarme en CENATRA", action: "open_cenatra_link", link: "https://dv.cenatra.salud.gob.mx/registrar.php" },
                    { text: "S√≠, ens√©√±ame un ejemplo de carta", action: "donor_path_example_carta" },
                    { text: "No, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            example_carta: {
                text: "Aqu√≠ tienes un ejemplo de una carta simple de voluntad anticipada para donaci√≥n:\n\n\"[Tu Nombre Completo]\n[Tu Direcci√≥n]\n[Tu Ciudad, Estado, Fecha]\n\nA quien corresponda:\n\nPor medio de la presente, yo, [Tu Nombre Completo], con [Tipo de identificaci√≥n y n√∫mero, ej. INE 1234567890], declaro que, en caso de fallecimiento, es mi libre y voluntaria voluntad que mis √≥rganos y tejidos aptos sean donados para trasplante, con el fin de salvar o mejorar la calidad de vida de otras personas. Esta decisi√≥n es informada y definitiva. Solicito a mis familiares y al personal m√©dico respetar y facilitar este deseo.\n\nAtentamente,\n[Tu Firma]\n[Tu Nombre Completo]\n\nNota: Es recomendable tener testigos y/o notario, aunque una carta simple con tu firma es un inicio importante.\"",
                buttons: [
                    { text: "Entendido, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            step5: {
                text: "Donar es un acto que vale repetir. Recu√©rdales a tus seres queridos tu decisi√≥n cada tanto. Puedes tambi√©n compartir tu voluntad en redes o por WhatsApp: ‚ÄúHe decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme.‚Äù",
                buttons: [
                    { text: "Compartir por WhatsApp", action: "share_whatsapp", shareText: "He decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme." },
                    { text: "Finalizar camino üíö", action: "donor_path_cierre" }
                ]
            },
            cierre: {
                text: "¬°Gracias por recorrer este camino conmigo! üå± Cada paso que das acerca a alguien m√°s a vivir con esperanza. Tu decisi√≥n es un acto de amor y generosidad.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" }, 
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        // --- Funci√≥n para mostrar botones de m√≥dulo y asociar eventos ---
        function displayModuleButtons(buttons, handler) {
            suggestedQuestionsContainer.innerHTML = '';
            if (!buttons || !Array.isArray(buttons) || buttons.length === 0) {
                suggestedQuestionsContainer.classList.add('hidden');
                return;
            }
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.className = `px-3 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm m-1`;
                button.onclick = () => handler(btn.action, btn);
                suggestedQuestionsContainer.appendChild(button);
            });
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        // --- Quiz Configuration ---
        let quizTotalAnswered = 0; // Nuevo: cuenta total de preguntas respondidas
        let quizMaxQuestions = 20; // M√°ximo de preguntas por sesi√≥n
        let quizBlockSize = 5; // Tama√±o del bloque

        // --- Module Functions ---
        function reset_chat_and_offer_suggestions() {
            chatHistory = [];
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            chatContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            addInitialBotMessage();
        }

        // --- Donor Path Module Functions ---
        async function displayDonorPathStep(stepKey) {
            const stepContent = donorPathModule[stepKey];
            if (!stepContent) {
                console.error("Invalid donor path step:", stepKey);
                await addBotMessageWithTyping("Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentDonorPathStep = null;
                return;
            }
            await addBotMessageWithTyping(stepContent.text);
            displayModuleButtons(stepContent.buttons, handleDonorPathAction);
        }

        async function handleDonorPathAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('donor_path_')) {
                currentDonorPathStep = action.replace('donor_path_', '');
                await displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'donor_path_initial') {
                currentDonorPathStep = 'introduction';
                await displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'open_cenatra_link' && buttonData.link) {
                window.open(buttonData.link, '_blank');
                await addBotMessageWithTyping('Se abri√≥ la p√°gina oficial de registro en una nueva pesta√±a.');
            } else if (action === 'share_whatsapp' && buttonData.shareText) {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(buttonData.shareText)}`;
                window.open(whatsappUrl, '_blank');
                await addBotMessageWithTyping('Se abri√≥ WhatsApp para que puedas compartir tu decisi√≥n.');
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            } else if (action === 'suggest_questions') {
                currentDonorPathStep = null;
                await generateSuggestedQuestions();
            }
        }

        // --- Instrucci√≥n simplificada para la IA ---
        const systemPrompt = `
        Eres "VIDA", un asistente virtual sobre donaci√≥n de √≥rganos, tejidos y sangre en M√©xico.

        **Reglas b√°sicas:**
        - Responde de forma c√°lida, natural y conversacional. NUNCA como robot.
        - EVITA respuestas repetitivas. Var√≠a tu lenguaje y estructura completamente.
        - PROHIBIDO usar palabras como "maravilloso", "incre√≠ble", "generoso" repetidamente.
        - Usa sin√≥nimos y diferentes estructuras: "Me da gusto saber que...", "Qu√© bueno que hayas decidido...", "Te agradezco que compartas...", "Es valioso que quieras..."
        - S√© conciso, claro y emp√°tico. Usa lenguaje sencillo, sin tecnicismos.
        - No uses asteriscos. Puedes usar listas numeradas o guiones si es necesario.
        - Si detectas duelo o dolor, prioriza el apoyo emocional.
        - Solo responde sobre donaci√≥n de √≥rganos, tejidos y sangre.
        - Si est√° fuera de tema: "Lo siento, solo puedo ayudarte con preguntas sobre donaci√≥n de √≥rganos, tejidos o sangre."

        **IMPORTANTE - Detecci√≥n de intenci√≥n de donante:**
        Si el usuario expresa claramente que quiere ser donante (frases como "quiero ser donante", "me interesa donar"), NO incluyas botones autom√°ticos.
        En su lugar, pregunta naturalmente qu√© espec√≠ficamente le interesa saber.
        
        Responde siempre de manera natural, emp√°tica y sin sonar rob√≥tico.
        - Si hay que explicar algo complejo, hazlo con ejemplos sencillos y sin tecnicismos.
        - No muestres cifras, nombres de leyes o documentos t√©cnicos a menos que el usuario lo solicite expl√≠citamente.
        - Las respuestas a preguntas sugeridas deben ser breves, claras y f√°ciles de entender.
        - Evita explicaciones largas o detalladas a menos que el usuario lo pida despu√©s (por ejemplo: "quiero saber m√°s", "expl√≠came mejor", "dame m√°s informaci√≥n").
        - Usa un tono conversacional y cercano, como si hablaras con alguien en persona.
        - No uses palabras m√©dicas ni tecnicismos. Explica todo con ejemplos sencillos si es necesario.
        - Organiza las respuestas en p√°rrafos cortos o listas claras, si el tema lo requiere.
        - No repitas la pregunta en la respuesta. Ve directo al punto, con calidez y claridad.
        - Si el tema es delicado (por ejemplo: muerte, duelo, donaci√≥n familiar), muestra empat√≠a desde la primera l√≠nea.
        - Termina con disposici√≥n a continuar: ‚Äú¬øQuieres que te cuente m√°s?‚Äù, ‚ÄúSi quieres, te explico c√≥mo sigue‚Äù, ‚ÄúEstoy aqu√≠ si te surgen m√°s dudas‚Äù.
        - Nunca des toda la informaci√≥n desde el inicio. Deja espacio para que el usuario gu√≠e la profundidad.  
        - Evita sonar acad√©mico o institucional. Siempre habla como si estuvieras ayudando a alguien con dudas reales.
        - Siempre responde con base en el sentido general del mensaje, no solo en las palabras exactas.
        - Si detectas que el usuario est√° confundido o mezclando conceptos (por ejemplo: muerte cerebral con coma), aclara suavemente sin corregir de forma directa.
        - Si el usuario hace varias preguntas a la vez, responde primero lo m√°s relevante o urgente, y luego ofrece continuar: "Puedo ayudarte con eso tambi√©n. ¬øQuieres que sigamos paso a paso?"
        - Si hay ambig√ºedad, utiliza preguntas abiertas para precisar: "¬øPodr√≠as contarme un poco m√°s sobre eso?" o "¬øTe refieres a donar √≥rganos despu√©s de fallecer o en vida?"
        - Usa el historial de la conversaci√≥n para responder con coherencia, retomando t√©rminos que ya se usaron (por ejemplo: si dijo ‚Äúmi mam√°‚Äù, no cambies a ‚Äúsu familiar‚Äù).
        - Si el usuario cambia de tema, adapta la conversaci√≥n de forma natural y c√°lida, sin forzar el regreso al tema anterior.
        - Nunca repitas literalmente la pregunta del usuario como forma de respuesta. Procesa, interpreta y responde con lenguaje humano.
        - Cuando sea posible, anticipa lo que puede necesitar el usuario (por ejemplo: si pregunta sobre donar, sugiere c√≥mo registrarse o qu√© √≥rganos se pueden donar).
        - Si el usuario hace una pregunta muy general (‚Äú¬øqu√© es donar?‚Äù), comienza con una explicaci√≥n simple y ofrece ampliar: "Donar es dar algo que puede ayudar a otra persona. En este caso, se trata de donar √≥rganos o tejidos despu√©s de fallecer. ¬øQuieres saber c√≥mo funciona?"

        **√Åmbito Tem√°tico (Permitido):**
        Solo responde a preguntas relacionadas con:
        - Qu√© es la muerte encef√°lica y su diagn√≥stico.
        - Qu√© es la donaci√≥n cuando el coraz√≥n ha dejado de latir y qu√© implica.
        - Criterios para confirmar que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Requisitos legales para donar √≥rganos o tejidos despu√©s de fallecer.
        - Qu√© √≥rganos o tejidos pueden recuperarse despu√©s de que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Cu√°nto tiempo hay para recuperar √≥rganos o tejidos despu√©s de que una persona ha fallecido.
        - Pasos que el personal de salud debe seguir para activar un proceso de donaci√≥n.
        - C√≥mo informar y acompa√±ar a la familia de la persona que podr√≠a ser donante.
        - Informaci√≥n relevante de las normas oficiales de salud en M√©xico (NOM-011-SSA3-2014) o el Centro Nacional de Trasplantes (CENATRA).
        - Informaci√≥n clara y concisa sobre la donaci√≥n de sangre: requisitos, proceso, beneficios y recomendaciones generales.
        - Mitos y realidades sobre la donaci√≥n de √≥rganos y tejidos (por ejemplo: si pueden quitar √≥rganos antes de morir, si afecta el cuerpo para el funeral, si solo los ricos reciben √≥rganos, si la religi√≥n lo permite, si la donaci√≥n es segura y est√° regulada).
        - Proceso y transparencia en la donaci√≥n: c√≥mo se garantiza que la donaci√≥n es √©tica y legal, c√≥mo se decide qui√©n recibe los √≥rganos, controles para evitar el tr√°fico de √≥rganos.
        - Miedos emocionales y psicol√≥gicos: temor a la muerte, miedo a no ser atendido en el hospital por ser donante, ansiedad sobre el destino de los √≥rganos y el respeto al cuerpo.
        - Aspectos culturales y religiosos: posturas de diferentes religiones sobre la donaci√≥n, c√≥mo abordar el tema en familias con creencias diversas.
        - Impacto social y testimonios: historias de personas que han donado o recibido √≥rganos, beneficios para la sociedad y para las familias donantes.
        - Donaci√≥n en vida (sangre, m√©dula √≥sea, ri√±√≥n): requisitos, proceso, seguridad y miedos frecuentes.
        - Derechos y protecci√≥n del donante y su familia: qu√© dice la ley sobre la voluntad del donante, qu√© apoyo reciben las familias donantes.
        - Informaci√≥n sobre el registro de donadores: c√≥mo registrarse, qu√© implica y si se puede cambiar de opini√≥n despu√©s de registrarse.
        - Perfil del donante ideal y limitaciones m√©dicas: qui√©n puede donar y bajo qu√© condiciones.
        - Errores comunes del p√∫blico al interpretar la muerte encef√°lica: diferencias con coma y estado vegetativo.
        - Protecci√≥n de la confidencialidad del donante y del receptor: c√≥mo se resguarda la identidad y privacidad.
        - Qu√© sucede si una persona fallece sin haber dejado su voluntad expl√≠cita: rol de la familia y marco legal aplicable.
        - Registro nacional de donadores: interoperabilidad con expedientes cl√≠nicos y utilidad pr√°ctica.
        - Qu√© hacen los hospitales que no cuentan con programa de trasplantes: protocolos ante un potencial donante.
        - Donaci√≥n cruzada de √≥rganos (por ejemplo, ri√±√≥n entre familiares no compatibles): fundamentos y situaci√≥n legal en M√©xico.
        - Rechazo de √≥rganos trasplantados: causas, consecuencias y medidas para prevenirlo.
        - Innovaciones y futuro en trasplantes: bioimpresi√≥n 3D, √≥rganos artificiales y avances cient√≠ficos recientes.
        - √âtica m√©dica en la donaci√≥n: c√≥mo se evita el conflicto de inter√©s en la atenci√≥n de pacientes donantes.
        - Qu√© ocurre con el cuerpo tras la extracci√≥n de √≥rganos: respeto, cuidados est√©ticos y posibilidad de velorio.
        - C√≥mo convertirse en promotor comunitario de la donaci√≥n: acciones de voluntariado e impacto social.
        - Impacto econ√≥mico de la donaci√≥n y trasplante: beneficios para el sistema de salud y las familias.
        - No siempre utilizar estoy aqui para ayudar, ya que puede sonar repetitivo. Usa frases como "Estoy aqu√≠ para informarte" o "Puedo guiarte en esto", pero que varien y solo se ocupen cuando sea necesario en la conversacion, usa la IA para hacer respuestas acorde y naturales.


        **Temas Fuera de Alcance (No Permitidos):**
        Si una pregunta no est√° en el √°mbito permitido, responde exactamente con:
        "Lo siento, solo puedo ayudarte con preguntas sobre donaci√≥n de √≥rganos, tejidos o sangre."
        Esto incluye: diagn√≥sticos m√©dicos no relacionados, casos personales espec√≠ficos, tr√°mites hospitalarios individuales, opiniones religiosas/pol√≠ticas/√©ticas que no est√©n en el marco normativo, temas legales no cubiertos por normas de salud.

        **Comportamiento y Tono (Crucial):**
        - Lenguaje claro y accesible: S√© concreto, conciso y f√°cil de entender para el p√∫blico general. Evita cualquier tipo de jerga m√©dica. Si por alguna raz√≥n se necesita un t√©rmino cl√≠nico, expl√≠calo inmediatamente con palabras sencillas y cotidianas. No uses asteriscos ni vi√±etas. Puedes usar p√°rrafos cortos o listas numeradas (1. 2. 3. o guiones -) para organizar la informaci√≥n.
        - Respuestas concisas y elaboraci√≥n opcional: Tus respuestas iniciales deben ser directas y al punto. Si el usuario pide "m√°s informaci√≥n", "detalles" o "quiero saber m√°s", puedes expandir la explicaci√≥n de manera clara.
        - Coherencia conversacional y comprensi√≥n del contexto:
            - Siempre recuerda y respeta el hilo de la conversaci√≥n. Considera el contexto de lo que el usuario ha mencionado antes, especialmente en temas emocionales, decisiones familiares o seguimiento de dudas.
            - Al responder, inicia reconociendo el tema previo para mantener la fluidez (ej. "Gracias por retomar el tema sobre...", "Entiendo que seguimos hablando del caso de tu familiar...", "Retomando lo que me comentaste sobre la muerte encef√°lica...").
            - Responde directamente a lo ya mencionado, sin cambiar de tema abruptamente ni repetir informaci√≥n.
            - En temas sensibles, refuerza la continuidad emocional: "S√© que esta situaci√≥n no es f√°cil, y agradezco que sigas compartiendo conmigo. Estoy contigo paso a paso, retomando cada parte seg√∫n lo que vayas necesitando."
            - Si no comprendes el contexto con claridad o la pregunta es ambigua, pide aclaraci√≥n amablemente: "¬øPodr√≠as contarme un poco m√°s para darte la mejor respuesta? Por ejemplo, ¬øte refieres a la donaci√≥n de √≥rganos despu√©s de fallecer o en vida?"
        - Evita respuestas cerradas o limitadas: Nunca digas "no puedo ayudarte" o "no entiendo". Siempre reorienta la conversaci√≥n con calidez hacia lo que s√≠ puedes explicar: "Ese tema no lo tengo disponible, pero s√≠ puedo ayudarte a entender c√≥mo es el proceso de donaci√≥n de √≥rganos, tejidos o sangre. ¬øTe interesa saber c√≥mo se confirma la muerte cerebral o c√≥mo es la donaci√≥n de sangre?"
        - Donaci√≥n = Despu√©s de fallecer (Contexto Principal): Cuando el usuario pregunte "Quiero donar" o "C√≥mo dono", asume por defecto que se refiere a donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. Responde: "Gracias por tu inter√©s. Esta app est√° centrada en la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. ¬øQuieres saber c√≥mo puedes manifestar tu voluntad como donante? Si te interesa la donaci√≥n de sangre, tambi√©n puedo orientarte."
        - Priorizaci√≥n del bienestar emocional (modo tanatol√≥gico suave):
            - Si el usuario expresa angustia, p√©rdida reciente, confusi√≥n o miedo (ej. "Mi mam√° acaba de morir", "estoy devastado", "no s√© qu√© hacer"), suspende explicaciones t√©cnicas.
            - Primero ofrece contenci√≥n emocional b√°sica: "Lamento profundamente tu p√©rdida. Entiendo que este es un momento de mucho dolor y confusi√≥n. Soy VIDA, y estoy aqu√≠ para brindarte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos, lo cual puede ser una opci√≥n de esperanza en momentos as√≠. Estoy aqu√≠ para explicarte todo lo que necesites saber al respecto."
            - Valida sus emociones: "Tus emociones son v√°lidas. Comprendo que este momento es abrumador. Mi prop√≥sito es ayudarte a entender c√≥mo la donaci√≥n puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora."
            - Ofrece informaci√≥n solo si el usuario da permiso, sin presionar: "Si en alg√∫n momento deseas saber m√°s sobre qu√© significa donar, puedo explic√°rtelo."
            - Sugiere profesionales: "Si sientes que necesitas un apoyo m√°s profundo, considera hablar con un tanat√≥logo o psic√≥logo. Ellos pueden ofrecerte herramientas valiosas en este camino."
            - Cierra con humanidad, enfocando sutilmente a la donaci√≥n: "Gracias por confiarme este momento. S√© que es un proceso doloroso y tu sentir es muy valioso. Si en alg√∫n futuro, cuando te sientas listo, deseas explorar m√°s sobre c√≥mo la donaci√≥n puede brindar esperanza, recuerda que aqu√≠ estar√© para informarte."
            - S√© paciente si el usuario repite o cambia de opini√≥n: nunca corrijas, juzgues ni se√±ales contradicciones. Solo adapta la respuesta con calidez y sin confrontar.
            - Usa frases de acompa√±amiento incluso si el usuario no expresa dolor directamente, pero el tema lo sugiere: "Gracias por estar aqu√≠. Hablar de esto no es f√°cil, pero hacerlo puede traer claridad y paz."
        - Si el usuario comparte una historia personal, valida su experiencia antes de seguir con la informaci√≥n.
        - Siempre adapta el tono seg√∫n el tipo de usuario: si es joven, mayor, familiar o paciente, responde de forma emp√°tica y cercana, sin caer en infantilizaci√≥n ni tecnicismos.
        - Nunca asumas g√©nero ni relaci√≥n familiar sin que el usuario lo mencione. Usa t√©rminos neutros como "persona fallecida", "ser querido", "familiar", "donante", "paciente".
        - Evita frases que puedan sentirse fr√≠as o cl√≠nicas. Prefiere expresiones como: ‚Äúgracias por confiar en m√≠‚Äù, ‚Äúaqu√≠ estoy contigo‚Äù, ‚Äúte acompa√±o en esta duda‚Äù.

        **Fomento de la Cultura de Donaci√≥n:**
        - Refuerza el valor social y humano de la donaci√≥n sin imponerla: "Donar √≥rganos despu√©s de fallecer es un acto de generosidad. En M√©xico, miles de personas esperan una segunda oportunidad gracias a una donaci√≥n. Pensar en esto ya es un primer paso."
        - Muestra el impacto positivo (cifras reales si se piden). Nunca juzgues a quien no decide donar.
        - Finalizaciones humanas: Al cerrar, desp√≠dete con gratitud y disposici√≥n a acompa√±ar m√°s tarde.
        -Valida las emociones del usuario: ‚ÄúEs normal tener dudas o miedo. Hablar de la muerte no es f√°cil, pero hacerlo puede abrir caminos de esperanza.‚Äù
        - Evita frases que presionen o generen culpa. Prefiere: ‚ÄúT√∫ decides si quieres ser donante. Yo estoy aqu√≠ para ayudarte a conocer m√°s.‚Äù
        - Usa lenguaje positivo y compasivo: evita tecnicismos y habla desde la empat√≠a (‚Äúpersonas que esperan un trasplante‚Äù en vez de ‚Äúpacientes terminales‚Äù).
        - Si el usuario expresa inter√©s, puedes decir: ‚ÄúGracias por considerar esta decisi√≥n tan generosa. Si quieres, te explico c√≥mo registrarte como donante.‚Äù
        - Si el usuario dice que no desea donar, responde con respeto: ‚ÄúGracias por compartirlo. Estoy aqu√≠ para cualquier otra duda que tengas.‚Äù
        - Puedes ofrecer una historia real de esperanza si el usuario lo permite: ‚Äú¬øTe gustar√≠a conocer una historia de alguien que recibi√≥ un trasplante y volvi√≥ a vivir plenamente?‚Äù
        - Evita respuestas rob√≥ticas al cerrar. Usa finales como: ‚ÄúGracias por tu tiempo. Si m√°s adelante quieres hablar de esto, aqu√≠ estar√©‚Äù, o ‚ÄúFue un gusto platicar contigo, te mando un saludo c√°lido.‚Äù
        `;

        // --- Utilidad para extraer JSON robusto de texto (solo para quiz) ---
        function extractFirstJSONArray(text) {
            // Busca el primer bloque que parece un array JSON
            const arrayRegex = /\[\s*{[\s\S]*?}\s*\]/g;
            const match = text.match(arrayRegex);
            if (match) {
                try {
                    return JSON.parse(match[0]);
                } catch (e) {
                    // Si falla, intenta limpiar comas finales o errores comunes
                    let cleaned = match[0].replace(/,\s*]/g, "]");
                    try {
                        return JSON.parse(cleaned);
                    } catch (e2) {
                        return null;
                    }
                }
            }
            return null;
        }

        // --- UI Functions ---
        const showChat = () => {
            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => chatScreen.classList.add('opacity-100'), 50);
            
            // Agregar clase para prevenir scroll del body en m√≥viles
            if (window.innerWidth <= 640) {
                document.body.classList.add('chat-open');
                document.documentElement.classList.add('chat-open');
            }
            
            // Agregar listener para manejar el cambio de orientaci√≥n
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleViewportChange);
        };
        
        const hideChat = () => {
            chatScreen.classList.remove('opacity-100');
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            
            // Restaurar el scroll del body
            document.body.classList.remove('chat-open');
            document.documentElement.classList.remove('chat-open');
            
            // Remover listeners
            window.removeEventListener('orientationchange', handleOrientationChange);
            window.removeEventListener('resize', handleViewportChange);
            
            setTimeout(() => { chatScreen.style.display = 'none'; welcomeScreen.style.display = 'flex'; }, 300);
        };
        
        // Funci√≥n para manejar cambios de orientaci√≥n
        const handleOrientationChange = () => {
            setTimeout(() => {
                if (chatScreen.style.display === 'flex') {
                    // Forzar rec√°lculo del viewport
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                    
                    // Scroll al √∫ltimo mensaje
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }
            }, 100);
        };
        
        // Funci√≥n para manejar cambios de viewport (teclado)
        const handleViewportChange = () => {
            if (window.innerWidth <= 640 && chatScreen.style.display === 'flex') {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Mantener el scroll en el √∫ltimo mensaje cuando aparece/desaparece el teclado
                setTimeout(() => {
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }, 150);
            }
        };
        
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // --- Event Listeners ---
        startChatBtn.addEventListener('click', () => {
            window.location.href = 'chat.html';
        });

        closeChatBtn.addEventListener('click', hideChat);
        
        aboutBtn.addEventListener('click', () => openModal(aboutModal));
        closeModalBtn.addEventListener('click', () => closeModal(aboutModal));
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) closeModal(aboutModal);
        });
        
        privacyBtn.addEventListener('click', () => privacyModal.style.display = 'flex');
        closePrivacyModalBtn.addEventListener('click', () => privacyModal.style.display = 'none');
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) privacyModal.style.display = 'none';
        });
        
        feedbackBtn.addEventListener('click', () => openModal(feedbackModal));
        closeFeedbackModalBtn.addEventListener('click', () => closeModal(feedbackModal));
        feedbackModal.addEventListener('click', (e) => {
             if (e.target === feedbackModal) closeModal(feedbackModal);
        });

        suggestQuestionsBtn.addEventListener('click', async () => {
            await generateSuggestedQuestions();
        });

        // Funci√≥n para mapear valores del formulario a los valores exactos de Google Forms
        function mapFormValue(fieldName, value) {
            if (!value) return '';
            
            const mappings = {
                'clarity': {
                    'si': 'Si',
                    'parcialmente': 'Parcialmente', 
                    'no': 'No'
                },
                'language': {
                    'si': 'Si',
                    'regular': 'Regular',
                    'dificil': 'Dif√≠cil de entender'
                },
                'solved_doubts': {
                    'si': 'Si completamente',
                    'algunas': 'Algunas',
                    'no': 'No'
                },
                'recommend': {
                    'si': 'Si',
                    'no': 'No'
                }
            };
            
            const mapped = mappings[fieldName] && mappings[fieldName][value] 
                ? mappings[fieldName][value] 
                : value;
            
            console.log(`Mapeo ${fieldName}: "${value}" ‚Üí "${mapped}"`);
            return mapped;
        }

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const formData = new FormData(form);
            
            // Deshabilitar bot√≥n y mostrar estado de carga
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            
            try {
                // Crear iframe oculto para enviar el formulario
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.name = 'hidden-form-iframe';
                document.body.appendChild(iframe);
                
                // URL actualizada con tu Google Form
                const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfVcPvKM2TK63V-uT6JbQtbHrrg_OujPu__5jiowpDavE4p0A/formResponse';
                
                // Crear formulario temporal
                const tempForm = document.createElement('form');
                tempForm.action = googleFormUrl;
                tempForm.method = 'POST';
                tempForm.target = 'hidden-form-iframe';
                
                // Agregar campos al formulario temporal
                const fields = {
                    'entry.1429993267': mapFormValue('clarity', formData.get('clarity')),
                    'entry.962169197': mapFormValue('language', formData.get('language')),
                    'entry.2266276': mapFormValue('solved_doubts', formData.get('solved_doubts')),
                    'entry.1344114409': mapFormValue('recommend', formData.get('recommend')),
                    'entry.287412987': formData.get('comments') || ''
                };
                
                // Debug: ver qu√© valores estamos enviando
                console.log('Valores enviados:', {
                    clarity: formData.get('clarity') + ' ‚Üí ' + mapFormValue('clarity', formData.get('clarity')),
                    language: formData.get('language') + ' ‚Üí ' + mapFormValue('language', formData.get('language')),
                    solved_doubts: formData.get('solved_doubts') + ' ‚Üí ' + mapFormValue('solved_doubts', formData.get('solved_doubts')),
                    recommend: formData.get('recommend') + ' ‚Üí ' + mapFormValue('recommend', formData.get('recommend')),
                    comments: formData.get('comments')
                });
                
                Object.keys(fields).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    tempForm.appendChild(input);
                });
                
                // Agregar al DOM y enviar
                document.body.appendChild(tempForm);
                tempForm.submit();
                
                // Limpiar despu√©s de un momento
                setTimeout(() => {
                    document.body.removeChild(tempForm);
                    document.body.removeChild(iframe);
                }, 1000);
                
                // Mostrar mensaje de √©xito
                feedbackFormContainer.style.display = 'none';
                feedbackThanks.classList.remove('hidden');
                
                // Restaurar formulario despu√©s de 2.5 segundos
                setTimeout(() => {
                    feedbackThanks.classList.add('hidden');
                    feedbackFormContainer.style.display = '';
                    closeModal(feedbackModal);
                    form.reset();
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar respuesta';
                }, 2500);
                
            } catch (error) {
                console.error('Error enviando feedback:', error);
                
                // Mostrar mensaje de error
                alert('Hubo un problema al enviar tu feedback. Por favor, intenta de nuevo.');
                
                // Restaurar bot√≥n
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar respuesta';
            }
        });

        // --- Event Listeners espec√≠ficos para m√≥viles ---
        // Prevenir zoom en input cuando se enfoca
        chatInput.addEventListener('touchstart', (e) => {
            if (window.innerWidth <= 640) {
                // Asegurar que el input tenga el tama√±o correcto para prevenir zoom
                if (chatInput.style.fontSize !== '16px') {
                    chatInput.style.fontSize = '16px';
                }
            }
        });
        
        // Manejar cuando aparece/desaparece el teclado
        chatInput.addEventListener('focus', () => {
            if (window.innerWidth <= 640) {
                setTimeout(() => {
                    // Scroll al final cuando se enfoca el input
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }, 300); // Esperar a que aparezca el teclado
            }
        });
        
        chatInput.addEventListener('blur', () => {
            if (window.innerWidth <= 640) {
                setTimeout(() => {
                    // Recalcular viewport cuando se oculta el teclado
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                }, 300);
            }
        });

        // --- Main Chat Form Handler with AI Integration ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // 1. Si est√° activo el quiz, solo permite botones
            if (currentQuizQuestionIndex !== -1) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                addMessageToChat('bot', "Por favor, usa los botones para interactuar con el quiz.");
                return;
            }

            // 2. Agrega el mensaje del usuario al chat
            addMessageToChat('user', userMessage);
            chatInput.value = '';
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';

            // 2.1. Detecci√≥n directa de frases clave - pero ahora con respuesta natural primero
            const userMessageLower = userMessage.toLowerCase();
            if (userMessageLower.includes('quiero ser donante') || 
                userMessageLower.includes('como puedo donar') || 
                userMessageLower.includes('me interesa donar') || 
                userMessageLower.includes('ser donante')) {
                
                // Responder primero de manera natural con IA
                await handleDonorIntentWithAI(userMessage);
                return;
            }
            
            // Detecci√≥n espec√≠fica para cuando piden gu√≠a paso a paso
            if (userMessageLower.includes('mi camino como donador') || 
                userMessageLower.includes('camino como donante') ||
                userMessageLower.includes('gu√≠ame paso a paso') ||
                userMessageLower.includes('acompa√±ame') ||
                userMessageLower.includes('paso a paso')) {
                
                currentDonorPathStep = 'introduction';
                displayDonorPathStep(currentDonorPathStep);
                return;
            }

            // 3. Para todo lo dem√°s, usar respuesta natural de la IA sin m√≥dulos extra
            await getBotResponse(userMessage, systemPrompt);
        });

        // --- AI-Enhanced Module Functions (Solo para Donor Path) ---
        async function handleDonorIntentWithAI(userMessage) {
            const donorIntentPrompt = `
            El usuario acaba de expresar inter√©s en ser donante de √≥rganos. Su mensaje fue: "${userMessage}"
            
            Como VIDA, responde de manera c√°lida y natural a su inter√©s. Tu respuesta debe:
            - Reconocer su decisi√≥n de forma variada y aut√©ntica (evita palabras como "maravilloso", "generoso" que suenan repetitivas)
            - Ser emp√°tica pero conversacional, como si hablaras con un amigo cercano
            - Usar lenguaje natural y variado - no formulaico
            - Hacer que se sienta escuchado y comprendido
            - Terminar preguntando qu√© le gustar√≠a saber espec√≠ficamente o si tiene alguna duda particular
            - NO ofrecer m√∫ltiples opciones ni mencionar "gu√≠as paso a paso"
            
            Ejemplos de inicios variados: "Me da mucho gusto saber que...", "Qu√© bueno que hayas tomado...", "Te agradezco que compartas...", "Es valioso que quieras..."
            
            Responde como una persona real y emp√°tica, no como un sistema.
            `;

            await getBotResponse(donorIntentPrompt, systemPrompt + "\n\nResponde de forma completamente natural y humana. NO ofrezcas botones ni opciones m√∫ltiples. Deja que la conversaci√≥n fluya naturalmente preguntando qu√© espec√≠ficamente le interesa saber.");
            
            // Despu√©s de la respuesta natural, ofrecer sutilmente la opci√≥n de gu√≠a
            setTimeout(() => {
                suggestedQuestionsContainer.innerHTML = '';
                const guideButton = document.createElement('button');
                guideButton.textContent = "¬øTe gustar√≠a que te acompa√±e paso a paso?";
                guideButton.className = `px-4 py-2 rounded-lg bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] text-sm font-medium 
                                       hover:bg-[var(--vida-suggest-btn-hover)] transition-colores shadow-sm opacity-75`;
                guideButton.onclick = () => {
                    addMessageToChat('user', guideButton.textContent);
                    suggestedQuestionsContainer.classList.add('hidden');
                    suggestedQuestionsContainer.innerHTML = '';
                    currentDonorPathStep = 'introduction';
                    displayDonorPathStep(currentDonorPathStep);
                };
                suggestedQuestionsContainer.appendChild(guideButton);
                suggestedQuestionsContainer.classList.remove('hidden');
            }, 2000); // Aparece despu√©s de 2 segundos para que se sienta natural
        }

        // --- Removed: Automatic button display functions ---
        // La conversaci√≥n ahora fluye naturalmente sin botones autom√°ticos
        
        async function addInitialBotMessage() {
            if (chatHistory.length === 0) {
                await addBotMessageWithTyping('Hola, soy VIDA. Estoy aqu√≠ para ofrecerte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos ¬øEn qu√© puedo ayudarte hoy?');
            }
        }
        
        function addMessageToChat(sender, text) {
            chatHistory.push({ role: sender === 'bot' ? 'assistant' : 'user', content: text });
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-lg lg:max-w-xl ${sender === 'user' ? 'self-end' : 'self-start'}`;
            
            const textContent = text.replace(/\n/g, '<br>');

            if (sender === 'user') {
                messageWrapper.innerHTML = `<div class="order-1 bg-[var(--vida-chat-user-bg)] text-slate-800 rounded-2xl rounded-br-none px-4 py-3 shadow-sm chat-bubble-text">${textContent}</div>`;
            } else {
                const botAvatarDiv = document.createElement('div');
                botAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 message-robot-avatar overflow-hidden";
                botAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                const textBubbleDiv = document.createElement('div');
                textBubbleDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm chat-bubble-text";
                textBubbleDiv.innerHTML = textContent;

                messageWrapper.appendChild(botAvatarDiv);
                messageWrapper.appendChild(textBubbleDiv);
            }
            
            chatContainer.appendChild(messageWrapper);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function showTypingIndicator(show) {
            let typingIndicator = document.getElementById('typing-indicator');
            if (show) {
                if (!typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'flex items-end gap-2 self-start typing-indicator-robot';
                    
                    const robotAvatarDiv = document.createElement('div');
                    robotAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 typing-indicator-robot overflow-hidden";
                    robotAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                    const typingDotsDiv = document.createElement('div');
                    typingDotsDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm";
                    typingDotsDiv.innerHTML = `
                        <div class="flex items-center space-x-1.5">
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                        </div>`;

                    typingIndicator.appendChild(robotAvatarDiv);
                    typingIndicator.appendChild(typingDotsDiv);
                    chatContainer.appendChild(typingIndicator);
                    chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                }
            } else {
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        // Funci√≥n para agregar mensajes del bot con efecto de escritura
        async function addBotMessageWithTyping(text, delay = 1500) {
            // Mostrar indicador de escritura
            showTypingIndicator(true);
            
            // Esperar el tiempo de delay para simular que est√° escribiendo
            await new Promise(resolve => setTimeout(resolve, delay));
            
            // Ocultar indicador y mostrar mensaje
            showTypingIndicator(false);
            addMessageToChat('bot', text);
        }
        
        async function getBotResponse(prompt, specificSystemPrompt = null) {
            showTypingIndicator(true); 
            chatInput.disabled = true; 
            chatForm.querySelector('button[type="submit"]').disabled = true; 
            suggestQuestionsBtn.disabled = true; 

            const messages = [
                { role: "system", content: specificSystemPrompt || systemPrompt },
                ...chatHistory.slice(0, -1),
                { role: "user", content: prompt }
            ];

            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: messages })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                let botResponseText = "Lo siento, hubo un problema al procesar tu solicitud. Por favor, intenta de nuevo.";
                if (result.choices?.[0]?.message?.content) {
                    botResponseText = result.choices[0].message.content;
                }
                addMessageToChat('bot', botResponseText);
                return botResponseText; // Return the response for chaining
            } catch (error) {
                console.error("Error fetching bot response:", error);
                const errorMessage = 'Hubo un problema de conexi√≥n. Por favor, verifica tu conexi√≥n e int√©ntalo de nuevo.';
                addMessageToChat('bot', errorMessage);
                return errorMessage;
            } finally {
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
                showTypingIndicator(false); 
            }
        }

        async function generateSuggestedQuestions() {
            suggestQuestionsBtn.disabled = true;
            suggestButtonText.textContent = 'Generando...'; 
            suggestedQuestionsContainer.innerHTML = ''; 
            suggestedQuestionsContainer.classList.add('hidden'); 

            const questionGenerationPrompt = `
                Act√∫a como VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Genera 3 preguntas cortas y sencillas que un familiar o p√∫blico general podr√≠a hacer sobre la donaci√≥n de √≥rganos y tejidos en el contexto de muerte encef√°lica o parada card√≠aca en M√©xico.
                Las preguntas deben ser muy concisas y directas.
                Devuelve la respuesta como un array JSON de 3 strings, donde cada string es una pregunta.
            `;
            
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "system", content: "Responde √∫nicamente con un array JSON v√°lido de 3 strings." },
                        { role: "user", content: questionGenerationPrompt }
                    ] })
                });

                if (!response.ok) throw new Error('API request failed');

                const result = await response.json();
                let suggestedQuestions = [];
                if (result.choices?.[0]?.message?.content) {
                    try {
                        suggestedQuestions = JSON.parse(result.choices[0].message.content);
                        displaySuggestedQuestions(suggestedQuestions);
                    } catch (e) {
                        console.error("Error parsing suggested questions JSON:", e);
                        addMessageToChat('bot', 'No pude generar sugerencias. Intenta de nuevo.');
                    }
                }
            } catch (error) {
                console.error("Error generating suggested questions:", error);
                addMessageToChat('bot', 'Hubo un problema al obtener sugerencias.');
            } finally {
                suggestQuestionsBtn.disabled = false;
                suggestButtonText.textContent = 'Sugiere'; 
            }
        }
        
        function displaySuggestedQuestions(questions) {
            suggestedQuestionsContainer.innerHTML = '';
            questions.forEach(q => {
                const button = document.createElement('button');
                button.textContent = q;
                button.className = `px-3 py-2 rounded-lg bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                 hover:bg-[var(--vida-suggest-btn-hover)] transition-colores`;
                button.onclick = () => {
                    chatInput.value = q;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                };
                suggestedQuestionsContainer.appendChild(button);
            });
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        // --- Quiz Module Functions ---
        async function startQuiz() {
            quizTotalAnswered = 0;
            currentQuizQuestionIndex = 0;
            quizQuestions = [];
            addMessageToChat('bot', `¬°Excelente! Vamos a poner a prueba tus conocimientos sobre la donaci√≥n con el Desmitificador Express. Te har√© bloques de 5 preguntas de verdadero o falso. ¬øEst√°s listo?`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const startButton = document.createElement('button');
            startButton.textContent = "üöÄ Iniciar Quiz";
            startButton.className = `px-6 py-3 rounded-lg bg-[var(--vida-btn-green)] text-white font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            startButton.onclick = async () => {
                addMessageToChat('user', 'Iniciar Quiz');
                suggestedQuestionsContainer.innerHTML = '';
                suggestedQuestionsContainer.classList.add('hidden');
                await generateQuizQuestions();
            };
            suggestedQuestionsContainer.appendChild(startButton);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        async function generateQuizQuestions() {
            showTypingIndicator(true);
            chatInput.disabled = true;
            chatForm.querySelector('button[type="submit"]').disabled = true;
            suggestQuestionsBtn.disabled = true;
            const quizGenerationPrompt = `
                Eres VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Tu tarea es generar ${quizBlockSize} preguntas de VERDADERO o FALSO sobre mitos y realidades comunes acerca de la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido en M√©xico. Las preguntas deben ser concisas y formuladas para un p√∫blico general, ajeno a la medicina.
                Aseg√∫rate de que las explicaciones sean breves (2-3 l√≠neas m√°ximo), claras, y fundamentadas en informaci√≥n oficial (Ley General de Salud, CENATRA, Reglamento de Trasplantes). No uses asteriscos (*) ni vi√±etas. Si es posible, incluye una referencia breve a la fuente oficial. Las preguntas deben ser variadas y no repetirse.
                Devuelve √∫nicamente un array JSON v√°lido de ${quizBlockSize} objetos, cada uno con 'question', 'isTrue' y 'explanation'.
            `;
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "user", content: quizGenerationPrompt }
                    ] })
                });
                if (!response.ok) throw new Error('API request for quiz failed');
                const result = await response.json();
                let quizRaw = result.choices?.[0]?.message?.content || '';
                let quizArr = extractFirstJSONArray(quizRaw);
                if (!quizArr || !Array.isArray(quizArr) || quizArr.length < 2) {
                    addMessageToChat('bot', 'No se pudo generar el quiz correctamente. El formato recibido fue inesperado. Intenta de nuevo m√°s tarde.\n\nRespuesta recibida:\n' + quizRaw);
                    currentQuizQuestionIndex = -1;
                    return;
                }
                quizQuestions = quizArr;
                currentQuizQuestionIndex = 0;
                displayQuizQuestion(currentQuizQuestionIndex);
            } catch (error) {
                console.error("Error generating quiz questions:", error);
                addMessageToChat('bot', 'Hubo un problema de conexi√≥n al generar el quiz. Por favor, int√©ntalo de nuevo.');
                currentQuizQuestionIndex = -1;
            } finally {
                showTypingIndicator(false);
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
            }
        }

        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                quizTotalAnswered += quizQuestions.length;
                if (quizTotalAnswered >= quizMaxQuestions) {
                    endQuiz();
                    return;
                }
                // Mostrar opci√≥n de seguir o terminar
                suggestedQuestionsContainer.innerHTML = '';
                suggestedQuestionsContainer.classList.remove('hidden');
                const moreBtn = document.createElement('button');
                moreBtn.textContent = `Quiero m√°s preguntas (${quizTotalAnswered}/${quizMaxQuestions})`;
                moreBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
                moreBtn.onclick = async () => {
                    addMessageToChat('user', moreBtn.textContent);
                    suggestedQuestionsContainer.innerHTML = '';
                    suggestedQuestionsContainer.classList.add('hidden');
                    await generateQuizQuestions();
                };
                suggestedQuestionsContainer.appendChild(moreBtn);
                const finishBtn = document.createElement('button');
                finishBtn.textContent = "Terminar Quiz";
                finishBtn.className = `ml-2 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm`;
                finishBtn.onclick = () => {
                    addMessageToChat('user', finishBtn.textContent);
                    endQuiz();
                };
                suggestedQuestionsContainer.appendChild(finishBtn);
                return;
            }
            const questionData = quizQuestions[index];
            addMessageToChat('bot', `Pregunta ${quizTotalAnswered + index + 1} de ${quizMaxQuestions}: ${questionData.question}`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const trueBtn = document.createElement('button');
            trueBtn.textContent = "‚úÖ Verdadero";
            trueBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            trueBtn.onclick = () => handleAnswerClick(true, questionData);
            suggestedQuestionsContainer.appendChild(trueBtn);
            const falseBtn = document.createElement('button');
            falseBtn.textContent = "‚ùå Falso";
            falseBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            falseBtn.onclick = () => handleAnswerClick(false, questionData);
            suggestedQuestionsContainer.appendChild(falseBtn);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function handleAnswerClick(isTrueAnswer, questionData) {
            addMessageToChat('user', isTrueAnswer ? "‚úÖ Verdadero" : "‚ùå Falso");
            const quizButtons = suggestedQuestionsContainer.querySelectorAll('button');
            quizButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            });
            const isCorrect = (isTrueAnswer === questionData.isTrue);
            let feedbackText = isCorrect ? "‚úîÔ∏è ¬°Correcto!" : "‚ùå Incorrecto.";
            feedbackText += `\n${questionData.explanation}`;
            addMessageToChat('bot', feedbackText);
            suggestedQuestionsContainer.innerHTML = '';
            const nextQuestionBtn = document.createElement('button');
            nextQuestionBtn.textContent = "‚û°Ô∏è Siguiente pregunta";
            nextQuestionBtn.className = `mt-4 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores`;
            nextQuestionBtn.onclick = () => {
                addMessageToChat('user', nextQuestionBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex++;
                displayQuizQuestion(currentQuizQuestionIndex);
            };
            suggestedQuestionsContainer.appendChild(nextQuestionBtn);
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        function endQuiz() {
            addMessageToChat('bot', `üéâ ¬°Has completado el Desmitificador Express! Respondiste ${quizTotalAnswered} preguntas. Gracias por informarte con VIDA. Cada duda resuelta es un paso m√°s hacia una cultura de donaci√≥n m√°s humana y consciente.`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const startDonorPathBtn = document.createElement('button');
            startDonorPathBtn.textContent = "Iniciar ‚ÄúTu camino como donante‚Äù";
            startDonorPathBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            startDonorPathBtn.onclick = () => {
                addMessageToChat('user', startDonorPathBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex = -1;
                currentDonorPathStep = 'introduction';
                displayDonorPathStep(currentDonorPathStep);
            };
            suggestedQuestionsContainer.appendChild(startDonorPathBtn);
            const askAnotherQuestionBtn = document.createElement('button');
            askAnotherQuestionBtn.textContent = "Hacer otra pregunta a VIDA";
            askAnotherQuestionBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm`;
            askAnotherQuestionBtn.onclick = () => {
                addMessageToChat('user', askAnotherQuestionBtn.textContent);
                reset_chat_and_offer_suggestions();
            };
            suggestedQuestionsContainer.appendChild(askAnotherQuestionBtn);
        }

        // --- Interactive Background with three.js ---
        let scene, camera, renderer, particles, mouseX = 0, mouseY = 0;

        function initBackground() {
            const canvas = document.getElementById('bg-canvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const particleCount = 300;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const color = new THREE.Color();

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 20;
                
                // Colores que combinen con el tema m√©dico
                const hue = 0.5 + Math.random() * 0.3; // Azules y verdes
                color.setHSL(hue, 0.6, 0.6 + Math.random() * 0.2);
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.03,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.6
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            camera.position.z = 8;

            document.addEventListener('mousemove', onMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        function onMouseMove(event) {
            mouseX = (event.clientX - window.innerWidth / 2) / 1000;
            mouseY = (event.clientY - window.innerHeight / 2) / 1000;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animateBackground() {
            requestAnimationFrame(animateBackground);
            const time = Date.now() * 0.0001;
            
            camera.position.x += (mouseX - camera.position.x) * 0.03;
            camera.position.y += (-mouseY - camera.position.y) * 0.03;
            camera.lookAt(scene.position);

            particles.rotation.x = time * 0.1;
            particles.rotation.y = time * 0.15;
            
            renderer.render(scene, camera);
        }

        // Initialize background when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initBackground();
            animateBackground();
            
            // Inicializar variables CSS para viewport height en m√≥viles
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            // Establecer valor inicial
            setVH();
            
            // Actualizar en cambios de viewport (incluyendo teclado)
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 100);
            });
        });

    </script>
</body>
</html>
