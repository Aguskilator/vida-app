<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDA - Asistente de Donaci√≥n</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Roboto as requested -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles and Animations -->
    <style>
        /* New Color Palette and Font from the design specification */
        :root {
            --vida-bg: #E3F2FD; /* Azul cielo claro */
            --vida-text-dark: #0D47A1; /* Azul oscuro m√©dico */
            --vida-btn-green: #66BB6A; /* Verde esperanza suave */
            --vida-btn-green-hover: #43A047;
            --vida-text-secondary: #757575; /* Gris medio */
            --vida-bg-footer: #F5F5F5; /* Gris claro */
            --vida-chat-bot-bg: #F9F9F9; /* Gris claro para burbuja del bot */
            --vida-chat-user-bg: #E8F5E9; /* Verde muy claro para burbuja de usuario */
            --vida-btn-feedback: #4FC3F7; /* Azul cielo para feedback */
            --vida-suggest-btn-bg: #E0F2F7; /* Azul muy claro para bot√≥n de sugerencia */
            --vida-suggest-btn-hover: #B3E5FC; /* Azul m√°s claro para hover */
            --vida-module-btn-bg: #E0F2F7; /* Color para botones de m√≥dulo */
            --vida-module-btn-hover: #B3E5FC; /* Color hover para botones de m√≥dulo */
            --vida-module-btn-text: #0D47A1; /* Color de texto para botones de m√≥dulo */
            --vida-quiz-btn-correct: #4CAF50; /* Verde para respuesta correcta */
            --vida-quiz-btn-incorrect: #F44336; /* Rojo para respuesta incorrecta */
            --vida-quiz-btn-disabled: #BDBDBD; /* Gris para botones deshabilitados */
        }

        body {
            font-family: 'Roboto', sans-serif;
            /* Nuevo fondo degradado para la p√°gina principal */
            background: linear-gradient(135deg, #E3F2FD 0%, #B3E5FC 50%, #66BB6A 100%);
        }
        /* Estilo especial para el t√≠tulo principal */
        .vida-main-title {
            background: linear-gradient(90deg, #0D47A1 20%, #4FC3F7 60%, #66BB6A 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            font-weight: 900;
            letter-spacing: 0.02em;
            text-shadow: 0 2px 8px rgba(13,71,161,0.08);
        }
        /* Subt√≠tulo con color y formato mejorado */
        .vida-main-subtitle {
            color: #1976D2;
            font-size: 1.35rem;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        /* Fade-in animation for a smooth load */
        .fade-in-element {
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Justify chat text */
        .chat-bubble-text {
            text-align: justify;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #FFFFFF; }
        .chat-messages::-webkit-scrollbar-thumb { background: #BDBDBD; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--vida-text-secondary); }

        /* Initially hide these screens/modals */
        #chat-screen, #about-modal, #feedback-modal, #privacy-modal { display: none; }
        
        /* Styles for radio buttons in feedback form */
        .feedback-radio-group label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        /* Styles for quiz question card */
        .quiz-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .quiz-buttons button {
            transition: all 0.2s;
        }

        /* Styling for the custom SVG robot */
        /* Base styles for the SVG robot to ensure consistent appearance */
        .robot-svg-icon { /* Class for the SVG element itself */
            width: 100%;
            height: 100%;
        }
        .robot-svg-icon .heart-icon {
            fill: #EF5350; /* Red heart */
        }
        .robot-svg-icon .head-shape, .robot-svg-icon .torso {
            fill: #FFFFFF; /* White parts */
            stroke: #D1D5DB; /* Light gray border */
            stroke-width: 2;
        }
        .robot-svg-icon .neck {
            fill: #90A4AE; /* Gray neck */
        }
        .robot-svg-icon .arm-left, .robot-svg-icon .arm-right {
            stroke: #42A5F5; /* Blue arms */
            stroke-width: 15;
            fill: none;
            stroke-linecap: round;
        }
        .robot-svg-icon .screen {
            fill: #1F2937; /* Dark screen */
            rx: 10;
        }
        .robot-svg-icon .eye {
            fill: #40C4FF; /* Light blue eyes */
        }
        .robot-svg-icon .smile {
            stroke: #40C4FF; /* Light blue smile */
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }

        /* Animations for the robot SVG */
        @keyframes float-animation {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes typing-animation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(-2px); }
            100% { transform: translateY(0px); }
        }
        
        /* Apply animations to specific elements by ID or Class for different contexts */
        #main-robot-container svg { /* Target the SVG inside the main container */
            animation: float-animation 3s ease-in-out infinite;
        }
        /* Specific targeting for heart and head within message/typing indicator SVGs */
        .message-robot-avatar .heart-icon {
            animation: heart-beat 1.5s infinite;
        }
        .typing-indicator-robot .head {
            animation: typing-animation 0.7s infinite;
        }

        /* Fondo exclusivo para la pantalla de conversaci√≥n del chatbot */
        #chat-screen {
            background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 50%, #e3f2fd 100%);
        }

        /* --- Robot Circle Styles --- */
        .robot-circle-bg {
            width: 380px;
            height: 380px;
            min-width: 260px;
            min-height: 260px;
            max-width: 420px;
            max-height: 420px;
            border-radius: 50%;
            background: radial-gradient(circle at 60% 40%, #ffffff 60%, #b3e5fc 100%, #66bb6a 120%);
            box-shadow: 0 8px 32px 0 rgba(13,71,161,0.10), 0 2px 8px 0 rgba(76,175,80,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            border: 6px solid #e3f2fd;
            position: relative;
            z-index: 1;
        }
        @media (max-width: 640px) {
            .robot-circle-bg {
                width: 220px;
                height: 220px;
                min-width: 180px;
                min-height: 180px;
                max-width: 260px;
                max-height: 260px;
            }
        }
        .robot-img-main {
            width: 115%;
            height: 115%;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
        }
    </style>
</head>
<body class="text-slate-800 antialiased">

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="w-full p-4 sm:p-5 bg-transparent fade-in-element" style="animation-delay: 0.2s;">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-1">
                    <div class="w-10 h-10 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center shadow">
                        <!-- Heart Icon for VIDA logo -->
                        <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-13 w-auto object-contain" style="max-width:100px;" onerror="this.onerror=null;this.src='https://placehold.co/100x40/E3F2FD/0D47A1?text=VIDA';" />
                </div>
                <div class="flex items-center space-x-1">
                    <!-- Privacy button -->
                    <button id="privacy-btn" class="text-[var(--vida-text-dark)] font-semibold py-2 px-4 rounded-lg transition hover:bg-blue-200/50">Aviso de Privacidad</button>
                    <!-- About button -->
                    <button id="about-btn" class="px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white font-semibold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] focus:ring-offset-2">
                        ¬øQu√© hace VIDA?
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col lg:flex-row items-center justify-center container mx-auto p-6 text-center lg:text-left gap-8">
            <div class="lg:w-full flex flex-col items-center lg:items-start">
                <h2 class="vida-main-title text-3xl md:text-4xl lg:text-5xl font-bold text-[var(--vida-text-dark)] max-w-xl fade-in-element" style="animation-delay: 0.4s;">
                    Voz de Informaci√≥n y Donaci√≥n Asistida
                </h2>
                <p class="vida-main-subtitle text-lg md:text-xl text-slate-600 mt-4 max-w-xl fade-in-element" style="animation-delay: 0.6s; text-align: justify;">
                    Tu aliado informativo en momentos cr√≠ticos.<br>
                    <span class="block mt-1">Estoy aqu√≠ para ayudarte a tomar decisiones claras, humanas y fundamentadas.</span>
                </p>
                <div class="mt-12 flex flex-col sm:flex-row gap-4 fade-in-element" style="animation-delay: 0.8s;">
                    <button id="start-chat-btn" class="bg-[var(--vida-btn-green)] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                        Iniciar conversaci√≥n
                    </button>
                    <!-- New Quiz Module Button -->
                    <button id="start-quiz-btn" class="bg-[var(--vida-btn-feedback)] text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-400 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center gap-2">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        ¬øQu√© tanto sabes sobre donar?
                    </button>
                </div>
            </div>
            <!-- Robot Image for the main page, now inside a styled circle -->
            <div id="main-robot-container" class="lg:w-1/2 flex items-center justify-center lg:justify-start mt-12 lg:mt-0 lg:ml-[-320px] fade-in-element" style="animation-delay: 1s;">
                <div class="robot-circle-bg">
                    <img src="robot.png" alt="Robot VIDA" class="robot-img-main" onerror="this.onerror=null;this.src='https://placehold.co/437x437/FFFFFF/FFFFFF?text=Robot';" />
                </div>
            </div>
        </main>

        <footer class="w-full p-4 bg-[var(--vida-bg-footer)] fade-in-element" style="animation-delay: 1.2s;">
            <div class="container mx-auto">
                <div class="flex flex-col items-center justify-center">
                    <p class="text-base md:text-xs text-slate-700 font-medium mb-1" style="text-align: center;">
                        VIDA es una herramienta informativa. No sustituye la atenci√≥n m√©dica directa.<br>
                        Versi√≥n piloto para orientaci√≥n en procesos de donaci√≥n.
                    </p>
                    <a href="https://www.gob.mx/cenatra" target="_blank" class="text-xs text-[var(--vida-btn-feedback)] underline font-semibold hover:text-[var(--vida-text-dark)] transition-colors block mt-1 text-center">
                        Ir a CENATRA
                    </a>
                </div>
            </div>
        </footer>
    </div>
    
    <button id="feedback-btn" class="fixed bottom-5 left-5 bg-[var(--vida-btn-feedback)] text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:scale-105 transition-transform z-20 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.08-3.239A8.939 8.939 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.416 11.603a.75.75 0 00-.029.048l.029-.048zM5.022 13.013a.75.75 0 00.213.024l.028-.024z" clip-rule="evenodd" /></svg>
        Danos tu opini√≥n
    </button>
    
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 relative">
            <button id="close-about-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold text-[var(--vida-text-dark)] mb-4">¬øQu√© hace VIDA?</h3>
            <div class="text-slate-700 text-justify space-y-3" style="text-align: justify;">
                <p>VIDA es un asistente conversacional creado para brindar orientaci√≥n emp√°tica, clara y confiable sobre la donaci√≥n de √≥rganos, tejidos y sangre en M√©xico.</p>
                <p>Fue desarrollado como una herramienta informativa para acompa√±ar a personas que tienen dudas, miedo o simplemente desean entender mejor c√≥mo funciona la donaci√≥n, ya sea como donadores voluntarios o como familiares que enfrentan una decisi√≥n en un momento dif√≠cil.</p>
                <p>VIDA no sustituye atenci√≥n m√©dica ni asesor√≠a profesional directa, pero est√° dise√±ada para ayudarte a:</p>
                <ul class="list-disc pl-6 space-y-1">
                    <li>Entender qu√© √≥rganos, tejidos y componentes sangu√≠neos se pueden donar.</li>
                    <li>Saber qui√©n puede ser donador y en qu√© momentos.</li>
                    <li>Desmitificar ideas falsas sobre la donaci√≥n.</li>
                    <li>Reflexionar con libertad sobre el acto de donar.</li>
                    <li>Obtener enlaces seguros y oficiales para registrarte como donador voluntario o encontrar centros de donaci√≥n.</li>
                </ul>
                <p>VIDA es una voz que informa sin juzgar, acompa√±a sin presionar, y cree que donar es un acto de amor y conciencia.</p>
            </div>
        </div>
    </div>
    
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 relative">
            <button id="close-privacy-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-2xl font-bold text-[var(--vida-text-dark)] mb-4">Aviso de Privacidad ‚Äì VIDA</h3>
            <div class="text-slate-700 text-justify" style="text-align: justify;">
                <p class="mb-3">VIDA (Voz de Informaci√≥n y Donaci√≥n Asistida) es una herramienta informativa que opera sin recopilar datos personales sensibles. No se almacenan nombres, ubicaciones, correos electr√≥nicos ni respuestas espec√≠ficas de los usuarios. Las conversaciones no son monitoreadas ni utilizadas para fines comerciales o de perfilamiento.</p>
                <p class="mb-3">El uso de esta plataforma es completamente an√≥nimo y su √∫nico prop√≥sito es ofrecer orientaci√≥n general sobre procesos de donaci√≥n post mortem, con base en informaci√≥n p√∫blica y normativa mexicana vigente.</p>
                <p class="mb-3">VIDA no sustituye asesor√≠a m√©dica, psicol√≥gica ni legal. Si requiere atenci√≥n m√©dica o desea formalizar su voluntad de donar, debe acudir a las instancias oficiales correspondientes (CENATRA, IMSS, ISSSTE, etc.).</p>
                <p>Para cualquier comentario, puede escribir al desarrollador del proyecto a trav√©s del formulario de contacto disponible.</p>
            </div>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-8 relative overflow-hidden">
            <div id="feedback-form-container">
                 <button id="close-feedback-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
                <h3 class="text-2xl font-bold text-[var(--vida-text-dark)] mb-2">Encuesta an√≥nima de satisfacci√≥n ‚Äì VIDA</h3>
                <p class="text-sm text-gray-500 mb-6">Responde en menos de 1 minuto:</p>
                <form id="feedback-form">
                    <div class="space-y-6">
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">1. ¬øLa informaci√≥n que recibiste fue clara y √∫til?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="clarity" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="clarity" value="parcialmente" class="mr-2"> Parcialmente</label>
                                <label><input type="radio" name="clarity" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">2. ¬øEl lenguaje utilizado te pareci√≥ comprensible?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="language" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="language" value="regular" class="mr-2"> Regular</label>
                                <label><input type="radio" name="language" value="dificil" class="mr-2"> Dif√≠cil de entender</label>
                            </div>
                        </div>
                         <div>
                            <p class="font-semibold text-gray-700 mb-2">3. ¬øTe ayud√≥ a resolver tus dudas sobre donaci√≥n?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="solved_doubts" value="si" class="mr-2" required> S√≠ completamente</label>
                                <label><input type="radio" name="solved_doubts" value="algunas" class="mr-2"> Algunas</label>
                                <label><input type="radio" name="solved_doubts" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-2">4. ¬øRecomendar√≠as esta herramienta a otros usuarios?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group">
                                <label><input type="radio" name="recommend" value="si" class="mr-2" required> S√≠</label>
                                <label><input type="radio" name="recommend" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <label for="comments" class="font-semibold text-gray-700 mb-2 block">Comentarios adicionales</label>
                            <textarea id="comments" name="comments" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-feedback)]"></textarea>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button type="submit" class="bg-[var(--vida-btn-green)] text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors">Enviar respuesta</button>
                    </div>
                </form>
            </div>
             <div id="feedback-thanks" class="hidden text-center">
                 <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mt-4 text-2xl font-bold text-[var(--vida-text-dark)]">¬°Gracias!</h3>
                <p class="mt-2 text-gray-600">Tu opini√≥n nos importa y nos ayuda a mejorar VIDA.</p>
            </div>
        </div>
    </div>


    <div id="chat-screen" class="fixed inset-0 bg-slate-100 flex items-center justify-center p-0 sm:p-4 z-40 transition-opacity duration-300 opacity-0">
        <div class="w-full h-full sm:max-w-4xl sm:h-[90vh] bg-white sm:rounded-2xl shadow-2xl flex flex-col">
            <header class="bg-white border-b border-gray-200 p-4 sm:rounded-t-2xl flex items-center justify-between shadow-sm">
                 <div class="flex items-center space-x-1">
                    <div class="w-12 h-12 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center mr-1">
                        <!-- Heart Icon for VIDA logo in chat header -->
                        <svg class="h-7 w-7 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-13 w-auto object-contain" style="max-width:90px;" onerror="this.onerror=null;this.src='https://placehold.co/90x40/E3F2FD/0D47A1?text=VIDA';" />
                 </div>
                <button id="close-chat-btn" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <main class="flex-1 flex overflow-hidden">
                <div id="chat-container-wrapper" class="flex-1 flex flex-col p-4 sm:p-6 overflow-y-auto chat-messages">
                     <div id="chat-container" class="flex flex-col space-y-4"></div>
                </div>
                <aside class="w-1/3 bg-slate-50 p-6 border-l border-slate-200 hidden md:flex flex-col items-center justify-center">
                    <!-- chat-robot-avatar element: using the provided image for the large avatar -->
                    <div id="chat-robot-avatar-large" class="w-48 h-48 mb-4 rounded-full flex items-center justify-center shadow-lg overflow-hidden">
                        <img src="robot.png" alt="Robot VIDA" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/192x192/FFFFFF/FFFFFF?text=Robot';" />
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-lg text-[var(--vida-text-dark)]">Estoy para ayudarte</h3>
                        <p class="text-sm text-[var(--vida-text-secondary)] mt-1">Preg√∫ntame sobre el proceso de donaci√≥n de √≥rganos y tejidos.</p>
                    </div>
                </aside>
            </main>
            <footer class="p-4 bg-white border-t border-gray-200 sm:rounded-b-2xl">
                <div id="suggested-questions-container" class="flex flex-wrap gap-2 mb-4 hidden"></div>

                <form id="chat-form" class="flex items-center space-x-3">
                    <button type="button" id="suggest-questions-btn" class="bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] rounded-full p-2.5 
                                     hover:bg-[var(--vida-suggest-btn-hover)] transition-colors focus:outline-none focus:ring-4 focus:ring-blue-100 
                                     disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center">
                        <svg class="h-5 w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        <span id="suggest-button-text" class="ml-1 text-sm font-semibold">Sugiere</span> </button>
                    <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..." autocomplete="off" class="flex-1 w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] transition">
                    <button type="submit" class="bg-[var(--vida-btn-green)] text-white rounded-full p-3 hover:bg-[var(--vida-btn-green-hover)] transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatBtn = document.getElementById('start-chat-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn'); 

        const chatContainer = document.getElementById('chat-container');
        const chatContainerWrapper = document.getElementById('chat-container-wrapper');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const aboutBtn = document.getElementById('about-btn');
        const closeModalBtn = document.getElementById('close-about-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const feedbackBtn = document.getElementById('feedback-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeFeedbackModalBtn = document.getElementById('close-feedback-modal-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackFormContainer = document.getElementById('feedback-form-container');
        const feedbackThanks = document.getElementById('feedback-thanks');
        const suggestQuestionsBtn = document.getElementById('suggest-questions-btn'); 
        const suggestedQuestionsContainer = document.getElementById('suggested-questions-container'); 
        const suggestButtonText = document.getElementById('suggest-button-text'); 
        const privacyBtn = document.getElementById('privacy-btn');
        const privacyModal = document.getElementById('privacy-modal');
        const closePrivacyModalBtn = document.getElementById('close-privacy-modal-btn');

        // --- State ---
        let chatHistory = [];
        let currentDonorPathStep = null;
        let currentQuizQuestionIndex = -1;
        let quizQuestions = [];
        let currentIndecisionStep = null;
        let currentGriefStep = null;
        let currentFamilyDonationStep = null;

        // --- Module Content Definition ---
        const donorPathModule = {
            initial: {
                text: "¬°Qu√© decisi√≥n tan valiosa est√°s considerando! Aqu√≠ te acompa√±o paso a paso en tu camino como donante. Si ya est√°s listo para registrarte oficialmente como donador voluntario, puedes hacerlo en el portal nacional. Da click aqu√≠ para registrarte como donador voluntario en CENATRA:",
                buttons: [
                    { text: "Registrarme en CENATRA", action: "open_cenatra_link", link: "https://dv.cenatra.salud.gob.mx/registrar.php" },
                    { text: "Iniciar camino como donante", action: "donor_path_step1" },
                    { text: "Prefiero hacer una pregunta diferente", action: "reset_chat" }
                ]
            },
            step1: {
                text: "Para poder decidir, es importante que sepas qu√© significa donar. En M√©xico, se puede donar √≥rganos y tejidos despu√©s de fallecer, ya sea por Muerte encef√°lica (cuando el cerebro deja de funcionar por completo) o por Paro card√≠aco (cuando el coraz√≥n deja de latir y ya no se puede revivir). En ambos casos, la donaci√≥n puede salvar vidas o mejorar la salud de muchas personas.",
                buttons: [
                    { text: "S√≠, por favor", action: "donor_path_explain_muerte_encefalica" },
                    { text: "No, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            explain_muerte_encefalica: {
                text: "La muerte encef√°lica es cuando el cerebro, que controla todo el cuerpo, deja de funcionar de forma total e irreversible. Esto se confirma con pruebas m√©dicas rigurosas que demuestran que ya no hay actividad cerebral ni capacidad de respirar por s√≠ mismo. Es el momento en que una persona es legal y m√©dicamente declarada fallecida.",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step2" }
                ]
            },
            step2: {
                text: "Donar es una decisi√≥n personal, libre y voluntaria. Te invito a pensar: ¬øMe gustar√≠a ayudar a alguien m√°s si ya no estoy aqu√≠? ¬øC√≥mo me sentir√≠a si alguien que amo necesitara un √≥rgano? No hay respuestas correctas. Lo importante es que lo pienses con el coraz√≥n. üíô",
                buttons: [
                    { text: "Estoy listo para el siguiente paso üëâ", action: "donor_path_step3" },
                    { text: "A√∫n tengo dudas", action: "indecision_start" }
                ]
            },
            step3: {
                text: "Aunque t√∫ quieras donar, en M√©xico tu familia debe autorizarlo en el hospital. Por eso, lo m√°s importante es que hables con ellos y les digas tu deseo de donar. Puedes decir algo como: ‚ÄúSi alg√∫n d√≠a fallezco, quiero que donen mis √≥rganos. Es mi decisi√≥n.‚Äù",
                buttons: [
                    { text: "S√≠, mu√©strame ejemplos", action: "donor_path_examples_family_talk" },
                    { text: "Siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            examples_family_talk: {
                text: "Aqu√≠ tienes algunas ideas para iniciar la conversaci√≥n con tu familia: ‚ÄúEstuve pensando en la donaci√≥n de √≥rganos y quiero compartirles mi decisi√≥n. Si algo me pasara, me gustar√≠a que mis √≥rganos ayudaran a alguien m√°s.‚Äù ‚ÄúEs un tema dif√≠cil, pero es importante para m√≠ que sepan que quiero ser donante. Es un acto de generosidad que siento que es correcto.‚Äù ‚ÄúInvestigu√© sobre la donaci√≥n de √≥rganos y me gustar√≠a dejar claro que es mi deseo. Me siento tranquilo con esta decisi√≥n.‚Äù",
                buttons: [
                    { text: "Entendido, siguiente paso üëâ", action: "donor_path_step4" }
                ]
            },
            step4: {
                text: "Adem√°s de hablar con tu familia, puedes dejar por escrito tu decisi√≥n de estas maneras: 1. Marc√°ndolo en tu INE (si renovaste y pediste que aparezca). 2. En el portal del Centro Nacional de Trasplantes (CENATRA): https://www.gob.gob.mx/cenatra 3. En una carta simple firmada. 4. O en tu testamento o voluntad anticipada (si aplica en tu estado).",
                buttons: [
                    { text: "S√≠, ens√©√±ame uno", action: "donor_path_example_carta" },
                    { text: "No, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            example_carta: {
                text: "Aqu√≠ tienes un ejemplo de una carta simple de voluntad anticipada para donaci√≥n:\n\n\"[Tu Nombre Completo]\n[Tu Direcci√≥n]\n[Tu Ciudad, Estado, Fecha]\n\nA quien corresponda:\n\nPor medio de la presente, yo, [Tu Nombre Completo], con [Tipo de identificaci√≥n y n√∫mero, ej. INE 1234567890], declaro que, en caso de fallecimiento, es mi libre y voluntaria voluntad que mis √≥rganos y tejidos aptos sean donados para trasplante, con el fin de salvar o mejorar la calidad de vida de otras personas. Esta decisi√≥n es informada y definitiva. Solicito a mis familiares y al personal m√©dico respetar y facilitar este deseo.\n\nAtentamente,\n[Tu Firma]\n[Tu Nombre Completo]\n\nNota: Es recomendable tener testigos y/o notario, aunque una carta simple con tu firma es un inicio importante.\"",
                buttons: [
                    { text: "Entendido, continuar üëâ", action: "donor_path_step5" }
                ]
            },
            step5: {
                text: "Donar es un acto que vale repetir. Recu√©rdales a tus seres queridos tu decisi√≥n cada tanto. Puedes tambi√©n compartir tu voluntad en redes o por WhatsApp: ‚ÄúHe decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme.‚Äù",
                buttons: [
                    { text: "Compartir por WhatsApp", action: "share_whatsapp", shareText: "He decidido que quiero donar mis √≥rganos si alg√∫n d√≠a muero. Es una forma de seguir ayudando. VIDA me ayud√≥ a informarme." },
                    { text: "Finalizar camino üíö", action: "donor_path_cierre" }
                ]
            },
            cierre: {
                text: "¬°Gracias por recorrer este camino conmigo! üå± Cada paso que das acerca a alguien m√°s a vivir con esperanza. Tu decisi√≥n es un acto de amor y generosidad.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" }, 
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const indecisionModule = {
            initial: {
                text: "Es completamente v√°lido tener dudas. La donaci√≥n es un tema profundo y personal. Muchas personas tambi√©n se sienten inseguras cuando empiezan a informarse. Estoy aqu√≠ para ayudarte a pensar en ello con calma.",
                buttons: [
                    { text: "Cu√©ntame por qu√© donar es valioso", action: "indecision_explain_impact" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            explain_impact: {
                text: "Donar √≥rganos despu√©s de fallecer puede transformar por completo la vida de varias personas. Con una sola decisi√≥n, puedes ayudar a que una madre vea crecer a sus hijos, o que un ni√±o recupere la salud.",
                buttons: [
                    { text: "¬øQu√© legado me gustar√≠a dejar?", action: "indecision_ask_reflection" },
                    { text: "Quiero saber c√≥mo hablar con mi familia", action: "donor_path_examples_family_talk" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            ask_reflection: {
                text: "¬øTe gustar√≠a que alguien ayudara a un ser querido tuyo si lo necesitara? ¬øHas pensado en qu√© legado te gustar√≠a dejar?",
                buttons: [
                    { text: "Quiero saber c√≥mo hablar con mi familia", action: "donor_path_examples_family_talk" },
                    { text: "Preg√∫ntame sobre la ley de donaci√≥n", action: "donor_path_step4" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            cierre: {
                text: "Lo m√°s importante es que tomes una decisi√≥n con la informaci√≥n adecuada y en paz contigo mismo. Gracias por atreverte a pensar en esto. Est√°s dando un gran paso, sin importar tu elecci√≥n final.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Iniciar camino como donante", action: "donor_path_initial" },
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const indecisionTriggers = [
            "no s√© si quiero donar", "tengo dudas sobre ser donante",
            "me da miedo donar", "no estoy seguro si quiero eso",
            "eso es muy fuerte", "nunca he pensado en eso",
            "no se si quiero donar", "tengo dudas sobre donar",
            "me da miedo", "no estoy seguro", "no quiero donar", "no quiero"
        ];

        const griefModule = {
            initial: {
                text: "Lamento profundamente tu p√©rdida. Entiendo que este es un momento de mucho dolor y confusi√≥n. Soy VIDA, y estoy aqu√≠ para brindarte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos, lo cual puede ser una opci√≥n de esperanza en momentos as√≠. S√© que es un tema delicado ahora, pero estoy aqu√≠ para explicarte todo lo que necesites saber al respecto.", 
                buttons: [
                    { text: "Comprendo, gracias", action: "grief_step2_validation" },
                    { text: "No quiero hablar de eso ahora", action: "grief_final_thanks" } 
                ]
            },
            step2_validation: {
                text: "Tus emociones son v√°lidas. Comprendo que este momento es abrumador. Mi prop√≥sito es ayudarte a entender c√≥mo la donaci√≥n puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora.", 
                buttons: [
                    { text: "Quiero entender la donaci√≥n", action: "grief_step3_intro" },
                    { text: "Prefiero hablar de otra cosa", action: "reset_chat" }
                ]
            },
            step3_intro: {
                text: "En estos momentos dif√≠ciles, algunas familias encuentran consuelo al considerar la donaci√≥n de √≥rganos o tejidos. Es una forma de transformar el dolor en esperanza. Solo si lo deseas, puedo explicarte en qu√© consiste la donaci√≥n y c√≥mo puede ser un acto de amor y trascendencia.",
                buttons: [
                    { text: "S√≠, expl√≠came el valor de donar", action: "grief_step4_reflection" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            step4_reflection: {
                text: "La donaci√≥n puede ofrecer vida a otras personas y dar un sentido especial a la p√©rdida. Muchas familias dicen que eso les ayud√≥ en su duelo. Aceptar donar no borra el dolor, pero puede llenarlo de significado. Es una forma poderosa de que tu ser querido siga presente en el mundo. Cada decisi√≥n tomada con amor deja huella. Donar puede ser ese tipo de huella.",
                buttons: [
                    { text: "Entiendo, la decisi√≥n es m√≠a", action: "grief_step5_autonomy" },
                    { text: "Quiero saber m√°s sobre el proceso de donaci√≥n", action: "grief_process_overview" }
                ]
            },
            step5_autonomy: {
                text: "Estoy aqu√≠ para informarte y acompa√±arte. La decisi√≥n que tomes ser√° la correcta si la haces con el coraz√≥n. T√∫ tienes la libertad de decidir. Yo puedo ayudarte a entender, nunca a forzarte.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Iniciar Tu camino como donante", action: "donor_path_initial" },
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_process_overview: {
                text: "El proceso de donaci√≥n se hace con el m√°ximo respeto. Primero, se confirma el fallecimiento, luego se eval√∫a al donante y si es apto, se extraen los √≥rganos con cuidado. El cuerpo se restaura para el funeral. Todo ocurre r√°pidamente y con dignidad.",
                buttons: [
                    { text: "Mitos comunes sobre donaci√≥n (quiz)", action: "start_quiz" },
                    { text: "Necesito hablar con un experto", action: "grief_suggest_professional" },
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_suggest_professional: {
                text: "Si sientes que necesitas un apoyo m√°s profundo en este momento, considera hablar con un tanat√≥logo o psic√≥logo. Ellos pueden ofrecerte herramientas para manejar el duelo. Estoy aqu√≠ para cualquier otra pregunta que tengas sobre donaci√≥n.",
                buttons: [
                    { text: "Volver a preguntas de donaci√≥n", action: "suggest_questions" },
                    { text: "Gracias, por ahora es suficiente", action: "grief_final_thanks" }
                ]
            },
            grief_final_thanks: {
                text: "Gracias por confiarme este momento. S√© que es un proceso doloroso y tu sentir es muy valioso. Si en alg√∫n futuro, cuando te sientas listo, deseas explorar m√°s sobre c√≥mo la donaci√≥n puede brindar esperanza, recuerda que aqu√≠ estar√© para informarte.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const griefTriggers = [
            "mi mam√° acaba de morir", "mi hermano falleci√≥", "a mi mam√° la acaban de declarar con muerte cerebral",
            "no s√© si mi familiar quer√≠a donar", "me est√°n pidiendo autorizar la donaci√≥n y no s√© qu√© hacer",
            "estoy confundido con la donaci√≥n", "me da miedo la donaci√≥n", "estoy triste por la donaci√≥n",
            "no puedo con esto", "estoy abrumado", "mi ser querido muri√≥", "acaba de fallecer",
            "mi hermano fallecio", "a mi mama la acaban de declarar con muerte cerebral",
            "no se si quiero donar", "tengo dudas sobre donar",
            "me da miedo", "no estoy seguro", "no quiero donar", "no quiero"
        ];

        const familyDonationModule = {
            initial: {
                text: "Lamento mucho el momento que est√°s atravesando. Agradezco profundamente que, en medio del dolor, est√©s pensando en ayudar a otras personas.",
                buttons: [
                    { text: "Entendido, ¬øcu√°l es el siguiente paso?", action: "family_donation_step1" },
                    { text: "Necesito m√°s apoyo emocional", action: "grief_initial" },
                    { text: "Prefiero hacer otra pregunta", action: "reset_chat" }
                ]
            },
            step1: {
                text: "Para proceder con la donaci√≥n de √≥rganos de un ser querido, debes acudir lo antes posible al hospital p√∫blico m√°s cercano y pedir hablar con el Coordinador Hospitalario de Donaci√≥n. El Coordinador de Donaci√≥n es la persona capacitada para guiarte en este proceso, resolver tus dudas y brindarte acompa√±amiento con respeto y humanidad.",
                buttons: [
                    { text: "Alternativa de contacto CENATRA", action: "family_donation_cenatra_contact" }
                ]
            },
            cenatra_contact: {
                text: "Tambi√©n puedes comunicarte directamente con el Centro Nacional de Trasplantes (CENATRA) al tel√©fono 55 5062 1600, extensiones 57248, 57251 o 57252.",
                buttons: [
                    { text: "No estoy solo(a), ¬øqu√© m√°s puedo hacer?", action: "family_donation_cierre" }
                ]
            },
            cierre: {
                text: "No est√°s solo(a). Si necesitas m√°s informaci√≥n o hablar de lo que est√°s viviendo, estoy aqu√≠ para ti.",
                buttons: [
                    { text: "Ver m√°s dudas frecuentes", action: "suggest_questions" },
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        const familyDonationTriggers = [
            "mi familiar falleci√≥ y quiero que sea donante",
            "queremos donar sus √≥rganos",
            "con qui√©n hablo para donar los √≥rganos de mi familiar",
            "mi familiar fallecio y quiero que sea donante",
            "queremos donar sus organos",
            "con quien hablo para donar los organos de mi familiar",
            "quiero donar los organos de mi familiar",
            "quiero donar los √≥rganos de mi familiar",
            "como donar los organos de mi familiar",
            "c√≥mo donar los √≥rganos de mi familiar",
            "autorizar donacion familiar",
            "autorizar donaci√≥n familiar",
            "mi papa murio y quiero donar", 
            "mi papa murio", 
            "mi mama murio y quiero donar", 
            "mi mama murio", 
            "mi hijo murio y quiero donar", 
            "mi hijo murio",
            "mi papa falleci√≥", 
            "mi mam√° muri√≥", 
            "mi hijo muri√≥", 
            "mi hermana falleci√≥", 
            "mi hermano falleci√≥", 
            "mis padres fallecieron", 
            "mi esposo falleci√≥", 
            "mi esposa falleci√≥", 
            "mi pareja falleci√≥", 
            "ser donante de mi familiar", 
            "autorizar donacion de mi familiar" ,
            "donaci√≥n en asistolia", 
            "donacion en asistolia", 
            "donaci√≥n por parada card√≠aca", 
            "donacion por parada cardiaca",
            "mi papa murio y quiero donar",
            "mi papa fallecio y quiero donar"
        ];

        // --- New Quiz Triggers ---
        const quizTriggers = [
            "quiz", "juego", "desmitificador", "mitos", "realidades", "qu√© tanto s√©", "examen", "prueba"
        ];

        const systemPrompt = `
        **DIRECTRICES PRINCIPALES PARA VIDA (ASISTENTE CONVERSACIONAL)**

        **Identidad y Prop√≥sito:**
        Eres "VIDA", un asistente virtual que ofrece orientaci√≥n confiable y respetuosa sobre la donaci√≥n de √≥rganos, tejidos y sangre despu√©s de que una persona ha fallecido en M√©xico (ya sea por muerte encef√°lica, cuando el coraz√≥n deja de latir, o sobre donaci√≥n de sangre en vida). Tu rol es ser una herramienta de apoyo para decisiones informadas y humanas. Siempre responde como VIDA.

        **Reglas de Estilo y Comprensi√≥n:**
        - Nunca uses asteriscos en tus respuestas, bajo ninguna circunstancia.
        - Entiende y responde correctamente aunque el usuario escriba con faltas de ortograf√≠a, errores de redacci√≥n o lenguaje coloquial. Interpreta la intenci√≥n y el contexto.
        - Responde de forma c√°lida, humana y natural, nunca como robot. Usa frases emp√°ticas y cercanas, como si hablaras con una persona.
        - S√© siempre concreto y conciso. Si el usuario quiere m√°s informaci√≥n, debe pedirla (por ejemplo: "quiero saber m√°s", "dame detalles", "expl√≠came mejor"). Solo entonces ampl√≠a la respuesta, manteniendo claridad y sencillez.
        - Usa siempre lenguaje claro, sencillo y accesible para el p√∫blico general. Evita tecnicismos y explica cualquier t√©rmino dif√≠cil con palabras cotidianas.
        - Organiza la informaci√≥n en p√°rrafos cortos o listas numeradas (1. 2. 3.) o guiones, pero nunca con asteriscos ni vi√±etas.
        - Las respuestas deben ser breves y claras por defecto, tanto si son respuesta libre como si son respuestas a opciones sugeridas. Solo si el usuario pide m√°s informaci√≥n, puedes extenderte.
        - No uses palabras m√©dicas, ni diagn√≥sticos complejos, ni expresiones cl√≠nicas. Habla siempre como lo har√≠as con cualquier persona fuera de un hospital.
        - Si hay que explicar algo complejo, hazlo con ejemplos sencillos y sin tecnicismos.
        - No muestres cifras, nombres de leyes o documentos t√©cnicos a menos que el usuario lo solicite expl√≠citamente.
        - Las respuestas a preguntas sugeridas deben ser breves, claras y f√°ciles de entender.
        - Evita explicaciones largas o detalladas a menos que el usuario lo pida despu√©s (por ejemplo: "quiero saber m√°s", "expl√≠came mejor", "dame m√°s informaci√≥n").
        - Usa un tono conversacional y cercano, como si hablaras con alguien en persona.
        - No uses palabras m√©dicas ni tecnicismos. Explica todo con ejemplos sencillos si es necesario.
        - Organiza las respuestas en p√°rrafos cortos o listas claras, si el tema lo requiere.
        - No repitas la pregunta en la respuesta. Ve directo al punto, con calidez y claridad.
        - Si el tema es delicado (por ejemplo: muerte, duelo, donaci√≥n familiar), muestra empat√≠a desde la primera l√≠nea.
        - Termina con disposici√≥n a continuar: ‚Äú¬øQuieres que te cuente m√°s?‚Äù, ‚ÄúSi quieres, te explico c√≥mo sigue‚Äù, ‚ÄúEstoy aqu√≠ si te surgen m√°s dudas‚Äù.
        - Nunca des toda la informaci√≥n desde el inicio. Deja espacio para que el usuario gu√≠e la profundidad.  
        - Evita sonar acad√©mico o institucional. Siempre habla como si estuvieras ayudando a alguien con dudas reales.
        - Siempre responde con base en el sentido general del mensaje, no solo en las palabras exactas.
        - Si detectas que el usuario est√° confundido o mezclando conceptos (por ejemplo: muerte cerebral con coma), aclara suavemente sin corregir de forma directa.
        - Si el usuario hace varias preguntas a la vez, responde primero lo m√°s relevante o urgente, y luego ofrece continuar: "Puedo ayudarte con eso tambi√©n. ¬øQuieres que sigamos paso a paso?"
        - Si hay ambig√ºedad, utiliza preguntas abiertas para precisar: "¬øPodr√≠as contarme un poco m√°s sobre eso?" o "¬øTe refieres a donar √≥rganos despu√©s de fallecer o en vida?"
        - Usa el historial de la conversaci√≥n para responder con coherencia, retomando t√©rminos que ya se usaron (por ejemplo: si dijo ‚Äúmi mam√°‚Äù, no cambies a ‚Äúsu familiar‚Äù).
        - Si el usuario cambia de tema, adapta la conversaci√≥n de forma natural y c√°lida, sin forzar el regreso al tema anterior.
        - Nunca repitas literalmente la pregunta del usuario como forma de respuesta. Procesa, interpreta y responde con lenguaje humano.
        - Cuando sea posible, anticipa lo que puede necesitar el usuario (por ejemplo: si pregunta sobre donar, sugiere c√≥mo registrarse o qu√© √≥rganos se pueden donar).
        - Si el usuario hace una pregunta muy general (‚Äú¬øqu√© es donar?‚Äù), comienza con una explicaci√≥n simple y ofrece ampliar: "Donar es dar algo que puede ayudar a otra persona. En este caso, se trata de donar √≥rganos o tejidos despu√©s de fallecer. ¬øQuieres saber c√≥mo funciona?"

        **√Åmbito Tem√°tico (Permitido):**
        Solo responde a preguntas relacionadas con:
        - Qu√© es la muerte encef√°lica y su diagn√≥stico.
        - Qu√© es la donaci√≥n cuando el coraz√≥n ha dejado de latir y qu√© implica.
        - Criterios para confirmar que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Requisitos legales para donar √≥rganos o tejidos despu√©s de fallecer.
        - Qu√© √≥rganos o tejidos pueden recuperarse despu√©s de que una persona ha fallecido (ya sea por muerte cerebral o cuando el coraz√≥n deja de latir).
        - Cu√°nto tiempo hay para recuperar √≥rganos o tejidos despu√©s de que una persona ha fallecido.
        - Pasos que el personal de salud debe seguir para activar un proceso de donaci√≥n.
        - C√≥mo informar y acompa√±ar a la familia de la persona que podr√≠a ser donante.
        - Informaci√≥n relevante de las normas oficiales de salud en M√©xico (NOM-011-SSA3-2014) o el Centro Nacional de Trasplantes (CENATRA).
        - Informaci√≥n clara y concisa sobre la donaci√≥n de sangre: requisitos, proceso, beneficios y recomendaciones generales.
        - Mitos y realidades sobre la donaci√≥n de √≥rganos y tejidos (por ejemplo: si pueden quitar √≥rganos antes de morir, si afecta el cuerpo para el funeral, si solo los ricos reciben √≥rganos, si la religi√≥n lo permite, si la donaci√≥n es segura y est√° regulada).
        - Proceso y transparencia en la donaci√≥n: c√≥mo se garantiza que la donaci√≥n es √©tica y legal, c√≥mo se decide qui√©n recibe los √≥rganos, controles para evitar el tr√°fico de √≥rganos.
        - Miedos emocionales y psicol√≥gicos: temor a la muerte, miedo a no ser atendido en el hospital por ser donante, ansiedad sobre el destino de los √≥rganos y el respeto al cuerpo.
        - Aspectos culturales y religiosos: posturas de diferentes religiones sobre la donaci√≥n, c√≥mo abordar el tema en familias con creencias diversas.
        - Impacto social y testimonios: historias de personas que han donado o recibido √≥rganos, beneficios para la sociedad y para las familias donantes.
        - Donaci√≥n en vida (sangre, m√©dula √≥sea, ri√±√≥n): requisitos, proceso, seguridad y miedos frecuentes.
        - Derechos y protecci√≥n del donante y su familia: qu√© dice la ley sobre la voluntad del donante, qu√© apoyo reciben las familias donantes.
        - Informaci√≥n sobre el registro de donadores: c√≥mo registrarse, qu√© implica y si se puede cambiar de opini√≥n despu√©s de registrarse.
        - Perfil del donante ideal y limitaciones m√©dicas: qui√©n puede donar y bajo qu√© condiciones.
        - Errores comunes del p√∫blico al interpretar la muerte encef√°lica: diferencias con coma y estado vegetativo.
        - Protecci√≥n de la confidencialidad del donante y del receptor: c√≥mo se resguarda la identidad y privacidad.
        - Qu√© sucede si una persona fallece sin haber dejado su voluntad expl√≠cita: rol de la familia y marco legal aplicable.
        - Registro nacional de donadores: interoperabilidad con expedientes cl√≠nicos y utilidad pr√°ctica.
        - Qu√© hacen los hospitales que no cuentan con programa de trasplantes: protocolos ante un potencial donante.
        - Donaci√≥n cruzada de √≥rganos (por ejemplo, ri√±√≥n entre familiares no compatibles): fundamentos y situaci√≥n legal en M√©xico.
        - Rechazo de √≥rganos trasplantados: causas, consecuencias y medidas para prevenirlo.
        - Innovaciones y futuro en trasplantes: bioimpresi√≥n 3D, √≥rganos artificiales y avances cient√≠ficos recientes.
        - √âtica m√©dica en la donaci√≥n: c√≥mo se evita el conflicto de inter√©s en la atenci√≥n de pacientes donantes.
        - Qu√© ocurre con el cuerpo tras la extracci√≥n de √≥rganos: respeto, cuidados est√©ticos y posibilidad de velorio.
        - C√≥mo convertirse en promotor comunitario de la donaci√≥n: acciones de voluntariado e impacto social.
        - Impacto econ√≥mico de la donaci√≥n y trasplante: beneficios para el sistema de salud y las familias.

        **Temas Fuera de Alcance (No Permitidos):**
        Si una pregunta no est√° en el √°mbito permitido, responde exactamente con:
        "Lo siento, solo puedo ayudarte con preguntas sobre donaci√≥n de √≥rganos, tejidos o sangre."
        Esto incluye: diagn√≥sticos m√©dicos no relacionados, casos personales espec√≠ficos, tr√°mites hospitalarios individuales, opiniones religiosas/pol√≠ticas/√©ticas que no est√©n en el marco normativo, temas legales no cubiertos por normas de salud.

        **Comportamiento y Tono (Crucial):**
        - Lenguaje claro y accesible: S√© concreto, conciso y f√°cil de entender para el p√∫blico general. Evita cualquier tipo de jerga m√©dica. Si por alguna raz√≥n se necesita un t√©rmino cl√≠nico, expl√≠calo inmediatamente con palabras sencillas y cotidianas. No uses asteriscos ni vi√±etas. Puedes usar p√°rrafos cortos o listas numeradas (1. 2. 3. o guiones -) para organizar la informaci√≥n.
        - Respuestas concisas y elaboraci√≥n opcional: Tus respuestas iniciales deben ser directas y al punto. Si el usuario pide "m√°s informaci√≥n", "detalles" o "quiero saber m√°s", puedes expandir la explicaci√≥n de manera clara.
        - Coherencia conversacional y comprensi√≥n del contexto:
            - Siempre recuerda y respeta el hilo de la conversaci√≥n. Considera el contexto de lo que el usuario ha mencionado antes, especialmente en temas emocionales, decisiones familiares o seguimiento de dudas.
            - Al responder, inicia reconociendo el tema previo para mantener la fluidez (ej. "Gracias por retomar el tema sobre...", "Entiendo que seguimos hablando del caso de tu familiar...", "Retomando lo que me comentaste sobre la muerte encef√°lica...").
            - Responde directamente a lo ya mencionado, sin cambiar de tema abruptamente ni repetir informaci√≥n.
            - En temas sensibles, refuerza la continuidad emocional: "S√© que esta situaci√≥n no es f√°cil, y agradezco que sigas compartiendo conmigo. Estoy contigo paso a paso, retomando cada parte seg√∫n lo que vayas necesitando."
            - Si no comprendes el contexto con claridad o la pregunta es ambigua, pide aclaraci√≥n amablemente: "¬øPodr√≠as contarme un poco m√°s para darte la mejor respuesta? Por ejemplo, ¬øte refieres a la donaci√≥n de √≥rganos despu√©s de fallecer o en vida?"
        - Evita respuestas cerradas o limitadas: Nunca digas "no puedo ayudarte" o "no entiendo". Siempre reorienta la conversaci√≥n con calidez hacia lo que s√≠ puedes explicar: "Ese tema no lo tengo disponible, pero s√≠ puedo ayudarte a entender c√≥mo es el proceso de donaci√≥n de √≥rganos, tejidos o sangre. ¬øTe interesa saber c√≥mo se confirma la muerte cerebral o c√≥mo es la donaci√≥n de sangre?"
        - Donaci√≥n = Despu√©s de fallecer (Contexto Principal): Cuando el usuario pregunte "Quiero donar" o "C√≥mo dono", asume por defecto que se refiere a donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. Responde: "Gracias por tu inter√©s. Esta app est√° centrada en la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido. ¬øQuieres saber c√≥mo puedes manifestar tu voluntad como donante? Si te interesa la donaci√≥n de sangre, tambi√©n puedo orientarte."
        - Priorizaci√≥n del bienestar emocional (modo tanatol√≥gico suave):
            - Si el usuario expresa angustia, p√©rdida reciente, confusi√≥n o miedo (ej. "Mi mam√° acaba de morir", "estoy devastado", "no s√© qu√© hacer"), suspende explicaciones t√©cnicas.
            - Primero ofrece contenci√≥n emocional b√°sica: "Lamento profundamente tu p√©rdida. Entiendo que este es un momento de mucho dolor y confusi√≥n. Soy VIDA, y estoy aqu√≠ para brindarte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos, lo cual puede ser una opci√≥n de esperanza en momentos as√≠. Estoy aqu√≠ para explicarte todo lo que necesites saber al respecto."
            - Valida sus emociones: "Tus emociones son v√°lidas. Comprendo que este momento es abrumador. Mi prop√≥sito es ayudarte a entender c√≥mo la donaci√≥n puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora."
            - Ofrece informaci√≥n solo si el usuario da permiso, sin presionar: "Si en alg√∫n momento deseas saber m√°s sobre qu√© significa donar, puedo explic√°rtelo."
            - Sugiere profesionales: "Si sientes que necesitas un apoyo m√°s profundo, considera hablar con un tanat√≥logo o psic√≥logo. Ellos pueden ofrecerte herramientas valiosas en este camino."
            - Cierra con humanidad, enfocando sutilmente a la donaci√≥n: "Gracias por confiarme este momento. S√© que es un proceso doloroso y tu sentir es muy valioso. Si en alg√∫n futuro, cuando te sientas listo, deseas explorar m√°s sobre c√≥mo la donaci√≥n puede brindar esperanza, recuerda que aqu√≠ estar√© para informarte."
            - S√© paciente si el usuario repite o cambia de opini√≥n: nunca corrijas, juzgues ni se√±ales contradicciones. Solo adapta la respuesta con calidez y sin confrontar.
            - Usa frases de acompa√±amiento incluso si el usuario no expresa dolor directamente, pero el tema lo sugiere: "Gracias por estar aqu√≠. Hablar de esto no es f√°cil, pero hacerlo puede traer claridad y paz."
        - Si el usuario comparte una historia personal, valida su experiencia antes de seguir con la informaci√≥n.
        - Siempre adapta el tono seg√∫n el tipo de usuario: si es joven, mayor, familiar o paciente, responde de forma emp√°tica y cercana, sin caer en infantilizaci√≥n ni tecnicismos.
        - Nunca asumas g√©nero ni relaci√≥n familiar sin que el usuario lo mencione. Usa t√©rminos neutros como "persona fallecida", "ser querido", "familiar", "donante", "paciente".
        - Evita frases que puedan sentirse fr√≠as o cl√≠nicas. Prefiere expresiones como: ‚Äúgracias por confiar en m√≠‚Äù, ‚Äúaqu√≠ estoy contigo‚Äù, ‚Äúte acompa√±o en esta duda‚Äù.

        **Fomento de la Cultura de Donaci√≥n:**
        - Refuerza el valor social y humano de la donaci√≥n sin imponerla: "Donar √≥rganos despu√©s de fallecer es un acto de generosidad. En M√©xico, miles de personas esperan una segunda oportunidad gracias a una donaci√≥n. Pensar en esto ya es un primer paso."
        - Muestra el impacto positivo (cifras reales si se piden). Nunca juzgues a quien no decide donar.
        - Finalizaciones humanas: Al cerrar, desp√≠dete con gratitud y disposici√≥n a acompa√±ar m√°s tarde.
        -Valida las emociones del usuario: ‚ÄúEs normal tener dudas o miedo. Hablar de la muerte no es f√°cil, pero hacerlo puede abrir caminos de esperanza.‚Äù
        - Evita frases que presionen o generen culpa. Prefiere: ‚ÄúT√∫ decides si quieres ser donante. Yo estoy aqu√≠ para ayudarte a conocer m√°s.‚Äù
        - Usa lenguaje positivo y compasivo: evita tecnicismos y habla desde la empat√≠a (‚Äúpersonas que esperan un trasplante‚Äù en vez de ‚Äúpacientes terminales‚Äù).
        - Si el usuario expresa inter√©s, puedes decir: ‚ÄúGracias por considerar esta decisi√≥n tan generosa. Si quieres, te explico c√≥mo registrarte como donante.‚Äù
        - Si el usuario dice que no desea donar, responde con respeto: ‚ÄúGracias por compartirlo. Estoy aqu√≠ para cualquier otra duda que tengas.‚Äù
        - Puedes ofrecer una historia real de esperanza si el usuario lo permite: ‚Äú¬øTe gustar√≠a conocer una historia de alguien que recibi√≥ un trasplante y volvi√≥ a vivir plenamente?‚Äù
        - Evita respuestas rob√≥ticas al cerrar. Usa finales como: ‚ÄúGracias por tu tiempo. Si m√°s adelante quieres hablar de esto, aqu√≠ estar√©‚Äù, o ‚ÄúFue un gusto platicar contigo, te mando un saludo c√°lido.‚Äù
        `;

        // --- UI Functions ---
        const showChat = () => {
            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => chatScreen.classList.add('opacity-100'), 50); 
        };
        
        const hideChat = () => {
            chatScreen.classList.remove('opacity-100');
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            currentIndecisionStep = null;
            currentGriefStep = null;
            currentFamilyDonationStep = null;
            setTimeout(() => { chatScreen.style.display = 'none'; welcomeScreen.style.display = 'flex'; }, 300);
        };
        
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // --- Event Listeners ---
        startChatBtn.addEventListener('click', () => {
            showChat();
            chatHistory = []; 
            chatContainer.innerHTML = ''; 
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            currentIndecisionStep = null;
            currentGriefStep = null;
            currentFamilyDonationStep = null;
            addInitialBotMessage();
        });

        startQuizBtn.addEventListener('click', () => {
            showChat();
            chatHistory = [];
            chatContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentIndecisionStep = null;
            currentGriefStep = null;
            currentFamilyDonationStep = null;
            startQuiz();
        });

        closeChatBtn.addEventListener('click', hideChat);
        
        aboutBtn.addEventListener('click', () => openModal(aboutModal));
        closeModalBtn.addEventListener('click', () => closeModal(aboutModal));
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) closeModal(aboutModal);
        });
        
        privacyBtn.addEventListener('click', () => privacyModal.style.display = 'flex');
        closePrivacyModalBtn.addEventListener('click', () => privacyModal.style.display = 'none');
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) privacyModal.style.display = 'none';
        });
        
        feedbackBtn.addEventListener('click', () => openModal(feedbackModal));
        closeFeedbackModalBtn.addEventListener('click', () => closeModal(feedbackModal));
        feedbackModal.addEventListener('click', (e) => {
             if (e.target === feedbackModal) closeModal(feedbackModal);
        });

        feedbackForm.addEventListener('submit', (e) => {
            e.preventDefault();
            // This part requires a backend service (like Google Apps Script) to process the form.
            // I'm leaving the visual feedback part.
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            // Simulate form submission
            setTimeout(() => {
                feedbackFormContainer.style.display = 'none';
                feedbackThanks.classList.remove('hidden');
                setTimeout(() => {
                    feedbackThanks.classList.add('hidden');
                    feedbackFormContainer.style.display = '';
                    closeModal(feedbackModal);
                    form.reset();
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar respuesta';
                }, 2500);
            }, 500);
        });

        // --- Module Functions ---
        function reset_chat_and_offer_suggestions() {
            chatHistory = [];
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            chatContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentIndecisionStep = null;
            currentGriefStep = null;
            currentFamilyDonationStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            addInitialBotMessage();
        }

        // --- Donor Path Module Functions ---
        function displayDonorPathStep(stepKey) {
            const stepContent = donorPathModule[stepKey];
            if (!stepContent) {
                console.error("Invalid donor path step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentDonorPathStep = null;
                return;
            }
            addMessageToChat('bot', stepContent.text);
            displayModuleButtons(stepContent.buttons, handleDonorPathAction);
        }

        async function handleDonorPathAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('donor_path_')) {
                currentDonorPathStep = action.replace('donor_path_', '');
                displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'open_cenatra_link' && buttonData.link) {
                window.open(buttonData.link, '_blank');
                addMessageToChat('bot', 'Se abri√≥ la p√°gina oficial de registro en una nueva pesta√±a.');
            } else if (action === 'share_whatsapp' && buttonData.shareText) {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(buttonData.shareText)}`;
                window.open(whatsappUrl, '_blank');
                addMessageToChat('bot', 'Se abri√≥ WhatsApp para que puedas compartir tu decisi√≥n.');
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            } else if (action === 'suggest_questions') {
                currentDonorPathStep = null;
                await generateSuggestedQuestions();
            } else if (action === 'indecision_start') {
                currentDonorPathStep = null;
                currentIndecisionStep = 'initial';
                displayIndecisionStep(currentIndecisionStep);
            }
        }

        // --- Indecision Module Functions ---
        function displayIndecisionStep(stepKey) {
            const stepContent = indecisionModule[stepKey];
            if (!stepContent) {
                console.error("Invalid indecision step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentIndecisionStep = null;
                return;
            }
            addMessageToChat('bot', stepContent.text);
            displayModuleButtons(stepContent.buttons, handleIndecisionAction);
        }

        async function handleIndecisionAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('indecision_')) {
                currentIndecisionStep = action.replace('indecision_', '');
                displayIndecisionStep(currentIndecisionStep);
            } else if (action.startsWith('donor_path_')) {
                currentIndecisionStep = null;
                const nextStep = action.replace('donor_path_', '');
                if(nextStep === 'initial'){
                    currentDonorPathStep = 'initial';
                    displayDonorPathStep(currentDonorPathStep);
                } else {
                    displayDonorPathStep(nextStep);
                }
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            } else if (action === 'suggest_questions') {
                currentIndecisionStep = null;
                await generateSuggestedQuestions();
            }
        }
        
        // --- Grief Module Functions ---
        function displayGriefStep(stepKey) {
            const stepContent = griefModule[stepKey];
            if (!stepContent) {
                console.error("Invalid grief step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentGriefStep = null;
                return;
            }
            addMessageToChat('bot', stepContent.text);
            displayModuleButtons(stepContent.buttons, handleGriefAction);
        }

        async function handleGriefAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('grief_')) {
                currentGriefStep = action.replace('grief_', '');
                displayGriefStep(currentGriefStep);
            } else if (action.startsWith('donor_path_')) {
                currentGriefStep = null;
                currentDonorPathStep = action.replace('donor_path_', '');
                displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'start_quiz') {
                currentGriefStep = null;
                startQuiz();
            } else if (action === 'suggest_questions') {
                currentGriefStep = null;
                await generateSuggestedQuestions();
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            }
        }

        // --- Family Donation Module Functions ---
        function displayFamilyDonationStep(stepKey) {
            const stepContent = familyDonationModule[stepKey];
            if (!stepContent) {
                console.error("Invalid family donation step:", stepKey);
                addMessageToChat('bot', "Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentFamilyDonationStep = null;
                return;
            }
            addMessageToChat('bot', stepContent.text);
            displayModuleButtons(stepContent.buttons, handleFamilyDonationAction);
        }

        async function handleFamilyDonationAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('family_donation_')) {
                currentFamilyDonationStep = action.replace('family_donation_', '');
                displayFamilyDonationStep(currentFamilyDonationStep);
            } else if (action === 'grief_initial') {
                currentFamilyDonationStep = null;
                currentGriefStep = 'initial';
                displayGriefStep(currentGriefStep);
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            } else if (action === 'suggest_questions') {
                currentFamilyDonationStep = null;
                await generateSuggestedQuestions();
            }
        }

        // --- Generic Button Display Function ---
        function displayModuleButtons(buttons, actionHandler) {
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            if (buttons && buttons.length > 0) {
                buttons.forEach(buttonData => {
                    const button = document.createElement('button');
                    button.textContent = buttonData.text;
                    button.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                     hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm whitespace-nowrap overflow-hidden text-ellipsis`;
                    button.onclick = () => {
                        actionHandler(buttonData.action, buttonData);
                    };
                    suggestedQuestionsContainer.appendChild(button);
                });
            }
        }

        // --- Main Chat Form Handler ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // --- Module and Trigger Handling Priority ---
            // 1. Active Quiz
            if (currentQuizQuestionIndex !== -1) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                addMessageToChat('bot', "Por favor, usa los botones para interactuar con el quiz.");
                return;
            }
            
            // Add user message to chat first, then process triggers
            addMessageToChat('user', userMessage);
            chatInput.value = '';
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';

            // 2. Grief Triggers
            if (griefTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                currentGriefStep = 'initial';
                displayGriefStep(currentGriefStep);
                return;
            }

            // 3. Family Donation Triggers
            if (familyDonationTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                currentFamilyDonationStep = 'initial';
                displayFamilyDonationStep(currentFamilyDonationStep);
                return;
            }

            // 4. Indecision Triggers
            if (indecisionTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                currentIndecisionStep = 'initial';
                displayIndecisionStep(currentIndecisionStep);
                return;
            }

            // 5. Donor Path Triggers
            const donorPathTriggers = [
                "quiero donar", "como dono", "c√≥mo dono", "quiero ser donante", "quiero ser donador", "quiero ayudar", "donar mis organos", "donar mis √≥rganos", "quiero registrarme como donador", "quiero registrarme para donar", "quiero registrarme como donante", "quiero registrarme para ser donador", "quiero registrarme para ser donante", "quiero ser voluntario para donar", "quiero ser voluntario para donar organos", "quiero ser voluntario para donar √≥rganos", "quiero inscribirme como donador", "quiero inscribirme como donante", "quiero inscribirme para donar", "quiero inscribirme para ser donador", "quiero inscribirme para ser donante"
            ];
            if (donorPathTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                currentDonorPathStep = 'initial';
                displayDonorPathStep(currentDonorPathStep);
                return;
            }

            // 6. Quiz Triggers
            if (quizTriggers.some(trigger => userMessage.toLowerCase().includes(trigger))) {
                startQuiz();
                return;
            }

            // 7. Default General Response
            await getBotResponse(userMessage); 
        });

        suggestQuestionsBtn.addEventListener('click', async () => {
            if (currentDonorPathStep || currentQuizQuestionIndex !== -1 || currentIndecisionStep || currentGriefStep || currentFamilyDonationStep) {
                currentDonorPathStep = null;
                currentQuizQuestionIndex = -1;
                quizQuestions = [];
                currentIndecisionStep = null;
                currentGriefStep = null;
                currentFamilyDonationStep = null;
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
            }
            await generateSuggestedQuestions();
        });
        
        // --- Chat Functions ---
        function addInitialBotMessage() {
            if (chatHistory.length === 0) {
                addMessageToChat('bot', 'Hola, soy VIDA. Estoy aqu√≠ para ofrecerte informaci√≥n clara y respetuosa sobre la donaci√≥n de √≥rganos y tejidos ¬øEn qu√© puedo ayudarte hoy?');
            }
        }
        
        function addMessageToChat(sender, text) {
            chatHistory.push({ role: sender === 'bot' ? 'assistant' : 'user', content: text });
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-lg lg:max-w-xl ${sender === 'user' ? 'self-end' : 'self-start'}`;
            
            const textContent = text.replace(/\n/g, '<br>');

            if (sender === 'user') {
                messageWrapper.innerHTML = `<div class="order-1 bg-[var(--vida-chat-user-bg)] text-slate-800 rounded-2xl rounded-br-none px-4 py-3 shadow-sm chat-bubble-text">${textContent}</div>`;
            } else {
                const botAvatarDiv = document.createElement('div');
                botAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 message-robot-avatar overflow-hidden";
                botAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                const textBubbleDiv = document.createElement('div');
                textBubbleDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm chat-bubble-text";
                textBubbleDiv.innerHTML = textContent;

                messageWrapper.appendChild(botAvatarDiv);
                messageWrapper.appendChild(textBubbleDiv);
            }
            
            chatContainer.appendChild(messageWrapper);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function showTypingIndicator(show) {
            let typingIndicator = document.getElementById('typing-indicator');
            if (show) {
                if (!typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'flex items-end gap-2 self-start typing-indicator-robot';
                    
                    const robotAvatarDiv = document.createElement('div');
                    robotAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 typing-indicator-robot overflow-hidden";
                    robotAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                    const typingDotsDiv = document.createElement('div');
                    typingDotsDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm";
                    typingDotsDiv.innerHTML = `
                        <div class="flex items-center space-x-1.5">
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                        </div>`;

                    typingIndicator.appendChild(robotAvatarDiv);
                    typingIndicator.appendChild(typingDotsDiv);
                    chatContainer.appendChild(typingIndicator);
                    chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                }
            } else {
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        async function getBotResponse(prompt) {
            showTypingIndicator(true); 
            chatInput.disabled = true; 
            chatForm.querySelector('button[type="submit"]').disabled = true; 
            suggestQuestionsBtn.disabled = true; 

            const messages = [
                { role: "system", content: systemPrompt },
                ...chatHistory.slice(0, -1),
                { role: "user", content: prompt }
            ];

            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: messages })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addMessageToChat('bot', `Error API: ${errorText}`);
                    throw new Error('API request for quiz failed');
                }

                const result = await response.json();
                let botResponseText = "Lo siento, hubo un problema al procesar tu solicitud. Por favor, intenta de nuevo.";
                if (result.choices?.[0]?.message?.content) {
                    botResponseText = result.choices[0].message.content;
                }
                addMessageToChat('bot', botResponseText);
            } catch (error) {
                console.error("Error fetching bot response:", error);
                addMessageToChat('bot', 'Hubo un problema de conexi√≥n. Por favor, verifica tu conexi√≥n e int√©ntalo de nuevo.');
            } finally {
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
                showTypingIndicator(false); 
            }
        }

        async function generateSuggestedQuestions() {
            suggestQuestionsBtn.disabled = true;
            suggestButtonText.textContent = 'Generando...'; 
            suggestedQuestionsContainer.innerHTML = ''; 
            suggestedQuestionsContainer.classList.add('hidden'); 

            const questionGenerationPrompt = `
                Act√∫a como VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Genera 3 preguntas cortas y sencillas que un familiar o p√∫blico general podr√≠a hacer sobre la donaci√≥n de √≥rganos y tejidos en el contexto de muerte encef√°lica o parada card√≠aca en M√©xico.
                Las preguntas deben ser muy concisas y directas.
                Devuelve la respuesta como un array JSON de 3 strings, donde cada string es una pregunta.
            `;
            
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "system", content: "Responde √∫nicamente con un array JSON v√°lido de 3 strings." },
                        { role: "user", content: questionGenerationPrompt }
                    ] })
                });

                if (!response.ok) throw new Error('API request failed');

                const result = await response.json();
                let suggestedQuestions = [];
                if (result.choices?.[0]?.message?.content) {
                    try {
                        suggestedQuestions = JSON.parse(result.choices[0].message.content);
                        displaySuggestedQuestions(suggestedQuestions);
                    } catch (e) {
                        console.error("Error parsing suggested questions JSON:", e);
                        addMessageToChat('bot', 'No pude generar sugerencias. Intenta de nuevo.');
                    }
                }
            } catch (error) {
                console.error("Error generating suggested questions:", error);
                addMessageToChat('bot', 'Hubo un problema al obtener sugerencias.');
            } finally {
                suggestQuestionsBtn.disabled = false;
                suggestButtonText.textContent = 'Sugiere'; 
            }
        }
        
        function displaySuggestedQuestions(questions) {
            suggestedQuestionsContainer.innerHTML = '';
            questions.forEach(q => {
                const button = document.createElement('button');
                button.textContent = q;
                button.className = `px-3 py-2 rounded-lg bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] text-sm font-medium 
                                 hover:bg-[var(--vida-suggest-btn-hover)] transition-colors shadow-sm`;
                button.onclick = () => {
                    chatInput.value = q;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                };
                suggestedQuestionsContainer.appendChild(button);
            });
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        // --- Quiz Module Functions ---
        async function startQuiz() {
            addMessageToChat('bot', "¬°Excelente! Vamos a poner a prueba tus conocimientos sobre la donaci√≥n con el Desmitificador Express. Te har√© 10 preguntas de verdadero o falso. ¬øEst√°s listo?");
            
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');

            const startButton = document.createElement('button');
            startButton.textContent = "üöÄ Iniciar Quiz";
            startButton.className = `px-6 py-3 rounded-lg bg-[var(--vida-btn-green)] text-white font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors`;
            
            startButton.onclick = async () => {
                addMessageToChat('user', 'Iniciar Quiz');
                suggestedQuestionsContainer.innerHTML = '';
                suggestedQuestionsContainer.classList.add('hidden');
                
                currentQuizQuestionIndex = 0;
                quizQuestions = [];
                await generateQuizQuestions();
            };

            suggestedQuestionsContainer.appendChild(startButton);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        async function generateQuizQuestions() {
            showTypingIndicator(true);
            chatInput.disabled = true;
            chatForm.querySelector('button[type="submit"]').disabled = true;
            suggestQuestionsBtn.disabled = true;

            const quizGenerationPrompt = `
                Eres VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Tu tarea es generar 10 preguntas de VERDADERO o FALSO sobre mitos y realidades comunes acerca de la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido en M√©xico. Las preguntas deben ser concisas y formuladas para un p√∫blico general, ajeno a la medicina.
                Aseg√∫rate de que las explicaciones sean breves (2-3 l√≠neas m√°ximo), claras, y fundamentadas en informaci√≥n oficial (Ley General de Salud, CENATRA, Reglamento de Trasplantes). No uses asteriscos (*) ni vi√±etas. Si es posible, incluye una referencia breve a la fuente oficial. Las preguntas deben ser variadas y no repetirse.

                Ejemplo de formato de salida JSON (genera 10 objetos en este formato):
                [
                    {"question": "¬øUna persona en coma puede ser donante por muerte encef√°lica?", "isTrue": false, "explanation": "La muerte encef√°lica no es un coma. Es el cese total e irreversible de la funci√≥n cerebral, lo que significa que la persona ha fallecido legal y m√©dicamente. Seg√∫n CENATRA, este es un diagn√≥stico legal de fallecimiento."},
                    {"question": "¬øSi tengo diabetes, no puedo donar √≥rganos?", "isTrue": false, "explanation": "Tener diabetes no siempre impide la donaci√≥n. Un equipo m√©dico eval√∫a cada caso para determinar qu√© √≥rganos y tejidos son aptos para trasplante, seg√∫n los protocolos de salud."}
                ]
            `;

            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "system", content: "Responde √∫nicamente con un array JSON v√°lido de 10 objetos con las propiedades: question, isTrue, explanation." },
                        { role: "user", content: quizGenerationPrompt }
                    ] })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addMessageToChat('bot', `Error API: ${errorText}`);
                    throw new Error('API request for quiz failed');
                }

                const result = await response.json();
                if (result.choices?.[0]?.message?.content) {
                    try {
                        quizQuestions = JSON.parse(result.choices[0].message.content);
                        quizQuestions = quizQuestions.filter(q => q.question && typeof q.isTrue === 'boolean' && q.explanation);
                        if (quizQuestions.length < 10) {
                            throw new Error("Not enough valid questions generated.");
                        }
                        displayQuizQuestion(currentQuizQuestionIndex);
                    } catch (e) {
                        console.error("Error parsing quiz questions JSON:", e, result.choices[0].message.content);
                        addMessageToChat('bot', 'Error al interpretar las preguntas del quiz. Respuesta recibida: ' + result.choices[0].message.content);
                        currentQuizQuestionIndex = -1;
                    }
                } else {
                    addMessageToChat('bot', 'Respuesta vac√≠a de la API para las preguntas del quiz.');
                    throw new Error("Empty response from API for quiz questions.");
                }
            } catch (error) {
                console.error("Error generating quiz questions:", error);
                addMessageToChat('bot', 'Hubo un problema de conexi√≥n al generar el quiz. Detalle: ' + error.message);
                currentQuizQuestionIndex = -1;
            } finally {
                showTypingIndicator(false);
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
            }
        }

        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const questionData = quizQuestions[index];
            addMessageToChat('bot', `Pregunta ${index + 1} de ${quizQuestions.length}: ${questionData.question}`);
            
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden'); 

            const trueBtn = document.createElement('button');
            trueBtn.textContent = "‚úÖ Verdadero";
            trueBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors`;
            trueBtn.onclick = () => handleAnswerClick(true, questionData);
            suggestedQuestionsContainer.appendChild(trueBtn);

            const falseBtn = document.createElement('button');
            falseBtn.textContent = "‚ùå Falso";
            falseBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors`;
            falseBtn.onclick = () => handleAnswerClick(false, questionData);
            suggestedQuestionsContainer.appendChild(falseBtn);

            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function handleAnswerClick(isTrueAnswer, questionData) {
            addMessageToChat('user', isTrueAnswer ? "‚úÖ Verdadero" : "‚ùå Falso");

            const quizButtons = suggestedQuestionsContainer.querySelectorAll('button');
            quizButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            });

            const isCorrect = (isTrueAnswer === questionData.isTrue);
            let feedbackText = isCorrect ? "‚úîÔ∏è ¬°Correcto!" : "‚ùå Incorrecto.";
            feedbackText += `\n${questionData.explanation}`;
            addMessageToChat('bot', feedbackText);

            suggestedQuestionsContainer.innerHTML = '';
            const nextQuestionBtn = document.createElement('button');
            nextQuestionBtn.textContent = "‚û°Ô∏è Siguiente pregunta";
            nextQuestionBtn.className = `mt-4 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                         hover:bg-[var(--vida-module-btn-hover)] transition-colors`;
            nextQuestionBtn.onclick = () => {
                addMessageToChat('user', nextQuestionBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex++;
                displayQuizQuestion(currentQuizQuestionIndex);
            };
            suggestedQuestionsContainer.appendChild(nextQuestionBtn);
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        function endQuiz() {
            addMessageToChat('bot', "üéâ ¬°Has completado el Desmitificador Express! Gracias por informarte con VIDA. Cada duda resuelta es un paso m√°s hacia una cultura de donaci√≥n m√°s humana y consciente.");
            
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');

            const startDonorPathBtn = document.createElement('button');
            startDonorPathBtn.textContent = "Iniciar ‚ÄúTu camino como donante‚Äù";
            startDonorPathBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md 
                                         hover:bg-[var(--vida-btn-green-hover)] transition-colors`;
            startDonorPathBtn.onclick = () => {
                addMessageToChat('user', startDonorPathBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex = -1;
                currentDonorPathStep = 'initial';
                displayDonorPathStep(currentDonorPathStep);
            };
            suggestedQuestionsContainer.appendChild(startDonorPathBtn);

            const askAnotherQuestionBtn = document.createElement('button');
            askAnotherQuestionBtn.textContent = "Hacer otra pregunta a VIDA";
            askAnotherQuestionBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                             hover:bg-[var(--vida-module-btn-hover)] transition-colors shadow-sm`;
            askAnotherQuestionBtn.onclick = () => {
                addMessageToChat('user', askAnotherQuestionBtn.textContent);
                reset_chat_and_offer_suggestions();
            };
            suggestedQuestionsContainer.appendChild(askAnotherQuestionBtn);
        }

    </script>
</body>
</html>
