<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIDA - Asistente de Donación</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Roboto as requested -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- three.js for interactive background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Custom Styles and Animations -->
    <style>
        /* New Color Palette and Font from the design specification */
        :root {
            --vida-bg: #E3F2FD; /* Azul cielo claro */
            --vida-text-dark: #0D47A1; /* Azul oscuro médico */
            --vida-btn-green: #66BB6A; /* Verde esperanza suave */
            --vida-btn-green-hover: #43A047;
            --vida-text-secondary: #757575; /* Gris medio */
            --vida-bg-footer: #F5F5F5; /* Gris claro */
            --vida-chat-bot-bg: #F9F9F9; /* Gris claro para burbuja del bot */
            --vida-chat-user-bg: #E8F5E9; /* Verde muy claro para burbuja de usuario */
            --vida-btn-feedback: #4FC3F7; /* Azul cielo para feedback */
            --vida-suggest-btn-bg: #E0F2F7; /* Azul muy claro para botón de sugerencia */
            --vida-suggest-btn-hover: #B3E5FC; /* Azul más claro para hover */
            --vida-module-btn-bg: #E0F2F7; /* Color para botones de módulo */
            --vida-module-btn-hover: #B3E5FC; /* Color hover para botones de módulo */
            --vida-module-btn-text: #0D47A1; /* Color de texto para botones de módulo */
            --vida-quiz-btn-correct: #4CAF50; /* Verde para respuesta correcta */
            --vida-quiz-btn-incorrect: #F44336; /* Rojo para respuesta incorrecta */
            --vida-quiz-btn-disabled: #BDBDBD; /* Gris para botones deshabilitados */
        }

        body {
            font-family: 'Roboto', sans-serif;
            /* Fondo con degradado suave y tenue como el quiz */
            background-color: #f0f9ff;
            background-image: 
                radial-gradient(at 47% 33%, hsl(200.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 9% 62%, hsl(215.00, 80%, 80%) 0px, transparent 50%),
                radial-gradient(at 82% 65%, hsl(140.00, 80%, 80%) 0px, transparent 50%),
                radial-gradient(at 24% 88%, hsl(20.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 75% 8%, hsl(340.00, 80%, 85%) 0px, transparent 50%),
                radial-gradient(at 56% 33%, hsl(260.00, 80%, 85%) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
        }



        /* Canvas para partículas interactivas */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        /* Estilo especial para el título principal */
        .vida-main-title {
            color: #0F1B3C;
            font-weight: 900;
            letter-spacing: 0.02em;
            /* Sombra y destello elegante */
            text-shadow: 
                0 0 20px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(255, 255, 255, 0.6),
                0 2px 8px rgba(15, 27, 60, 0.4),
                0 4px 16px rgba(15, 27, 60, 0.2);
            filter: 
                drop-shadow(0 0 15px rgba(255, 255, 255, 0.7))
                drop-shadow(0 2px 8px rgba(15, 27, 60, 0.3));
            /* Animación sutil de resplandor */
            animation: titleGlow 3s ease-in-out infinite alternate;
        }

        @keyframes titleGlow {
            0% {
                text-shadow: 
                    0 0 20px rgba(255, 255, 255, 0.8),
                    0 0 40px rgba(255, 255, 255, 0.6),
                    0 2px 8px rgba(15, 27, 60, 0.4),
                    0 4px 16px rgba(15, 27, 60, 0.2);
            }
            100% {
                text-shadow: 
                    0 0 25px rgba(255, 255, 255, 0.9),
                    0 0 50px rgba(255, 255, 255, 0.7),
                    0 2px 8px rgba(15, 27, 60, 0.5),
                    0 4px 16px rgba(15, 27, 60, 0.3);
            }
        }
        /* Subtítulo con color y formato mejorado */
        .vida-main-subtitle {
            color: #0D1B2A;
            font-size: 1.35rem;
            font-weight: 500;
            letter-spacing: 0.01em;
            /* Sombra de texto para mejor contraste */
            text-shadow: 0 1px 4px rgba(255, 255, 255, 0.9), 0 2px 8px rgba(13, 27, 42, 0.25);
            /* Añadir un resplandor sutil */
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.7));
        }

        /* Estilos específicos para cada línea del subtítulo */
        .subtitle-line-1 {
            font-size: 1.4rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .subtitle-line-2 {
            font-size: 1.25rem;
            font-weight: 400;
            line-height: 1.6;
            opacity: 0.95;
        }

        .subtitle-line-1 .font-semibold,
        .subtitle-line-2 .font-semibold {
            font-weight: 700;
            color: #1A237E;
        }

        /* Banner hero principal */
        .vida-hero-banner {
            position: relative;
            padding: 0.75rem 0.75rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(255, 255, 255, 0.88) 50%, 
                rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 
                0 6px 20px rgba(13, 27, 42, 0.08),
                0 3px 10px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            max-width: 100%;
            margin: 0 auto;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        @media (min-width: 640px) {
            .vida-hero-banner {
                padding: 2rem 2rem;
                border-radius: 1.5rem;
                box-shadow: 
                    0 10px 35px rgba(13, 27, 42, 0.12),
                    0 5px 15px rgba(255, 255, 255, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
            }
        }

        @media (min-width: 1024px) {
            .vida-hero-banner {
                max-width: 42rem;
                margin: 0;
                padding: 2.5rem 2.5rem;
            }
        }

        .vida-hero-banner:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 40px rgba(26, 35, 126, 0.15),
                0 6px 20px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        /* Efecto decorativo en el banner */
        .vida-hero-banner::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(135deg, 
                rgba(26, 35, 126, 0.1) 0%, 
                rgba(13, 71, 161, 0.08) 25%, 
                rgba(25, 118, 210, 0.06) 50%, 
                rgba(13, 71, 161, 0.08) 75%, 
                rgba(26, 35, 126, 0.1) 100%);
            border-radius: 2rem;
            z-index: -1;
        }

        /* Fade-in animation for a smooth load */
        .fade-in-element {
            opacity: 0;
            animation: fadeIn 1s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Justify chat text */
        .chat-bubble-text {
            text-align: justify;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #FFFFFF; }
        .chat-messages::-webkit-scrollbar-thumb { background: #BDBDBD; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--vida-text-secondary); }

        /* Initially hide these screens/modals */
        #chat-screen, #about-modal, #feedback-modal, #privacy-modal { display: none; }
        
        /* Styles for radio buttons in feedback form */
        .feedback-radio-group label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        /* Styles for quiz question card */
        .quiz-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 1rem;
            text-align: center;
        }

        .quiz-buttons button {
            transition: all 0.2s;
        }

        /* Styling for the custom SVG robot */
        /* Base styles for the SVG robot to ensure consistent appearance */
        .robot-svg-icon { /* Class for the SVG element itself */
            width: 100%;
            height: 100%;
        }
        .robot-svg-icon .heart-icon {
            fill: #EF5350; /* Red heart */
        }
        .robot-svg-icon .head-shape, .robot-svg-icon .torso {
            fill: #FFFFFF; /* White parts */
            stroke: #D1D5DB; /* Light gray border */
            stroke-width: 2;
        }
        .robot-svg-icon .neck {
            fill: #90A4AE; /* Gray neck */
        }
        .robot-svg-icon .arm-left, .robot-svg-icon .arm-right {
            stroke: #42A5F5; /* Blue arms */
            stroke-width: 15;
            fill: none;
            stroke-linecap: round;
        }
        .robot-svg-icon .screen {
            fill: #1F2937; /* Dark screen */
            rx: 10;
        }
        .robot-svg-icon .eye {
            fill: #40C4FF; /* Light blue eyes */
        }
        .robot-svg-icon .smile {
            stroke: #40C4FF; /* Light blue smile */
            stroke-width: 1.5;
            fill: none;
            stroke-linecap: round;
        }

        /* Animations for the robot SVG */
        @keyframes float-animation {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes heart-beat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes typing-animation {
            0% { transform: translateY(0px); }
            25% { transform: translateY(-2px); }
            50% { transform: translateY(0px); }
            75% { transform: translateY(-2px); }
            100% { transform: translateY(0px); }
        }
        
        /* Apply animations to specific elements by ID or Class for different contexts */
        #main-robot-container svg { /* Target the SVG inside the main container */
            animation: float-animation 3s ease-in-out infinite;
        }
        /* Specific targeting for heart and head within message/typing indicator SVGs */
        .message-robot-avatar .heart-icon {
            animation: heart-beat 1.5s infinite;
        }
        .typing-indicator-robot .head {
            animation: typing-animation 0.7s infinite;
        }

        /* Fondo exclusivo para la pantalla de conversación del chatbot */
        #chat-screen {
            background: linear-gradient(135deg, #e0e7ff 0%, #f0fdfa 50%, #e3f2fd 100%);
        }

        /* Robot Circle Styles mejorados con glassmorphism */
        .robot-circle-bg {
            width: 420px;
            height: 420px;
            min-width: 320px;
            min-height: 320px;
            max-width: 450px;
            max-height: 450px;
            border-radius: 50%;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(255, 255, 255, 0.75) 50%, 
                rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 
                0 15px 45px rgba(13, 27, 42, 0.12), 
                0 8px 25px rgba(255, 255, 255, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: breathe 4s ease-in-out infinite;
        }

        .robot-circle-bg:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 
                0 20px 55px rgba(13, 27, 42, 0.15), 
                0 10px 30px rgba(255, 255, 255, 0.4),
                inset 0 2px 0 rgba(255, 255, 255, 0.9);
        }

        @media (max-width: 640px) {
            .robot-circle-bg {
                width: 240px;
                height: 240px;
                min-width: 200px;
                min-height: 200px;
                max-width: 260px;
                max-height: 260px;
            }
        }

        .robot-img-main {
            width: 115%;
            height: 115%;
            object-fit: contain;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            transition: all 0.4s ease;
        }

        /* Animación mejorada de respiración del robot */
        @keyframes enhancedBreathing {
            0% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            }
            50% { 
                transform: scale(1.02) rotate(0.5deg); 
                filter: drop-shadow(0 6px 24px rgba(76,175,80,0.15));
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 4px 16px rgba(76,175,80,0.10));
            }
        }

        #main-robot-container svg,
        #main-robot-container img {
            animation: enhancedBreathing 4s ease-in-out infinite;
        }

        /* Efectos de hover mejorados para botones */
        .enhanced-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .enhanced-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .enhanced-button:hover::before {
            left: 100%;
        }

        .enhanced-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.2);
        }

        /* Botones premium mejorados */
        .btn-primary-enhanced {
            background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
            border: none;
            min-width: 220px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .btn-secondary-enhanced {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            border: none;
            min-width: 220px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        /* Glassmorphism para cards/modales */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.2);
        }
        
        /* Clase específica para modales con mejor legibilidad */
        .modal-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px 0 rgba(31, 38, 135, 0.25);
        }

        /* Específico para móviles - manejo del teclado virtual */
        :root {
            --vh: 1vh;
        }
        
        @supports (-webkit-touch-callout: none) {
            #chat-screen {
                /* Usar viewport fijo para iOS */
                height: 100vh;
                height: calc(var(--vh, 1vh) * 100);
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
        }
        
        /* Mejoras para el chat en móviles */
        @media (max-width: 640px) {
            /* Solo prevenir el scroll cuando el chat está abierto */
            body.chat-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            html.chat-open {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
            }
            
            #chat-screen {
                /* Prevenir zoom en inputs en iOS */
                -webkit-text-size-adjust: 100%;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 100vh !important;
                height: calc(var(--vh, 1vh) * 100) !important;
                width: 100vw !important;
                overflow: hidden;
            }
            
            #chat-screen > div {
                height: 100vh !important;
                height: calc(var(--vh, 1vh) * 100) !important;
                max-height: 100vh !important;
                max-height: calc(var(--vh, 1vh) * 100) !important;
                display: flex;
                flex-direction: column;
            }
            
            #chat-input {
                /* Prevenir zoom en inputs */
                font-size: 16px !important;
                -webkit-appearance: none;
                appearance: none;
                border-radius: 25px;
                /* Prevenir el scroll automático al enfocar */
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
            
            /* Asegurar que el footer se mantenga visible */
            #chat-screen footer {
                position: relative;
                z-index: 10;
                flex-shrink: 0;
                bottom: 0;
            }
            
            /* Mejorar el scroll del contenedor de mensajes */
            #chat-container-wrapper {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* Prevenir el rebote del scroll */
                overscroll-behavior: contain;
            }
            
            /* Prevenir el zoom en toda la pantalla de chat */
            #chat-screen * {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }
        }
        
        /* Viewport dinámico para móviles modernos */
        @media (max-width: 640px) and (max-height: 800px) {
            #chat-screen .w-full.h-full {
                height: 100vh;
                height: 100dvh;
                min-height: 100vh;
                min-height: 100dvh;
            }
        }
    </style>
</head>
<body class="text-slate-800 antialiased">
    <canvas id="bg-canvas"></canvas>

    <!-- Welcome Screen -->
    <div id="welcome-screen" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="w-full p-4 sm:p-6 bg-transparent fade-in-element" style="animation-delay: 0.2s;">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-0.5 sm:space-x-2 lg:space-x-2">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 lg:w-14 lg:h-14 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center shadow-lg">
                        <!-- Heart Icon for VIDA logo -->
                        <svg class="h-4 w-4 sm:h-6 sm:w-6 lg:h-8 lg:w-8 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-16 w-auto sm:h-10 sm:w-auto lg:h-28 lg:w-auto object-contain max-w-[220px] sm:max-w-[140px] lg:max-w-[350px]" onerror="this.onerror=null;this.src='https://placehold.co/300x90/E3F2FD/0D47A1?text=VIDA';" />
                </div>
                <div class="flex items-center space-x-2 sm:space-x-3">
                    <!-- Privacy button -->
                    <button id="privacy-btn" class="text-[var(--vida-text-dark)] font-semibold py-1 px-2 sm:py-2 sm:px-4 text-xs sm:text-sm rounded-lg transition hover:bg-blue-200/50">Aviso de Privacidad</button>
                    <!-- About button -->
                    <button id="about-btn" class="px-2 py-1 sm:px-4 sm:py-2 text-xs sm:text-sm rounded-lg bg-[var(--vida-btn-green)] text-white font-semibold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] focus:ring-offset-2 enhanced-button">
                        ¿Qué hace VIDA?
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col lg:flex-row items-center justify-center container mx-auto px-4 py-6 sm:py-8 lg:py-8 text-center lg:text-left gap-6 sm:gap-8 lg:gap-12">
            <div class="lg:w-3/5 flex flex-col items-center lg:items-start space-y-4 sm:space-y-6">
                <!-- Banner principal con diseño elegante -->
                <div class="vida-hero-banner fade-in-element w-full" style="animation-delay: 0.3s;">
                    <h2 class="vida-main-title text-base sm:text-2xl md:text-3xl lg:text-4xl xl:text-5xl font-bold text-[var(--vida-text-dark)] fade-in-element leading-tight" style="animation-delay: 0.4s;">
                        Voz de Información y Donación Asistida
                    </h2>
                    <div class="vida-main-subtitle text-xs sm:text-base md:text-lg lg:text-xl mt-2 sm:mt-5 fade-in-element" style="animation-delay: 0.6s;">
                        <p class="subtitle-line-1 mb-1 sm:mb-3 text-center lg:text-left text-xs sm:text-base">
                            <span class="font-semibold">Tu aliado informativo</span> en momentos críticos
                        </p>
                        <p class="subtitle-line-2 text-center lg:text-left leading-relaxed text-xs sm:text-base">
                            Estoy aquí para ayudarte a tomar decisiones 
                            <span class="font-semibold">claras, humanas y fundamentadas</span>
                        </p>
                    </div>
                </div>
                
                <!-- Botones de acción debajo del banner, centrados con respecto al banner -->
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center items-center self-center w-full max-w-2xl fade-in-element lg:justify-start lg:self-start" style="animation-delay: 0.8s;">
                    <button id="start-chat-btn" class="btn-primary-enhanced bg-[var(--vida-btn-green)] text-white font-bold py-2 px-4 sm:py-4 sm:px-8 text-xs sm:text-base rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300 enhanced-button flex items-center justify-center gap-2 w-full sm:w-auto">
                        <svg class="h-3 w-3 sm:h-5 sm:w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4.913 2.658c2.075-.27 4.19-.408 6.337-.408 2.147 0 4.262.139 6.337.408 1.922.25 3.291 1.861 3.405 3.727a4.403 4.403 0 00-1.032-.211 50.89 50.89 0 00-8.42 0c-2.358.196-4.04 2.19-4.04 4.434v4.286a4.47 4.47 0 002.433 3.984L7.28 21.53A.75.75 0 016 21v-4.03a48.527 48.527 0 01-1.087-.128C2.905 16.58 1.5 14.833 1.5 12.862V6.638c0-1.97 1.405-3.718 3.413-3.979z"/>
                            <path d="M15.75 7.5c-1.376 0-2.739.057-4.086.169C10.124 7.797 9 9.103 9 10.609v4.285c0 1.507 1.128 2.814 2.67 2.94 1.243.102 2.5.157 3.768.165l2.782 2.781a.75.75 0 001.28-.53v-2.39l.33-.026c1.542-.125 2.67-1.433 2.67-2.940v-4.286c0-1.505-1.125-2.811-2.664-2.94A49.392 49.392 0 0015.75 7.5z"/>
                        </svg>
                        Iniciar conversación
                    </button>
                    <!-- New Quiz Module Button -->
                    <button id="start-quiz-btn" class="btn-secondary-enhanced bg-[var(--vida-btn-feedback)] text-white font-bold py-2 px-4 sm:py-4 sm:px-8 text-xs sm:text-base rounded-full shadow-lg hover:bg-blue-400 transition-all transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 flex items-center justify-center gap-2 enhanced-button w-full sm:w-auto">
                        <svg class="h-3 w-3 sm:h-5 sm:w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                        </svg>
                        ¿Qué tanto sabes sobre donar?
                    </button>
                </div>
            </div>
            
            <!-- Robot Image mejorado -->
            <div id="main-robot-container" class="lg:w-2/5 flex items-center justify-center lg:items-start lg:justify-start mt-6 sm:mt-8 lg:mt-[-2rem] lg:ml-[-3rem] fade-in-element" style="animation-delay: 1s;">
                <div class="robot-circle-bg">
                    <img src="robot.png" alt="Robot VIDA" class="robot-img-main" onerror="this.onerror=null;this.src='https://placehold.co/437x437/FFFFFF/FFFFFF?text=Robot';" />
                </div>
            </div>
        </main>

        <footer class="w-full py-1 px-0 sm:p-1 bg-[var(--vida-bg-footer)] fade-in-element" style="animation-delay: 1.2s;">
            <div class="container mx-auto max-w-xl lg:max-w-2xl px-4 sm:px-12 lg:px-16">
                <div class="flex flex-col items-center justify-center py-1 sm:py-2">
                    <p class="text-[10px] sm:text-base md:text-xs text-slate-700 font-medium mb-0 leading-tight max-w-xs sm:max-w-md lg:max-w-lg text-center">
                        VIDA es una herramienta informativa. No sustituye la atención médica.<br class="hidden sm:block">
                        <span class="block sm:inline">Versión piloto para donación.</span>
                    </p>
                    <a href="https://www.gob.mx/cenatra" target="_blank" class="text-[10px] sm:text-xs text-[var(--vida-btn-feedback)] underline font-semibold hover:text-[var(--vida-text-dark)] transition-colors block mt-0 text-center">
                        Ir a CENATRA
                    </a>
                </div>
            </div>
        </footer>
    </div>
    
    <button id="feedback-btn" class="fixed bottom-16 sm:bottom-5 left-5 bg-[var(--vida-btn-feedback)] text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:scale-105 transition-transform z-20 flex items-center gap-2 enhanced-button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.08-3.239A8.939 8.939 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.416 11.603a.75.75 0 00-.029.048l.029-.048zM5.022 13.013a.75.75 0 00.213.024l.028-.024z" clip-rule="evenodd" /></svg>
        Danos tu opinión
    </button>
    
    <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative max-h-[85vh] sm:max-h-[90vh] overflow-y-auto">
            <button id="close-about-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-2 sm:mb-4 pr-8">¿Qué hace VIDA?</h3>
            <div class="text-slate-700 text-justify space-y-2 sm:space-y-3 text-xs sm:text-base" style="text-align: justify;">
                <p>VIDA es un asistente conversacional creado para brindar orientación empática, clara y confiable sobre la donación de órganos, tejidos y sangre en México.</p>
                <p>Fue desarrollado como una herramienta informativa para acompañar a personas que tienen dudas, miedo o simplemente desean entender mejor cómo funciona la donación, ya sea como donadores voluntarios o como familiares que enfrentan una decisión en un momento difícil.</p>
                <p>VIDA no sustituye atención médica ni asesoría profesional directa, pero está diseñada para ayudarte a:</p>
                <ul class="list-disc pl-3 sm:pl-6 space-y-1 text-xs sm:text-base">
                    <li>Entender qué órganos, tejidos y componentes sanguíneos se pueden donar.</li>
                    <li>Saber quién puede ser donador y en qué momentos.</li>
                    <li>Desmitificar ideas falsas sobre la donación.</li>
                    <li>Reflexionar con libertad sobre el acto de donar.</li>
                    <li>Obtener enlaces seguros y oficiales para registrarte como donador voluntario o encontrar centros de donación.</li>
                </ul>
                <p>VIDA es una voz que informa sin juzgar, acompaña sin presionar, y cree que donar es un acto de amor y conciencia.</p>
            </div>
        </div>
    </div>
    
    <div id="privacy-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative max-h-[85vh] sm:max-h-[90vh] overflow-y-auto">
            <button id="close-privacy-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-2 sm:mb-4 pr-8">Aviso de Privacidad – VIDA</h3>
            <div class="text-slate-700 text-justify text-xs sm:text-base" style="text-align: justify;">
                <p class="mb-2 sm:mb-3">VIDA (Voz de Información y Donación Asistida) es una herramienta informativa que opera sin recopilar datos personales sensibles. No se almacenan nombres, ubicaciones, correos electrónicos ni respuestas específicas de los usuarios. Las conversaciones no son monitoreadas ni utilizadas para fines comerciales o de perfilamiento.</p>
                <p class="mb-2 sm:mb-3">El uso de esta plataforma es completamente anónimo y su único propósito es ofrecer orientación general sobre procesos de donación post mortem, con base en información pública y normativa mexicana vigente.</p>
                <p class="mb-2 sm:mb-3">VIDA no sustituye asesoría médica, psicológica ni legal. Si requiere atención médica o desea formalizar su voluntad de donar, debe acudir a las instancias oficiales correspondientes (CENATRA, IMSS, ISSSTE, etc.).</p>
                <p>Para cualquier comentario, puede escribir al desarrollador del proyecto a través del formulario de contacto disponible.</p>
            </div>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-3 sm:p-4 z-50">
        <div class="modal-card rounded-lg sm:rounded-2xl shadow-xl max-w-xs sm:max-w-lg w-full p-3 sm:p-8 relative overflow-hidden max-h-[85vh] sm:max-h-[90vh]">
            <div id="feedback-form-container" class="overflow-y-auto max-h-full">
                 <button id="close-feedback-modal-btn" class="absolute top-2 right-2 sm:top-4 sm:right-4 text-gray-500 hover:text-gray-800 z-10 bg-white rounded-full p-1 shadow-md">
                     <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
                <h3 class="text-base sm:text-2xl font-bold text-[var(--vida-text-dark)] mb-1 sm:mb-2 pr-8">Encuesta anónima de satisfacción – VIDA</h3>
                <p class="text-xs sm:text-sm text-gray-500 mb-4 sm:mb-6">Responde en menos de 1 minuto:</p>
                <form id="feedback-form">
                    <div class="space-y-3 sm:space-y-6">
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">1. ¿La información que recibiste fue clara y útil?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="clarity" value="si" class="mr-2" required> Sí</label>
                                <label><input type="radio" name="clarity" value="parcialmente" class="mr-2"> Parcialmente</label>
                                <label><input type="radio" name="clarity" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">2. ¿El lenguaje utilizado te pareció comprensible?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="language" value="si" class="mr-2" required> Sí</label>
                                <label><input type="radio" name="language" value="regular" class="mr-2"> Regular</label>
                                <label><input type="radio" name="language" value="dificil" class="mr-2"> Difícil de entender</label>
                            </div>
                        </div>
                         <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">3. ¿Te ayudó a resolver tus dudas sobre donación?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="solved_doubts" value="si" class="mr-2" required> Sí completamente</label>
                                <label><input type="radio" name="solved_doubts" value="algunas" class="mr-2"> Algunas</label>
                                <label><input type="radio" name="solved_doubts" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-700 mb-1 sm:mb-2 text-xs sm:text-base">4. ¿Recomendarías esta herramienta a otros usuarios?</p>
                            <div class="flex flex-col sm:flex-row sm:gap-4 feedback-radio-group text-xs sm:text-sm">
                                <label><input type="radio" name="recommend" value="si" class="mr-2" required> Sí</label>
                                <label><input type="radio" name="recommend" value="no" class="mr-2"> No</label>
                            </div>
                        </div>
                        <div>
                            <label for="comments" class="font-semibold text-gray-700 mb-1 sm:mb-2 block text-xs sm:text-base">Comentarios adicionales</label>
                            <textarea id="comments" name="comments" rows="2" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-feedback)] text-xs sm:text-sm"></textarea>
                        </div>
                    </div>
                    <div class="mt-4 sm:mt-8 text-right">
                        <button type="submit" class="bg-[var(--vida-btn-green)] text-white font-bold py-2 px-4 sm:px-6 rounded-lg shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colors text-xs sm:text-base">Enviar respuesta</button>
                    </div>
                </form>
            </div>
             <div id="feedback-thanks" class="hidden text-center">
                 <svg class="mx-auto h-12 w-12 sm:h-16 sm:w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="mt-2 sm:mt-4 text-lg sm:text-2xl font-bold text-[var(--vida-text-dark)]">¡Gracias!</h3>
                <p class="mt-1 sm:mt-2 text-gray-600 text-sm sm:text-base">Tu opinión nos importa y nos ayuda a mejorar VIDA.</p>
            </div>
        </div>
    </div>


    <div id="chat-screen" class="fixed inset-0 bg-slate-100 flex items-stretch justify-center p-0 sm:p-4 z-40 transition-opacity duration-300 opacity-0">
        <div class="w-full h-full sm:max-w-4xl sm:h-[90vh] bg-white sm:rounded-2xl shadow-2xl flex flex-col relative overflow-hidden">
            <header class="bg-white border-b border-gray-200 p-3 sm:p-4 sm:rounded-t-2xl flex items-center justify-between shadow-sm flex-shrink-0">
                 <div class="flex items-center space-x-1">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center mr-1">
                        <!-- Heart Icon for VIDA logo in chat header -->
                        <svg class="h-5 w-5 sm:h-7 sm:w-7 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <img src="Vidalogo.png" alt="VIDA Logo" class="h-10 sm:h-13 w-auto object-contain max-w-[80px] sm:max-w-[90px]" onerror="this.onerror=null;this.src='https://placehold.co/90x40/E3F2FD/0D47A1?text=VIDA';" />
                 </div>
                <button id="close-chat-btn" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full">
                     <svg class="h-5 w-5 sm:h-6 sm:w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <main class="flex-1 flex overflow-hidden min-h-0">
                <div id="chat-container-wrapper" class="flex-1 flex flex-col p-3 sm:p-4 lg:p-6 overflow-y-auto chat-messages">
                     <div id="chat-container" class="flex flex-col space-y-3 sm:space-y-4"></div>
                </div>
                <aside class="w-1/3 bg-slate-50 p-6 border-l border-slate-200 hidden lg:flex flex-col items-center justify-center">
                    <!-- chat-robot-avatar element: using the provided image for the large avatar -->
                    <div id="chat-robot-avatar-large" class="w-48 h-48 mb-4 rounded-full flex items-center justify-center shadow-lg overflow-hidden">
                        <img src="robot.png" alt="Robot VIDA" class="w-full h-full object-contain" onerror="this.onerror=null;this.src='https://placehold.co/192x192/FFFFFF/FFFFFF?text=Robot';" />
                    </div>
                    <div class="text-center">
                        <h3 class="font-bold text-lg text-[var(--vida-text-dark)]">Estoy para ayudarte</h3>
                        <p class="text-sm text-[var(--vida-text-secondary)] mt-1">Pregúntame sobre el proceso de donación de órganos y tejidos.</p>
                    </div>
                </aside>
            </main>
            <footer class="p-2 sm:p-3 bg-white border-t border-gray-200 sm:rounded-b-2xl flex-shrink-0">
                <div id="suggested-questions-container" class="flex flex-wrap gap-2 mb-2 sm:mb-3 hidden"></div>

                <form id="chat-form" class="flex items-center space-x-2 sm:space-x-3">
                    <button type="button" id="suggest-questions-btn" class="bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] rounded-full p-2 sm:p-2.5 
                                     hover:bg-[var(--vida-suggest-btn-hover)] transition-colors focus:outline-none focus:ring-4 focus:ring-blue-100 
                                     disabled:bg-gray-200 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0">
                        <svg class="h-4 w-4 sm:h-5 sm:w-5 text-yellow-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        <span id="suggest-button-text" class="ml-1 text-xs sm:text-sm font-semibold hidden sm:inline">Sugiere</span> </button>
                    <input type="text" id="chat-input" placeholder="Escribe tu pregunta aquí..." autocomplete="off" class="flex-1 w-full px-3 py-2 sm:px-4 sm:py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-[var(--vida-btn-green)] transition text-sm sm:text-base">
                    <button type="submit" class="bg-[var(--vida-btn-green)] text-white rounded-full p-2 sm:p-3 hover:bg-[var(--vida-btn-green-hover)] transition-transform transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-green-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatScreen = document.getElementById('chat-screen');
        const startChatBtn = document.getElementById('start-chat-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn'); 

        // --- Quiz Integration ---
        if (startQuizBtn) {
            startQuizBtn.addEventListener('click', () => {
                // Opción 1: Abrir quiz en nueva ventana
                // window.open('quiz.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                
                // Opción 2: Redirigir a la página del quiz
                window.location.href = 'quiz.html';
            });
        }

        // --- More DOM Elements ---
        const chatContainer = document.getElementById('chat-container');
        const chatContainerWrapper = document.getElementById('chat-container-wrapper');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const aboutBtn = document.getElementById('about-btn');
        const closeModalBtn = document.getElementById('close-about-modal-btn');
        const aboutModal = document.getElementById('about-modal');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const feedbackBtn = document.getElementById('feedback-btn');
        const feedbackModal = document.getElementById('feedback-modal');
        const closeFeedbackModalBtn = document.getElementById('close-feedback-modal-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const feedbackFormContainer = document.getElementById('feedback-form-container');
        const feedbackThanks = document.getElementById('feedback-thanks');
        const suggestQuestionsBtn = document.getElementById('suggest-questions-btn'); 
        const suggestedQuestionsContainer = document.getElementById('suggested-questions-container'); 
        const suggestButtonText = document.getElementById('suggest-button-text'); 
        const privacyBtn = document.getElementById('privacy-btn');
        const privacyModal = document.getElementById('privacy-modal');
        const closePrivacyModalBtn = document.getElementById('close-privacy-modal-btn');

        // --- State ---
        let chatHistory = [];
        let currentDonorPathStep = null;
        let currentQuizQuestionIndex = -1;
        let quizQuestions = [];

        // --- Module Content Definition ---
        const donorPathModule = {
            // The 'initial' step is now just a trigger. The conversation starts with 'introduction'.
            initial: {}, 
            introduction: {
                text: "¡Qué decisión tan valiosa estás considerando! Aquí te acompaño paso a paso en tu camino como donante.",
                buttons: [
                    { text: "Iniciar camino como donante", action: "donor_path_step1" },
                    { text: "Prefiero hacer una pregunta diferente", action: "reset_chat" }
                ]
            },
            step1: {
                text: "Para poder decidir, es importante que sepas qué significa donar. En México, se puede donar órganos y tejidos después de fallecer, ya sea por Muerte encefálica (cuando el cerebro deja de funcionar por completo) o por Paro cardíaco (cuando el corazón deja de latir y ya no se puede revivir). En ambos casos, la donación puede salvar vidas o mejorar la salud de muchas personas.",
                buttons: [
                    { text: "Sí, por favor", action: "donor_path_explain_muerte_encefalica" },
                    { text: "No, siguiente paso 👉", action: "donor_path_step2" }
                ]
            },
            explain_muerte_encefalica: {
                text: "La muerte encefálica es cuando el cerebro, que controla todo el cuerpo, deja de funcionar de forma total e irreversible. Esto se confirma con pruebas médicas rigurosas que demuestran que ya no hay actividad cerebral ni capacidad de respirar por sí mismo. Es el momento en que una persona es legal y médicamente declarada fallecida.",
                buttons: [
                    { text: "Entendido, siguiente paso 👉", action: "donor_path_step2" }
                ]
            },
            step2: {
                text: "Donar es una decisión personal, libre y voluntaria. Te invito a pensar: ¿Me gustaría ayudar a alguien más si ya no estoy aquí? ¿Cómo me sentiría si alguien que amo necesitara un órgano? No hay respuestas correctas. Lo importante es que lo pienses con el corazón. 💙",
                buttons: [
                    { text: "Estoy listo para el siguiente paso 👉", action: "donor_path_step3" },
                    { text: "Aún tengo dudas", action: "indecision_start" }
                ]
            },
            step3: {
                text: "Aunque tú quieras donar, en México tu familia debe autorizarlo en el hospital. Por eso, lo más importante es que hables con ellos y les digas tu deseo de donar. Puedes decir algo como: “Si algún día fallezco, quiero que donen mis órganos. Es mi decisión.”",
                buttons: [
                    { text: "Sí, muéstrame ejemplos", action: "donor_path_examples_family_talk" },
                    { text: "Siguiente paso 👉", action: "donor_path_step4" }
                ]
            },
            examples_family_talk: {
                text: "Aquí tienes algunas ideas para iniciar la conversación con tu familia: “Estuve pensando en la donación de órganos y quiero compartirles mi decisión. Si algo me pasara, me gustaría que mis órganos ayudaran a alguien más.” “Es un tema difícil, pero es importante para mí que sepan que quiero ser donante. Es un acto de generosidad que siento que es correcto.” “Investigué sobre la donación de órganos y me gustaría dejar claro que es mi deseo. Me siento tranquilo con esta decisión.”",
                buttons: [
                    { text: "Entendido, siguiente paso 👉", action: "donor_path_step4" }
                ]
            },
            step4: {
                text: "Además de hablar con tu familia, puedes dejar por escrito tu decisión de estas maneras: 1. Marcándolo en tu INE (si renovaste y pediste que aparezca). 2. En el portal del Centro Nacional de Trasplantes (CENATRA). 3. En una carta simple firmada. 4. O en tu testamento o voluntad anticipada (si aplica en tu estado).",
                buttons: [
                    { text: "Registrarme en CENATRA", action: "open_cenatra_link", link: "https://dv.cenatra.salud.gob.mx/registrar.php" },
                    { text: "Sí, enséñame un ejemplo de carta", action: "donor_path_example_carta" },
                    { text: "No, continuar 👉", action: "donor_path_step5" }
                ]
            },
            example_carta: {
                text: "Aquí tienes un ejemplo de una carta simple de voluntad anticipada para donación:\n\n\"[Tu Nombre Completo]\n[Tu Dirección]\n[Tu Ciudad, Estado, Fecha]\n\nA quien corresponda:\n\nPor medio de la presente, yo, [Tu Nombre Completo], con [Tipo de identificación y número, ej. INE 1234567890], declaro que, en caso de fallecimiento, es mi libre y voluntaria voluntad que mis órganos y tejidos aptos sean donados para trasplante, con el fin de salvar o mejorar la calidad de vida de otras personas. Esta decisión es informada y definitiva. Solicito a mis familiares y al personal médico respetar y facilitar este deseo.\n\nAtentamente,\n[Tu Firma]\n[Tu Nombre Completo]\n\nNota: Es recomendable tener testigos y/o notario, aunque una carta simple con tu firma es un inicio importante.\"",
                buttons: [
                    { text: "Entendido, continuar 👉", action: "donor_path_step5" }
                ]
            },
            step5: {
                text: "Donar es un acto que vale repetir. Recuérdales a tus seres queridos tu decisión cada tanto. Puedes también compartir tu voluntad en redes o por WhatsApp: “He decidido que quiero donar mis órganos si algún día muero. Es una forma de seguir ayudando. VIDA me ayudó a informarme.”",
                buttons: [
                    { text: "Compartir por WhatsApp", action: "share_whatsapp", shareText: "He decidido que quiero donar mis órganos si algún día muero. Es una forma de seguir ayudando. VIDA me ayudó a informarme." },
                    { text: "Finalizar camino 💚", action: "donor_path_cierre" }
                ]
            },
            cierre: {
                text: "¡Gracias por recorrer este camino conmigo! 🌱 Cada paso que das acerca a alguien más a vivir con esperanza. Tu decisión es un acto de amor y generosidad.",
                buttons: [
                    { text: "Ver más dudas frecuentes", action: "suggest_questions" }, 
                    { text: "Hablar con VIDA nuevamente", action: "reset_chat" }
                ]
            }
        };

        // --- Función para mostrar botones de módulo y asociar eventos ---
        function displayModuleButtons(buttons, handler) {
            suggestedQuestionsContainer.innerHTML = '';
            if (!buttons || !Array.isArray(buttons) || buttons.length === 0) {
                suggestedQuestionsContainer.classList.add('hidden');
                return;
            }
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.className = `px-3 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm m-1`;
                button.onclick = () => handler(btn.action, btn);
                suggestedQuestionsContainer.appendChild(button);
            });
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        // --- Quiz Configuration ---
        let quizTotalAnswered = 0; // Nuevo: cuenta total de preguntas respondidas
        let quizMaxQuestions = 20; // Máximo de preguntas por sesión
        let quizBlockSize = 5; // Tamaño del bloque

        // --- Module Functions ---
        function reset_chat_and_offer_suggestions() {
            chatHistory = [];
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            chatContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            addInitialBotMessage();
        }

        // --- Donor Path Module Functions ---
        async function displayDonorPathStep(stepKey) {
            const stepContent = donorPathModule[stepKey];
            if (!stepContent) {
                console.error("Invalid donor path step:", stepKey);
                await addBotMessageWithTyping("Lo siento, hubo un problema. Por favor, intenta de nuevo.");
                currentDonorPathStep = null;
                return;
            }
            await addBotMessageWithTyping(stepContent.text);
            displayModuleButtons(stepContent.buttons, handleDonorPathAction);
        }

        async function handleDonorPathAction(action, buttonData = {}) {
            addMessageToChat('user', buttonData.text || action);
            if (action.startsWith('donor_path_')) {
                currentDonorPathStep = action.replace('donor_path_', '');
                await displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'donor_path_initial') {
                currentDonorPathStep = 'introduction';
                await displayDonorPathStep(currentDonorPathStep);
            } else if (action === 'open_cenatra_link' && buttonData.link) {
                window.open(buttonData.link, '_blank');
                await addBotMessageWithTyping('Se abrió la página oficial de registro en una nueva pestaña.');
            } else if (action === 'share_whatsapp' && buttonData.shareText) {
                const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(buttonData.shareText)}`;
                window.open(whatsappUrl, '_blank');
                await addBotMessageWithTyping('Se abrió WhatsApp para que puedas compartir tu decisión.');
            } else if (action === 'reset_chat') {
                reset_chat_and_offer_suggestions();
            } else if (action === 'suggest_questions') {
                currentDonorPathStep = null;
                await generateSuggestedQuestions();
            }
        }

        // --- Instrucción simplificada para la IA ---
        const systemPrompt = `
        Eres "VIDA", un asistente virtual sobre donación de órganos, tejidos y sangre en México.

        **Reglas básicas:**
        - Responde de forma cálida, natural y conversacional. NUNCA como robot.
        - EVITA respuestas repetitivas. Varía tu lenguaje y estructura completamente.
        - PROHIBIDO usar palabras como "maravilloso", "increíble", "generoso" repetidamente.
        - Usa sinónimos y diferentes estructuras: "Me da gusto saber que...", "Qué bueno que hayas decidido...", "Te agradezco que compartas...", "Es valioso que quieras..."
        - Sé conciso, claro y empático. Usa lenguaje sencillo, sin tecnicismos.
        - No uses asteriscos. Puedes usar listas numeradas o guiones si es necesario.
        - Si detectas duelo o dolor, prioriza el apoyo emocional.
        - Solo responde sobre donación de órganos, tejidos y sangre.
        - Si está fuera de tema: "Lo siento, solo puedo ayudarte con preguntas sobre donación de órganos, tejidos o sangre."

        **IMPORTANTE - Detección de intención de donante:**
        Si el usuario expresa claramente que quiere ser donante (frases como "quiero ser donante", "me interesa donar"), NO incluyas botones automáticos.
        En su lugar, pregunta naturalmente qué específicamente le interesa saber.
        
        Responde siempre de manera natural, empática y sin sonar robótico.
        - Si hay que explicar algo complejo, hazlo con ejemplos sencillos y sin tecnicismos.
        - No muestres cifras, nombres de leyes o documentos técnicos a menos que el usuario lo solicite explícitamente.
        - Las respuestas a preguntas sugeridas deben ser breves, claras y fáciles de entender.
        - Evita explicaciones largas o detalladas a menos que el usuario lo pida después (por ejemplo: "quiero saber más", "explícame mejor", "dame más información").
        - Usa un tono conversacional y cercano, como si hablaras con alguien en persona.
        - No uses palabras médicas ni tecnicismos. Explica todo con ejemplos sencillos si es necesario.
        - Organiza las respuestas en párrafos cortos o listas claras, si el tema lo requiere.
        - No repitas la pregunta en la respuesta. Ve directo al punto, con calidez y claridad.
        - Si el tema es delicado (por ejemplo: muerte, duelo, donación familiar), muestra empatía desde la primera línea.
        - Termina con disposición a continuar: “¿Quieres que te cuente más?”, “Si quieres, te explico cómo sigue”, “Estoy aquí si te surgen más dudas”.
        - Nunca des toda la información desde el inicio. Deja espacio para que el usuario guíe la profundidad.  
        - Evita sonar académico o institucional. Siempre habla como si estuvieras ayudando a alguien con dudas reales.
        - Siempre responde con base en el sentido general del mensaje, no solo en las palabras exactas.
        - Si detectas que el usuario está confundido o mezclando conceptos (por ejemplo: muerte cerebral con coma), aclara suavemente sin corregir de forma directa.
        - Si el usuario hace varias preguntas a la vez, responde primero lo más relevante o urgente, y luego ofrece continuar: "Puedo ayudarte con eso también. ¿Quieres que sigamos paso a paso?"
        - Si hay ambigüedad, utiliza preguntas abiertas para precisar: "¿Podrías contarme un poco más sobre eso?" o "¿Te refieres a donar órganos después de fallecer o en vida?"
        - Usa el historial de la conversación para responder con coherencia, retomando términos que ya se usaron (por ejemplo: si dijo “mi mamá”, no cambies a “su familiar”).
        - Si el usuario cambia de tema, adapta la conversación de forma natural y cálida, sin forzar el regreso al tema anterior.
        - Nunca repitas literalmente la pregunta del usuario como forma de respuesta. Procesa, interpreta y responde con lenguaje humano.
        - Cuando sea posible, anticipa lo que puede necesitar el usuario (por ejemplo: si pregunta sobre donar, sugiere cómo registrarse o qué órganos se pueden donar).
        - Si el usuario hace una pregunta muy general (“¿qué es donar?”), comienza con una explicación simple y ofrece ampliar: "Donar es dar algo que puede ayudar a otra persona. En este caso, se trata de donar órganos o tejidos después de fallecer. ¿Quieres saber cómo funciona?"

        **Ámbito Temático (Permitido):**
        Solo responde a preguntas relacionadas con:
        - Qué es la muerte encefálica y su diagnóstico.
        - Qué es la donación cuando el corazón ha dejado de latir y qué implica.
        - Criterios para confirmar que una persona ha fallecido (ya sea por muerte cerebral o cuando el corazón deja de latir).
        - Requisitos legales para donar órganos o tejidos después de fallecer.
        - Qué órganos o tejidos pueden recuperarse después de que una persona ha fallecido (ya sea por muerte cerebral o cuando el corazón deja de latir).
        - Cuánto tiempo hay para recuperar órganos o tejidos después de que una persona ha fallecido.
        - Pasos que el personal de salud debe seguir para activar un proceso de donación.
        - Cómo informar y acompañar a la familia de la persona que podría ser donante.
        - Información relevante de las normas oficiales de salud en México (NOM-011-SSA3-2014) o el Centro Nacional de Trasplantes (CENATRA).
        - Información clara y concisa sobre la donación de sangre: requisitos, proceso, beneficios y recomendaciones generales.
        - Mitos y realidades sobre la donación de órganos y tejidos (por ejemplo: si pueden quitar órganos antes de morir, si afecta el cuerpo para el funeral, si solo los ricos reciben órganos, si la religión lo permite, si la donación es segura y está regulada).
        - Proceso y transparencia en la donación: cómo se garantiza que la donación es ética y legal, cómo se decide quién recibe los órganos, controles para evitar el tráfico de órganos.
        - Miedos emocionales y psicológicos: temor a la muerte, miedo a no ser atendido en el hospital por ser donante, ansiedad sobre el destino de los órganos y el respeto al cuerpo.
        - Aspectos culturales y religiosos: posturas de diferentes religiones sobre la donación, cómo abordar el tema en familias con creencias diversas.
        - Impacto social y testimonios: historias de personas que han donado o recibido órganos, beneficios para la sociedad y para las familias donantes.
        - Donación en vida (sangre, médula ósea, riñón): requisitos, proceso, seguridad y miedos frecuentes.
        - Derechos y protección del donante y su familia: qué dice la ley sobre la voluntad del donante, qué apoyo reciben las familias donantes.
        - Información sobre el registro de donadores: cómo registrarse, qué implica y si se puede cambiar de opinión después de registrarse.
        - Perfil del donante ideal y limitaciones médicas: quién puede donar y bajo qué condiciones.
        - Errores comunes del público al interpretar la muerte encefálica: diferencias con coma y estado vegetativo.
        - Protección de la confidencialidad del donante y del receptor: cómo se resguarda la identidad y privacidad.
        - Qué sucede si una persona fallece sin haber dejado su voluntad explícita: rol de la familia y marco legal aplicable.
        - Registro nacional de donadores: interoperabilidad con expedientes clínicos y utilidad práctica.
        - Qué hacen los hospitales que no cuentan con programa de trasplantes: protocolos ante un potencial donante.
        - Donación cruzada de órganos (por ejemplo, riñón entre familiares no compatibles): fundamentos y situación legal en México.
        - Rechazo de órganos trasplantados: causas, consecuencias y medidas para prevenirlo.
        - Innovaciones y futuro en trasplantes: bioimpresión 3D, órganos artificiales y avances científicos recientes.
        - Ética médica en la donación: cómo se evita el conflicto de interés en la atención de pacientes donantes.
        - Qué ocurre con el cuerpo tras la extracción de órganos: respeto, cuidados estéticos y posibilidad de velorio.
        - Cómo convertirse en promotor comunitario de la donación: acciones de voluntariado e impacto social.
        - Impacto económico de la donación y trasplante: beneficios para el sistema de salud y las familias.
        - No siempre utilizar estoy aqui para ayudar, ya que puede sonar repetitivo. Usa frases como "Estoy aquí para informarte" o "Puedo guiarte en esto", pero que varien y solo se ocupen cuando sea necesario en la conversacion, usa la IA para hacer respuestas acorde y naturales.


        **Temas Fuera de Alcance (No Permitidos):**
        Si una pregunta no está en el ámbito permitido, responde exactamente con:
        "Lo siento, solo puedo ayudarte con preguntas sobre donación de órganos, tejidos o sangre."
        Esto incluye: diagnósticos médicos no relacionados, casos personales específicos, trámites hospitalarios individuales, opiniones religiosas/políticas/éticas que no estén en el marco normativo, temas legales no cubiertos por normas de salud.

        **Comportamiento y Tono (Crucial):**
        - Lenguaje claro y accesible: Sé concreto, conciso y fácil de entender para el público general. Evita cualquier tipo de jerga médica. Si por alguna razón se necesita un término clínico, explícalo inmediatamente con palabras sencillas y cotidianas. No uses asteriscos ni viñetas. Puedes usar párrafos cortos o listas numeradas (1. 2. 3. o guiones -) para organizar la información.
        - Respuestas concisas y elaboración opcional: Tus respuestas iniciales deben ser directas y al punto. Si el usuario pide "más información", "detalles" o "quiero saber más", puedes expandir la explicación de manera clara.
        - Coherencia conversacional y comprensión del contexto:
            - Siempre recuerda y respeta el hilo de la conversación. Considera el contexto de lo que el usuario ha mencionado antes, especialmente en temas emocionales, decisiones familiares o seguimiento de dudas.
            - Al responder, inicia reconociendo el tema previo para mantener la fluidez (ej. "Gracias por retomar el tema sobre...", "Entiendo que seguimos hablando del caso de tu familiar...", "Retomando lo que me comentaste sobre la muerte encefálica...").
            - Responde directamente a lo ya mencionado, sin cambiar de tema abruptamente ni repetir información.
            - En temas sensibles, refuerza la continuidad emocional: "Sé que esta situación no es fácil, y agradezco que sigas compartiendo conmigo. Estoy contigo paso a paso, retomando cada parte según lo que vayas necesitando."
            - Si no comprendes el contexto con claridad o la pregunta es ambigua, pide aclaración amablemente: "¿Podrías contarme un poco más para darte la mejor respuesta? Por ejemplo, ¿te refieres a la donación de órganos después de fallecer o en vida?"
        - Evita respuestas cerradas o limitadas: Nunca digas "no puedo ayudarte" o "no entiendo". Siempre reorienta la conversación con calidez hacia lo que sí puedes explicar: "Ese tema no lo tengo disponible, pero sí puedo ayudarte a entender cómo es el proceso de donación de órganos, tejidos o sangre. ¿Te interesa saber cómo se confirma la muerte cerebral o cómo es la donación de sangre?"
        - Donación = Después de fallecer (Contexto Principal): Cuando el usuario pregunte "Quiero donar" o "Cómo dono", asume por defecto que se refiere a donación de órganos y tejidos después de que una persona ha fallecido. Responde: "Gracias por tu interés. Esta app está centrada en la donación de órganos y tejidos después de que una persona ha fallecido. ¿Quieres saber cómo puedes manifestar tu voluntad como donante? Si te interesa la donación de sangre, también puedo orientarte."
        - Priorización del bienestar emocional (modo tanatológico suave):
            - Si el usuario expresa angustia, pérdida reciente, confusión o miedo (ej. "Mi mamá acaba de morir", "estoy devastado", "no sé qué hacer"), suspende explicaciones técnicas.
            - Primero ofrece contención emocional básica: "Lamento profundamente tu pérdida. Entiendo que este es un momento de mucho dolor y confusión. Soy VIDA, y estoy aquí para brindarte información clara y respetuosa sobre la donación de órganos y tejidos, lo cual puede ser una opción de esperanza en momentos así. Estoy aquí para explicarte todo lo que necesites saber al respecto."
            - Valida sus emociones: "Tus emociones son válidas. Comprendo que este momento es abrumador. Mi propósito es ayudarte a entender cómo la donación puede ser un acto de generosidad que transforma vidas, si esto es algo que te interesa explorar ahora."
            - Ofrece información solo si el usuario da permiso, sin presionar: "Si en algún momento deseas saber más sobre qué significa donar, puedo explicártelo."
            - Sugiere profesionales: "Si sientes que necesitas un apoyo más profundo, considera hablar con un tanatólogo o psicólogo. Ellos pueden ofrecerte herramientas valiosas en este camino."
            - Cierra con humanidad, enfocando sutilmente a la donación: "Gracias por confiarme este momento. Sé que es un proceso doloroso y tu sentir es muy valioso. Si en algún futuro, cuando te sientas listo, deseas explorar más sobre cómo la donación puede brindar esperanza, recuerda que aquí estaré para informarte."
            - Sé paciente si el usuario repite o cambia de opinión: nunca corrijas, juzgues ni señales contradicciones. Solo adapta la respuesta con calidez y sin confrontar.
            - Usa frases de acompañamiento incluso si el usuario no expresa dolor directamente, pero el tema lo sugiere: "Gracias por estar aquí. Hablar de esto no es fácil, pero hacerlo puede traer claridad y paz."
        - Si el usuario comparte una historia personal, valida su experiencia antes de seguir con la información.
        - Siempre adapta el tono según el tipo de usuario: si es joven, mayor, familiar o paciente, responde de forma empática y cercana, sin caer en infantilización ni tecnicismos.
        - Nunca asumas género ni relación familiar sin que el usuario lo mencione. Usa términos neutros como "persona fallecida", "ser querido", "familiar", "donante", "paciente".
        - Evita frases que puedan sentirse frías o clínicas. Prefiere expresiones como: “gracias por confiar en mí”, “aquí estoy contigo”, “te acompaño en esta duda”.

        **Fomento de la Cultura de Donación:**
        - Refuerza el valor social y humano de la donación sin imponerla: "Donar órganos después de fallecer es un acto de generosidad. En México, miles de personas esperan una segunda oportunidad gracias a una donación. Pensar en esto ya es un primer paso."
        - Muestra el impacto positivo (cifras reales si se piden). Nunca juzgues a quien no decide donar.
        - Finalizaciones humanas: Al cerrar, despídete con gratitud y disposición a acompañar más tarde.
        -Valida las emociones del usuario: “Es normal tener dudas o miedo. Hablar de la muerte no es fácil, pero hacerlo puede abrir caminos de esperanza.”
        - Evita frases que presionen o generen culpa. Prefiere: “Tú decides si quieres ser donante. Yo estoy aquí para ayudarte a conocer más.”
        - Usa lenguaje positivo y compasivo: evita tecnicismos y habla desde la empatía (“personas que esperan un trasplante” en vez de “pacientes terminales”).
        - Si el usuario expresa interés, puedes decir: “Gracias por considerar esta decisión tan generosa. Si quieres, te explico cómo registrarte como donante.”
        - Si el usuario dice que no desea donar, responde con respeto: “Gracias por compartirlo. Estoy aquí para cualquier otra duda que tengas.”
        - Puedes ofrecer una historia real de esperanza si el usuario lo permite: “¿Te gustaría conocer una historia de alguien que recibió un trasplante y volvió a vivir plenamente?”
        - Evita respuestas robóticas al cerrar. Usa finales como: “Gracias por tu tiempo. Si más adelante quieres hablar de esto, aquí estaré”, o “Fue un gusto platicar contigo, te mando un saludo cálido.”
        `;

        // --- Utilidad para extraer JSON robusto de texto (solo para quiz) ---
        function extractFirstJSONArray(text) {
            // Busca el primer bloque que parece un array JSON
            const arrayRegex = /\[\s*{[\s\S]*?}\s*\]/g;
            const match = text.match(arrayRegex);
            if (match) {
                try {
                    return JSON.parse(match[0]);
                } catch (e) {
                    // Si falla, intenta limpiar comas finales o errores comunes
                    let cleaned = match[0].replace(/,\s*]/g, "]");
                    try {
                        return JSON.parse(cleaned);
                    } catch (e2) {
                        return null;
                    }
                }
            }
            return null;
        }

        // --- UI Functions ---
        const showChat = () => {
            welcomeScreen.style.display = 'none';
            chatScreen.style.display = 'flex';
            setTimeout(() => chatScreen.classList.add('opacity-100'), 50);
            
            // Agregar clase para prevenir scroll del body en móviles
            if (window.innerWidth <= 640) {
                document.body.classList.add('chat-open');
                document.documentElement.classList.add('chat-open');
            }
            
            // Agregar listener para manejar el cambio de orientación
            window.addEventListener('orientationchange', handleOrientationChange);
            window.addEventListener('resize', handleViewportChange);
        };
        
        const hideChat = () => {
            chatScreen.classList.remove('opacity-100');
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';
            currentDonorPathStep = null;
            currentQuizQuestionIndex = -1;
            quizQuestions = [];
            
            // Restaurar el scroll del body
            document.body.classList.remove('chat-open');
            document.documentElement.classList.remove('chat-open');
            
            // Remover listeners
            window.removeEventListener('orientationchange', handleOrientationChange);
            window.removeEventListener('resize', handleViewportChange);
            
            setTimeout(() => { chatScreen.style.display = 'none'; welcomeScreen.style.display = 'flex'; }, 300);
        };
        
        // Función para manejar cambios de orientación
        const handleOrientationChange = () => {
            setTimeout(() => {
                if (chatScreen.style.display === 'flex') {
                    // Forzar recálculo del viewport
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                    
                    // Scroll al último mensaje
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }
            }, 100);
        };
        
        // Función para manejar cambios de viewport (teclado)
        const handleViewportChange = () => {
            if (window.innerWidth <= 640 && chatScreen.style.display === 'flex') {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Mantener el scroll en el último mensaje cuando aparece/desaparece el teclado
                setTimeout(() => {
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }, 150);
            }
        };
        
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        // --- Event Listeners ---
        startChatBtn.addEventListener('click', () => {
            window.location.href = 'chat.html';
        });

        closeChatBtn.addEventListener('click', hideChat);
        
        aboutBtn.addEventListener('click', () => openModal(aboutModal));
        closeModalBtn.addEventListener('click', () => closeModal(aboutModal));
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) closeModal(aboutModal);
        });
        
        privacyBtn.addEventListener('click', () => privacyModal.style.display = 'flex');
        closePrivacyModalBtn.addEventListener('click', () => privacyModal.style.display = 'none');
        privacyModal.addEventListener('click', (e) => {
            if (e.target === privacyModal) privacyModal.style.display = 'none';
        });
        
        feedbackBtn.addEventListener('click', () => openModal(feedbackModal));
        closeFeedbackModalBtn.addEventListener('click', () => closeModal(feedbackModal));
        feedbackModal.addEventListener('click', (e) => {
             if (e.target === feedbackModal) closeModal(feedbackModal);
        });

        suggestQuestionsBtn.addEventListener('click', async () => {
            await generateSuggestedQuestions();
        });

        // Función para mapear valores del formulario a los valores exactos de Google Forms
        function mapFormValue(fieldName, value) {
            if (!value) return '';
            
            const mappings = {
                'clarity': {
                    'si': 'Si',
                    'parcialmente': 'Parcialmente', 
                    'no': 'No'
                },
                'language': {
                    'si': 'Si',
                    'regular': 'Regular',
                    'dificil': 'Difícil de entender'
                },
                'solved_doubts': {
                    'si': 'Si completamente',
                    'algunas': 'Algunas',
                    'no': 'No'
                },
                'recommend': {
                    'si': 'Si',
                    'no': 'No'
                }
            };
            
            const mapped = mappings[fieldName] && mappings[fieldName][value] 
                ? mappings[fieldName][value] 
                : value;
            
            console.log(`Mapeo ${fieldName}: "${value}" → "${mapped}"`);
            return mapped;
        }

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const formData = new FormData(form);
            
            // Deshabilitar botón y mostrar estado de carga
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';
            
            try {
                // Crear iframe oculto para enviar el formulario
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.name = 'hidden-form-iframe';
                document.body.appendChild(iframe);
                
                // URL actualizada con tu Google Form
                const googleFormUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfVcPvKM2TK63V-uT6JbQtbHrrg_OujPu__5jiowpDavE4p0A/formResponse';
                
                // Crear formulario temporal
                const tempForm = document.createElement('form');
                tempForm.action = googleFormUrl;
                tempForm.method = 'POST';
                tempForm.target = 'hidden-form-iframe';
                
                // Agregar campos al formulario temporal
                const fields = {
                    'entry.1429993267': mapFormValue('clarity', formData.get('clarity')),
                    'entry.962169197': mapFormValue('language', formData.get('language')),
                    'entry.2266276': mapFormValue('solved_doubts', formData.get('solved_doubts')),
                    'entry.1344114409': mapFormValue('recommend', formData.get('recommend')),
                    'entry.287412987': formData.get('comments') || ''
                };
                
                // Debug: ver qué valores estamos enviando
                console.log('Valores enviados:', {
                    clarity: formData.get('clarity') + ' → ' + mapFormValue('clarity', formData.get('clarity')),
                    language: formData.get('language') + ' → ' + mapFormValue('language', formData.get('language')),
                    solved_doubts: formData.get('solved_doubts') + ' → ' + mapFormValue('solved_doubts', formData.get('solved_doubts')),
                    recommend: formData.get('recommend') + ' → ' + mapFormValue('recommend', formData.get('recommend')),
                    comments: formData.get('comments')
                });
                
                Object.keys(fields).forEach(key => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    tempForm.appendChild(input);
                });
                
                // Agregar al DOM y enviar
                document.body.appendChild(tempForm);
                tempForm.submit();
                
                // Limpiar después de un momento
                setTimeout(() => {
                    document.body.removeChild(tempForm);
                    document.body.removeChild(iframe);
                }, 1000);
                
                // Mostrar mensaje de éxito
                feedbackFormContainer.style.display = 'none';
                feedbackThanks.classList.remove('hidden');
                
                // Restaurar formulario después de 2.5 segundos
                setTimeout(() => {
                    feedbackThanks.classList.add('hidden');
                    feedbackFormContainer.style.display = '';
                    closeModal(feedbackModal);
                    form.reset();
                    submitButton.disabled = false;
                    submitButton.textContent = 'Enviar respuesta';
                }, 2500);
                
            } catch (error) {
                console.error('Error enviando feedback:', error);
                
                // Mostrar mensaje de error
                alert('Hubo un problema al enviar tu feedback. Por favor, intenta de nuevo.');
                
                // Restaurar botón
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar respuesta';
            }
        });

        // --- Event Listeners específicos para móviles ---
        // Prevenir zoom en input cuando se enfoca
        chatInput.addEventListener('touchstart', (e) => {
            if (window.innerWidth <= 640) {
                // Asegurar que el input tenga el tamaño correcto para prevenir zoom
                if (chatInput.style.fontSize !== '16px') {
                    chatInput.style.fontSize = '16px';
                }
            }
        });
        
        // Manejar cuando aparece/desaparece el teclado
        chatInput.addEventListener('focus', () => {
            if (window.innerWidth <= 640) {
                setTimeout(() => {
                    // Scroll al final cuando se enfoca el input
                    if (chatContainerWrapper) {
                        chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                    }
                }, 300); // Esperar a que aparezca el teclado
            }
        });
        
        chatInput.addEventListener('blur', () => {
            if (window.innerWidth <= 640) {
                setTimeout(() => {
                    // Recalcular viewport cuando se oculta el teclado
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                }, 300);
            }
        });

        // --- Main Chat Form Handler with AI Integration ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            // 1. Si está activo el quiz, solo permite botones
            if (currentQuizQuestionIndex !== -1) {
                addMessageToChat('user', userMessage);
                chatInput.value = '';
                addMessageToChat('bot', "Por favor, usa los botones para interactuar con el quiz.");
                return;
            }

            // 2. Agrega el mensaje del usuario al chat
            addMessageToChat('user', userMessage);
            chatInput.value = '';
            suggestedQuestionsContainer.classList.add('hidden');
            suggestedQuestionsContainer.innerHTML = '';

            // 2.1. Detección directa de frases clave - pero ahora con respuesta natural primero
            const userMessageLower = userMessage.toLowerCase();
            if (userMessageLower.includes('quiero ser donante') || 
                userMessageLower.includes('como puedo donar') || 
                userMessageLower.includes('me interesa donar') || 
                userMessageLower.includes('ser donante')) {
                
                // Responder primero de manera natural con IA
                await handleDonorIntentWithAI(userMessage);
                return;
            }
            
            // Detección específica para cuando piden guía paso a paso
            if (userMessageLower.includes('mi camino como donador') || 
                userMessageLower.includes('camino como donante') ||
                userMessageLower.includes('guíame paso a paso') ||
                userMessageLower.includes('acompañame') ||
                userMessageLower.includes('paso a paso')) {
                
                currentDonorPathStep = 'introduction';
                displayDonorPathStep(currentDonorPathStep);
                return;
            }

            // 3. Para todo lo demás, usar respuesta natural de la IA sin módulos extra
            await getBotResponse(userMessage, systemPrompt);
        });

        // --- AI-Enhanced Module Functions (Solo para Donor Path) ---
        async function handleDonorIntentWithAI(userMessage) {
            const donorIntentPrompt = `
            El usuario acaba de expresar interés en ser donante de órganos. Su mensaje fue: "${userMessage}"
            
            Como VIDA, responde de manera cálida y natural a su interés. Tu respuesta debe:
            - Reconocer su decisión de forma variada y auténtica (evita palabras como "maravilloso", "generoso" que suenan repetitivas)
            - Ser empática pero conversacional, como si hablaras con un amigo cercano
            - Usar lenguaje natural y variado - no formulaico
            - Hacer que se sienta escuchado y comprendido
            - Terminar preguntando qué le gustaría saber específicamente o si tiene alguna duda particular
            - NO ofrecer múltiples opciones ni mencionar "guías paso a paso"
            
            Ejemplos de inicios variados: "Me da mucho gusto saber que...", "Qué bueno que hayas tomado...", "Te agradezco que compartas...", "Es valioso que quieras..."
            
            Responde como una persona real y empática, no como un sistema.
            `;

            await getBotResponse(donorIntentPrompt, systemPrompt + "\n\nResponde de forma completamente natural y humana. NO ofrezcas botones ni opciones múltiples. Deja que la conversación fluya naturalmente preguntando qué específicamente le interesa saber.");
            
            // Después de la respuesta natural, ofrecer sutilmente la opción de guía
            setTimeout(() => {
                suggestedQuestionsContainer.innerHTML = '';
                const guideButton = document.createElement('button');
                guideButton.textContent = "¿Te gustaría que te acompañe paso a paso?";
                guideButton.className = `px-4 py-2 rounded-lg bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-text-dark)] text-sm font-medium 
                                       hover:bg-[var(--vida-suggest-btn-hover)] transition-colores shadow-sm opacity-75`;
                guideButton.onclick = () => {
                    addMessageToChat('user', guideButton.textContent);
                    suggestedQuestionsContainer.classList.add('hidden');
                    suggestedQuestionsContainer.innerHTML = '';
                    currentDonorPathStep = 'introduction';
                    displayDonorPathStep(currentDonorPathStep);
                };
                suggestedQuestionsContainer.appendChild(guideButton);
                suggestedQuestionsContainer.classList.remove('hidden');
            }, 2000); // Aparece después de 2 segundos para que se sienta natural
        }

        // --- Removed: Automatic button display functions ---
        // La conversación ahora fluye naturalmente sin botones automáticos
        
        async function addInitialBotMessage() {
            if (chatHistory.length === 0) {
                await addBotMessageWithTyping('Hola, soy VIDA. Estoy aquí para ofrecerte información clara y respetuosa sobre la donación de órganos y tejidos ¿En qué puedo ayudarte hoy?');
            }
        }
        
        function addMessageToChat(sender, text) {
            chatHistory.push({ role: sender === 'bot' ? 'assistant' : 'user', content: text });
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-end gap-2 max-w-lg lg:max-w-xl ${sender === 'user' ? 'self-end' : 'self-start'}`;
            
            const textContent = text.replace(/\n/g, '<br>');

            if (sender === 'user') {
                messageWrapper.innerHTML = `<div class="order-1 bg-[var(--vida-chat-user-bg)] text-slate-800 rounded-2xl rounded-br-none px-4 py-3 shadow-sm chat-bubble-text">${textContent}</div>`;
            } else {
                const botAvatarDiv = document.createElement('div');
                botAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 message-robot-avatar overflow-hidden";
                botAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                const textBubbleDiv = document.createElement('div');
                textBubbleDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm chat-bubble-text";
                textBubbleDiv.innerHTML = textContent;

                messageWrapper.appendChild(botAvatarDiv);
                messageWrapper.appendChild(textBubbleDiv);
            }
            
            chatContainer.appendChild(messageWrapper);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function showTypingIndicator(show) {
            let typingIndicator = document.getElementById('typing-indicator');
            if (show) {
                if (!typingIndicator) {
                    typingIndicator = document.createElement('div');
                    typingIndicator.id = 'typing-indicator';
                    typingIndicator.className = 'flex items-end gap-2 self-start typing-indicator-robot';
                    
                    const robotAvatarDiv = document.createElement('div');
                    robotAvatarDiv.className = "w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 typing-indicator-robot overflow-hidden";
                    robotAvatarDiv.innerHTML = '<img src="robotcara.png" alt="Robot VIDA" class="w-10 h-10 object-contain" onerror="this.onerror=null;this.src=\'https://placehold.co/40x40/0D47A1/FFFFFF?text=V\';" />';

                    const typingDotsDiv = document.createElement('div');
                    typingDotsDiv.className = "bg-[var(--vida-chat-bot-bg)] text-slate-800 rounded-2xl rounded-bl-none px-4 py-3 shadow-sm";
                    typingDotsDiv.innerHTML = `
                        <div class="flex items-center space-x-1.5">
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.3s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: -0.15s;"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></span>
                        </div>`;

                    typingIndicator.appendChild(robotAvatarDiv);
                    typingIndicator.appendChild(typingDotsDiv);
                    chatContainer.appendChild(typingIndicator);
                    chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
                }
            } else {
                if (typingIndicator) typingIndicator.remove();
            }
        }
        
        // Función para agregar mensajes del bot con efecto de escritura
        async function addBotMessageWithTyping(text, delay = 1500) {
            // Mostrar indicador de escritura
            showTypingIndicator(true);
            
            // Esperar el tiempo de delay para simular que está escribiendo
            await new Promise(resolve => setTimeout(resolve, delay));
            
            // Ocultar indicador y mostrar mensaje
            showTypingIndicator(false);
            addMessageToChat('bot', text);
        }
        
        async function getBotResponse(prompt, specificSystemPrompt = null) {
            showTypingIndicator(true); 
            chatInput.disabled = true; 
            chatForm.querySelector('button[type="submit"]').disabled = true; 
            suggestQuestionsBtn.disabled = true; 

            const messages = [
                { role: "system", content: specificSystemPrompt || systemPrompt },
                ...chatHistory.slice(0, -1),
                { role: "user", content: prompt }
            ];

            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: messages })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                let botResponseText = "Lo siento, hubo un problema al procesar tu solicitud. Por favor, intenta de nuevo.";
                if (result.choices?.[0]?.message?.content) {
                    botResponseText = result.choices[0].message.content;
                }
                addMessageToChat('bot', botResponseText);
                return botResponseText; // Return the response for chaining
            } catch (error) {
                console.error("Error fetching bot response:", error);
                const errorMessage = 'Hubo un problema de conexión. Por favor, verifica tu conexión e inténtalo de nuevo.';
                addMessageToChat('bot', errorMessage);
                return errorMessage;
            } finally {
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
                showTypingIndicator(false); 
            }
        }

        async function generateSuggestedQuestions() {
            suggestQuestionsBtn.disabled = true;
            suggestButtonText.textContent = 'Generando...'; 
            suggestedQuestionsContainer.innerHTML = ''; 
            suggestedQuestionsContainer.classList.add('hidden'); 

            const questionGenerationPrompt = `
                Actúa como VIDA, un asistente de donación de órganos en México.
                Genera 3 preguntas cortas y sencillas que un familiar o público general podría hacer sobre la donación de órganos y tejidos en el contexto de muerte encefálica o parada cardíaca en México.
                Las preguntas deben ser muy concisas y directas.
                Devuelve la respuesta como un array JSON de 3 strings, donde cada string es una pregunta.
            `;
            
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "system", content: "Responde únicamente con un array JSON válido de 3 strings." },
                        { role: "user", content: questionGenerationPrompt }
                    ] })
                });

                if (!response.ok) throw new Error('API request failed');

                const result = await response.json();
                let suggestedQuestions = [];
                if (result.choices?.[0]?.message?.content) {
                    try {
                        suggestedQuestions = JSON.parse(result.choices[0].message.content);
                        displaySuggestedQuestions(suggestedQuestions);
                    } catch (e) {
                        console.error("Error parsing suggested questions JSON:", e);
                        addMessageToChat('bot', 'No pude generar sugerencias. Intenta de nuevo.');
                    }
                }
            } catch (error) {
                console.error("Error generating suggested questions:", error);
                addMessageToChat('bot', 'Hubo un problema al obtener sugerencias.');
            } finally {
                suggestQuestionsBtn.disabled = false;
                suggestButtonText.textContent = 'Sugiere'; 
            }
        }
        
        function displaySuggestedQuestions(questions) {
            suggestedQuestionsContainer.innerHTML = '';
            questions.forEach(q => {
                const button = document.createElement('button');
                button.textContent = q;
                button.className = `px-3 py-2 rounded-lg bg-[var(--vida-suggest-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium 
                                 hover:bg-[var(--vida-suggest-btn-hover)] transition-colores`;
                button.onclick = () => {
                    chatInput.value = q;
                    chatForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                };
                suggestedQuestionsContainer.appendChild(button);
            });
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        // --- Quiz Module Functions ---
        async function startQuiz() {
            quizTotalAnswered = 0;
            currentQuizQuestionIndex = 0;
            quizQuestions = [];
            addMessageToChat('bot', `¡Excelente! Vamos a poner a prueba tus conocimientos sobre la donación con el Desmitificador Express. Te haré bloques de 5 preguntas de verdadero o falso. ¿Estás listo?`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const startButton = document.createElement('button');
            startButton.textContent = "🚀 Iniciar Quiz";
            startButton.className = `px-6 py-3 rounded-lg bg-[var(--vida-btn-green)] text-white font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            startButton.onclick = async () => {
                addMessageToChat('user', 'Iniciar Quiz');
                suggestedQuestionsContainer.innerHTML = '';
                suggestedQuestionsContainer.classList.add('hidden');
                await generateQuizQuestions();
            };
            suggestedQuestionsContainer.appendChild(startButton);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        async function generateQuizQuestions() {
            showTypingIndicator(true);
            chatInput.disabled = true;
            chatForm.querySelector('button[type="submit"]').disabled = true;
            suggestQuestionsBtn.disabled = true;
            const quizGenerationPrompt = `
                Eres VIDA, un asistente de donación de órganos en México.
                Tu tarea es generar ${quizBlockSize} preguntas de VERDADERO o FALSO sobre mitos y realidades comunes acerca de la donación de órganos y tejidos después de que una persona ha fallecido en México. Las preguntas deben ser concisas y formuladas para un público general, ajeno a la medicina.
                Asegúrate de que las explicaciones sean breves (2-3 líneas máximo), claras, y fundamentadas en información oficial (Ley General de Salud, CENATRA, Reglamento de Trasplantes). No uses asteriscos (*) ni viñetas. Si es posible, incluye una referencia breve a la fuente oficial. Las preguntas deben ser variadas y no repetirse.
                Devuelve únicamente un array JSON válido de ${quizBlockSize} objetos, cada uno con 'question', 'isTrue' y 'explanation'.
            `;
            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: [
                        { role: "user", content: quizGenerationPrompt }
                    ] })
                });
                if (!response.ok) throw new Error('API request for quiz failed');
                const result = await response.json();
                let quizRaw = result.choices?.[0]?.message?.content || '';
                let quizArr = extractFirstJSONArray(quizRaw);
                if (!quizArr || !Array.isArray(quizArr) || quizArr.length < 2) {
                    addMessageToChat('bot', 'No se pudo generar el quiz correctamente. El formato recibido fue inesperado. Intenta de nuevo más tarde.\n\nRespuesta recibida:\n' + quizRaw);
                    currentQuizQuestionIndex = -1;
                    return;
                }
                quizQuestions = quizArr;
                currentQuizQuestionIndex = 0;
                displayQuizQuestion(currentQuizQuestionIndex);
            } catch (error) {
                console.error("Error generating quiz questions:", error);
                addMessageToChat('bot', 'Hubo un problema de conexión al generar el quiz. Por favor, inténtalo de nuevo.');
                currentQuizQuestionIndex = -1;
            } finally {
                showTypingIndicator(false);
                chatInput.disabled = false;
                chatForm.querySelector('button[type="submit"]').disabled = false;
                suggestQuestionsBtn.disabled = false;
                chatInput.focus();
            }
        }

        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                quizTotalAnswered += quizQuestions.length;
                if (quizTotalAnswered >= quizMaxQuestions) {
                    endQuiz();
                    return;
                }
                // Mostrar opción de seguir o terminar
                suggestedQuestionsContainer.innerHTML = '';
                suggestedQuestionsContainer.classList.remove('hidden');
                const moreBtn = document.createElement('button');
                moreBtn.textContent = `Quiero más preguntas (${quizTotalAnswered}/${quizMaxQuestions})`;
                moreBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
                moreBtn.onclick = async () => {
                    addMessageToChat('user', moreBtn.textContent);
                    suggestedQuestionsContainer.innerHTML = '';
                    suggestedQuestionsContainer.classList.add('hidden');
                    await generateQuizQuestions();
                };
                suggestedQuestionsContainer.appendChild(moreBtn);
                const finishBtn = document.createElement('button');
                finishBtn.textContent = "Terminar Quiz";
                finishBtn.className = `ml-2 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm`;
                finishBtn.onclick = () => {
                    addMessageToChat('user', finishBtn.textContent);
                    endQuiz();
                };
                suggestedQuestionsContainer.appendChild(finishBtn);
                return;
            }
            const questionData = quizQuestions[index];
            addMessageToChat('bot', `Pregunta ${quizTotalAnswered + index + 1} de ${quizMaxQuestions}: ${questionData.question}`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const trueBtn = document.createElement('button');
            trueBtn.textContent = "✅ Verdadero";
            trueBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            trueBtn.onclick = () => handleAnswerClick(true, questionData);
            suggestedQuestionsContainer.appendChild(trueBtn);
            const falseBtn = document.createElement('button');
            falseBtn.textContent = "❌ Falso";
            falseBtn.className = `px-6 py-3 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            falseBtn.onclick = () => handleAnswerClick(false, questionData);
            suggestedQuestionsContainer.appendChild(falseBtn);
            chatContainerWrapper.scrollTop = chatContainerWrapper.scrollHeight;
        }

        function handleAnswerClick(isTrueAnswer, questionData) {
            addMessageToChat('user', isTrueAnswer ? "✅ Verdadero" : "❌ Falso");
            const quizButtons = suggestedQuestionsContainer.querySelectorAll('button');
            quizButtons.forEach(button => {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            });
            const isCorrect = (isTrueAnswer === questionData.isTrue);
            let feedbackText = isCorrect ? "✔️ ¡Correcto!" : "❌ Incorrecto.";
            feedbackText += `\n${questionData.explanation}`;
            addMessageToChat('bot', feedbackText);
            suggestedQuestionsContainer.innerHTML = '';
            const nextQuestionBtn = document.createElement('button');
            nextQuestionBtn.textContent = "➡️ Siguiente pregunta";
            nextQuestionBtn.className = `mt-4 px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores`;
            nextQuestionBtn.onclick = () => {
                addMessageToChat('user', nextQuestionBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex++;
                displayQuizQuestion(currentQuizQuestionIndex);
            };
            suggestedQuestionsContainer.appendChild(nextQuestionBtn);
            suggestedQuestionsContainer.classList.remove('hidden');
        }

        function endQuiz() {
            addMessageToChat('bot', `🎉 ¡Has completado el Desmitificador Express! Respondiste ${quizTotalAnswered} preguntas. Gracias por informarte con VIDA. Cada duda resuelta es un paso más hacia una cultura de donación más humana y consciente.`);
            suggestedQuestionsContainer.innerHTML = '';
            suggestedQuestionsContainer.classList.remove('hidden');
            const startDonorPathBtn = document.createElement('button');
            startDonorPathBtn.textContent = "Iniciar “Tu camino como donante”";
            startDonorPathBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-btn-green)] text-white text-sm font-bold shadow-md hover:bg-[var(--vida-btn-green-hover)] transition-colores`;
            startDonorPathBtn.onclick = () => {
                addMessageToChat('user', startDonorPathBtn.textContent);
                suggestedQuestionsContainer.classList.add('hidden');
                suggestedQuestionsContainer.innerHTML = '';
                currentQuizQuestionIndex = -1;
                currentDonorPathStep = 'introduction';
                displayDonorPathStep(currentDonorPathStep);
            };
            suggestedQuestionsContainer.appendChild(startDonorPathBtn);
            const askAnotherQuestionBtn = document.createElement('button');
            askAnotherQuestionBtn.textContent = "Hacer otra pregunta a VIDA";
            askAnotherQuestionBtn.className = `px-4 py-2 rounded-lg bg-[var(--vida-module-btn-bg)] text-[var(--vida-module-btn-text)] text-sm font-medium hover:bg-[var(--vida-module-btn-hover)] transition-colores shadow-sm`;
            askAnotherQuestionBtn.onclick = () => {
                addMessageToChat('user', askAnotherQuestionBtn.textContent);
                reset_chat_and_offer_suggestions();
            };
            suggestedQuestionsContainer.appendChild(askAnotherQuestionBtn);
        }

        // --- Interactive Background with three.js ---
        let scene, camera, renderer, particles, mouseX = 0, mouseY = 0;

        function initBackground() {
            const canvas = document.getElementById('bg-canvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const particleCount = 300;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const color = new THREE.Color();

            for (let i = 0; i < particleCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 20;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 20;
                
                // Colores que combinen con el tema médico
                const hue = 0.5 + Math.random() * 0.3; // Azules y verdes
                color.setHSL(hue, 0.6, 0.6 + Math.random() * 0.2);
                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.03,
                vertexColors: true,
                blending: THREE.AdditiveBlending,
                transparent: true,
                opacity: 0.6
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            camera.position.z = 8;

            document.addEventListener('mousemove', onMouseMove, false);
            window.addEventListener('resize', onWindowResize, false);
        }

        function onMouseMove(event) {
            mouseX = (event.clientX - window.innerWidth / 2) / 1000;
            mouseY = (event.clientY - window.innerHeight / 2) / 1000;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animateBackground() {
            requestAnimationFrame(animateBackground);
            const time = Date.now() * 0.0001;
            
            camera.position.x += (mouseX - camera.position.x) * 0.03;
            camera.position.y += (-mouseY - camera.position.y) * 0.03;
            camera.lookAt(scene.position);

            particles.rotation.x = time * 0.1;
            particles.rotation.y = time * 0.15;
            
            renderer.render(scene, camera);
        }

        // Initialize background when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initBackground();
            animateBackground();
            
            // Inicializar variables CSS para viewport height en móviles
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            // Establecer valor inicial
            setVH();
            
            // Actualizar en cambios de viewport (incluyendo teclado)
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', () => {
                setTimeout(setVH, 100);
            });
        });

    </script>
</body>
</html>
