<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Quiz - VIDA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --vida-text-dark: #0D47A1;
            --vida-btn-green: #66BB6A;
            --vida-btn-green-hover: #43A047;
            --vida-text-secondary: #757575;
            --vida-btn-feedback: #4FC3F7;
            --vida-quiz-btn-correct: #4CAF50;
            --vida-quiz-btn-incorrect: #F44336;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2f1 100%);
        }

        .quiz-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease;
        }
        .quiz-card:hover {
            transform: translateY(-5px);
        }
        .quiz-answer-btn {
            transition: all 0.2s ease-in-out;
        }
        .quiz-answer-btn:hover {
            transform: scale(1.03);
        }
        .quiz-answer-btn.correct {
            background-color: var(--vida-quiz-btn-correct) !important;
            color: white;
            border-color: var(--vida-quiz-btn-correct) !important;
        }
        .quiz-answer-btn.incorrect {
            background-color: var(--vida-quiz-btn-incorrect) !important;
            color: white;
            border-color: var(--vida-quiz-btn-incorrect) !important;
        }
        .quiz-answer-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        #quiz-feedback {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out, margin-top 0.5s ease-out;
        }
        #quiz-feedback.visible {
            max-height: 200px;
            opacity: 1;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- QUIZ SCREEN -->
    <div id="quiz-screen" class="w-full">
        <header class="w-full max-w-3xl mx-auto flex justify-between items-center mb-8">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 bg-[var(--vida-text-dark)] rounded-full flex items-center justify-center shadow">
                    <svg class="h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2c-3.87 0-7 3.13-7 7 0 3.73 2.7 6.84 6.3 7.64V22h1.4c.26 0 .5-.11.6-.33.15-.36-.04-.77-.4-.92L11.5 20h1v-1.12c3.6-1.12 6.3-4.23 6.3-7.64 0-3.87-3.13-7-7-7zm0 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                </div>
                <h2 class="text-2xl font-bold text-[var(--vida-text-dark)]">Desmitificador Express</h2>
            </div>
            <button id="exit-quiz-btn" class="text-gray-500 hover:bg-gray-200 p-2 rounded-full" title="Salir del Quiz">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>

        <main id="quiz-main-content" class="w-full max-w-3xl mx-auto">
            <!-- Vista Inicial del Quiz -->
            <div id="quiz-start-view" class="text-center p-8 bg-white rounded-2xl shadow-lg">
                <h3 class="text-3xl font-bold text-[var(--vida-text-dark)]">Pon a prueba tus conocimientos</h3>
                <p class="mt-4 text-lg text-slate-600">Te har√© 10 preguntas de verdadero o falso para desmentir los mitos m√°s comunes sobre la donaci√≥n.</p>
                <p class="mt-2 text-md text-slate-500">El quiz se divide en 2 rondas de 5 preguntas cada una.</p>
                <button id="begin-quiz-btn" class="mt-8 bg-[var(--vida-btn-green)] text-white font-bold py-4 px-10 rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105">
                    ¬°Estoy listo!
                </button>
            </div>

            <!-- Vista del Quiz Activo -->
            <div id="quiz-active-view" class="hidden">
                <div class="quiz-card p-6 md:p-8 w-full">
                    <div class="flex justify-between items-center mb-4">
                        <div id="quiz-progress" class="font-semibold text-[var(--vida-text-secondary)]"></div>
                        <div id="quiz-round-info" class="font-semibold text-[var(--vida-text-dark)]"></div>
                    </div>
                    <p id="quiz-question" class="text-2xl md:text-3xl font-medium text-slate-800 min-h-[100px] flex items-center justify-center text-center"></p>
                    <div id="quiz-answer-buttons" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    <div id="quiz-feedback" class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p id="quiz-feedback-text" class="text-center text-slate-700"></p>
                    </div>
                </div>
                <div id="quiz-navigation" class="mt-6 text-center"></div>
            </div>

            <!-- Vista de Resultados Parciales -->
            <div id="quiz-partial-results-view" class="hidden text-center p-8 bg-white rounded-2xl shadow-lg">
                <h3 class="text-3xl font-bold text-[var(--vida-text-dark)]">¬°Ronda completada!</h3>
                <div id="partial-results-content" class="mt-6">
                    <p id="round-score-text" class="text-2xl text-slate-600 mb-4"></p>
                    <p id="total-progress-text" class="text-lg text-slate-500 mb-4"></p>
                    <div id="round-feedback" class="text-lg text-slate-700 mb-6"></div>
                </div>
                <div class="mt-8">
                    <button id="continue-quiz-btn" class="bg-[var(--vida-btn-green)] text-white font-bold py-4 px-10 rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all transform hover:scale-105">
                        Continuar con la siguiente ronda
                    </button>
                </div>
            </div>
            
            <!-- Vista de Resultados Finales del Quiz -->
            <div id="quiz-results-view" class="hidden text-center p-8 bg-white rounded-2xl shadow-lg">
                 <h3 class="text-3xl font-bold text-[var(--vida-text-dark)]">¬°Quiz completado!</h3>
                 <div class="mt-6">
                     <p id="quiz-score-text" class="text-2xl text-slate-600 mb-4"></p>
                     <div id="final-feedback" class="text-lg text-slate-700 mb-6"></div>
                     <p class="text-lg text-slate-500">Cada duda resuelta es un paso m√°s hacia una cultura de donaci√≥n m√°s consciente.</p>
                 </div>
                 <div class="mt-8 flex flex-col sm:flex-row justify-center gap-4">
                     <button id="restart-quiz-btn" class="bg-[var(--vida-btn-feedback)] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-400 transition-all transform hover:scale-105">
                        Jugar de nuevo
                    </button>
                    <button id="return-home-btn" class="bg-gray-200 text-gray-800 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-300 transition-all transform hover:scale-105">
                        Volver al inicio
                    </button>
                 </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Elements ---
        const quizScreen = document.getElementById('quiz-screen');
        const exitQuizBtn = document.getElementById('exit-quiz-btn');
        const quizStartView = document.getElementById('quiz-start-view');
        const quizActiveView = document.getElementById('quiz-active-view');
        const quizPartialResultsView = document.getElementById('quiz-partial-results-view');
        const quizResultsView = document.getElementById('quiz-results-view');
        const beginQuizBtn = document.getElementById('begin-quiz-btn');
        const quizProgress = document.getElementById('quiz-progress');
        const quizRoundInfo = document.getElementById('quiz-round-info');
        const quizQuestion = document.getElementById('quiz-question');
        const quizAnswerButtons = document.getElementById('quiz-answer-buttons');
        const quizFeedback = document.getElementById('quiz-feedback');
        const quizFeedbackText = document.getElementById('quiz-feedback-text');
        const quizNavigation = document.getElementById('quiz-navigation');
        const quizScoreText = document.getElementById('quiz-score-text');
        const roundScoreText = document.getElementById('round-score-text');
        const totalProgressText = document.getElementById('total-progress-text');
        const roundFeedback = document.getElementById('round-feedback');
        const finalFeedback = document.getElementById('final-feedback');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const returnHomeBtn = document.getElementById('return-home-btn');
        const continueQuizBtn = document.getElementById('continue-quiz-btn');

        // --- State ---
        let currentQuizQuestionIndex = 0;
        let currentRound = 1;
        let quizQuestions = [];
        let quizScore = 0;
        let roundScores = [];
        const QUESTIONS_PER_ROUND = 5;
        const TOTAL_QUESTIONS = 10; // Cambiado a 10 preguntas
        const TOTAL_ROUNDS = 2;     // Cambiado a 2 rondas

        // --- API Call Function ---
        async function callOpenAI(messages) {
            try {
                console.log('Calling OpenAI API with messages:', messages);
                
                // Use the same format as the working chat in index.html
                const payload = {
                    prompt: messages
                };
                
                console.log('Sending payload:', payload);
                
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('API Response:', result);
                return result;
            } catch (error) {
                console.error("Error calling OpenAI backend:", error);
                throw error;
            }
        }

        // --- QUIZ FUNCTIONS ---
        
        // Preguntas de respaldo en caso de fallo de la API
        const fallbackQuestions = [
            {
                question: "Si soy donante, recibir√© peor atenci√≥n m√©dica en los hospitales",
                isTrue: false,
                explanation: "Falso. Los m√©dicos tienen la obligaci√≥n de brindar la mejor atenci√≥n m√©dica posible sin importar si eres donante o no. El personal que atiende emergencias es diferente al que coordina donaciones."
            },
            {
                question: "La donaci√≥n de √≥rganos desfigura el cuerpo y no permite un funeral con ata√∫d abierto",
                isTrue: false,
                explanation: "Falso. Los procedimientos de extracci√≥n se realizan con t√©cnicas quir√∫rgicas que respetan la apariencia f√≠sica. El cuerpo puede ser preparado normalmente para el funeral."
            },
            {
                question: "Solo las personas j√≥venes pueden ser donantes de √≥rganos",
                isTrue: false,
                explanation: "Falso. No hay l√≠mite de edad para ser donante. La viabilidad de los √≥rganos se eval√∫a caso por caso, y personas mayores han sido donantes exitosos."
            },
            {
                question: "Las religiones proh√≠ben la donaci√≥n de √≥rganos",
                isTrue: false,
                explanation: "Falso. La mayor√≠a de las religiones apoyan la donaci√≥n como un acto de generosidad y amor al pr√≥jimo. El Vaticano, el Islam y el Juda√≠smo la consideran permitida y altruista."
            },
            {
                question: "La muerte cerebral es lo mismo que estar en coma",
                isTrue: false,
                explanation: "Falso. La muerte cerebral es la p√©rdida irreversible de todas las funciones cerebrales, mientras que el coma es un estado de inconsciencia del cual se puede recuperar."
            },
            {
                question: "Los ricos tienen prioridad para recibir √≥rganos trasplantados",
                isTrue: false,
                explanation: "Falso. La asignaci√≥n de √≥rganos se basa en criterios m√©dicos como compatibilidad, urgencia y tiempo en lista de espera, no en estatus econ√≥mico."
            },
            {
                question: "Puedo cambiar de opini√≥n sobre ser donante en cualquier momento",
                isTrue: true,
                explanation: "Verdadero. Puedes modificar tu decisi√≥n de ser donante en cualquier momento, ya sea registr√°ndote o eliminando tu registro de donante."
            },
            {
                question: "La familia debe pagar los costos de la donaci√≥n de √≥rganos",
                isTrue: false,
                explanation: "Falso. Todos los gastos relacionados con la donaci√≥n de √≥rganos son cubiertos por el sistema de salud, no por la familia del donante."
            },
            {
                question: "Se pueden vender √≥rganos legalmente en M√©xico",
                isTrue: false,
                explanation: "Falso. La venta de √≥rganos est√° estrictamente prohibida en M√©xico. La donaci√≥n debe ser altruista y sin fines de lucro."
            },
            {
                question: "Un donante puede salvar hasta 8 vidas",
                isTrue: true,
                explanation: "Verdadero. Un solo donante puede donar coraz√≥n, h√≠gado, ri√±ones, pulmones, p√°ncreas, intestinos y tejidos como c√≥rneas, beneficiando hasta 8 personas o m√°s."
            },
            {
                question: "Los √≥rganos donados tienen fecha de caducidad muy corta",
                isTrue: true,
                explanation: "Verdadero. Los √≥rganos deben trasplantarse r√°pidamente: el coraz√≥n en 4-6 horas, el h√≠gado en 12-24 horas, los ri√±ones hasta 72 horas."
            },
            {
                question: "M√©xico tiene uno de los √≠ndices m√°s bajos de donaci√≥n en Am√©rica Latina",
                isTrue: true,
                explanation: "Verdadero. M√©xico tiene aproximadamente 3-4 donantes por mill√≥n de habitantes, muy por debajo del promedio regional y mundial."
            },
            {
                question: "Solo se pueden donar √≥rganos despu√©s de muerte cerebral",
                isTrue: false,
                explanation: "Falso. Tambi√©n se puede donar despu√©s de paro card√≠aco en condiciones controladas, aunque las opciones de √≥rganos viables son m√°s limitadas."
            },
            {
                question: "Los testigos de Jehov√° no pueden ser donantes por sus creencias",
                isTrue: false,
                explanation: "Falso. Aunque tienen restricciones sobre transfusiones de sangre, muchos testigos de Jehov√° pueden ser donantes de √≥rganos s√≥lidos."
            },
            {
                question: "La donaci√≥n de c√≥rneas puede realizarse varias horas despu√©s del fallecimiento",
                isTrue: true,
                explanation: "Verdadero. Las c√≥rneas pueden extraerse hasta 12 horas despu√©s del fallecimiento, a diferencia de otros √≥rganos que requieren extracci√≥n inmediata."
            },
            {
                question: "Un alcoh√≥lico no puede donar su h√≠gado",
                isTrue: false,
                explanation: "Falso. Cada caso se eval√∫a individualmente. Algunos √≥rganos de personas con historial de alcoholismo pueden ser viables para trasplante."
            },
            {
                question: "El CENATRA es el organismo que coordina las donaciones en M√©xico",
                isTrue: true,
                explanation: "Verdadero. El Centro Nacional de Trasplantes (CENATRA) es la instituci√≥n responsable de coordinar el sistema nacional de donaci√≥n y trasplantes."
            },
            {
                question: "Se necesita autorizaci√≥n familiar para donar, aunque est√© registrado como donante",
                isTrue: true,
                explanation: "Verdadero. En M√©xico, aunque est√©s registrado como donante, se requiere el consentimiento familiar para proceder con la donaci√≥n."
            },
            {
                question: "Los √≥rganos donados pueden rechazarse por el cuerpo receptor",
                isTrue: true,
                explanation: "Verdadero. El rechazo es un riesgo real que requiere medicamentos inmunosupresores de por vida para prevenirlo."
            },
            {
                question: "Una persona diab√©tica no puede ser donante de ning√∫n √≥rgano",
                isTrue: false,
                explanation: "Falso. Dependiendo del tipo y control de la diabetes, algunos √≥rganos como ri√±ones o c√≥rneas pueden ser viables para donaci√≥n."
            }
        ];

        function resetQuiz() {
            quizScore = 0;
            currentQuizQuestionIndex = 0;
            currentRound = 1;
            quizQuestions = [];
            roundScores = [];
            quizStartView.classList.remove('hidden');
            quizActiveView.classList.add('hidden');
            quizPartialResultsView.classList.add('hidden');
            quizResultsView.classList.add('hidden');
            quizNavigation.innerHTML = '';
            quizFeedback.classList.remove('visible');
        }

        beginQuizBtn.addEventListener('click', async () => {
            quizStartView.classList.add('hidden');
            quizActiveView.classList.remove('hidden');
            quizQuestion.textContent = 'Generando preguntas para la ronda 1...';
            await generateQuizQuestions();
        });

        continueQuizBtn.addEventListener('click', async () => {
            quizPartialResultsView.classList.add('hidden');
            quizActiveView.classList.remove('hidden');
            quizQuestion.textContent = `Generando preguntas para la ronda ${currentRound}...`;
            await generateQuizQuestions();
        });

        restartQuizBtn.addEventListener('click', resetQuiz);
        exitQuizBtn.addEventListener('click', () => {
             // Cerrar ventana si se abri√≥ como popup, o redirigir si se abri√≥ como p√°gina
             if (window.opener) {
                 window.close();
             } else {
                 window.location.href = 'index.html';
             }
        });
         returnHomeBtn.addEventListener('click', () => {
             // Cerrar ventana si se abri√≥ como popup, o redirigir si se abri√≥ como p√°gina
             if (window.opener) {
                 window.close();
             } else {
                 window.location.href = 'index.html';
             }
        });

        async function generateQuizQuestions() {
            const quizGenerationPrompt = `
                Eres VIDA, un asistente de donaci√≥n de √≥rganos en M√©xico.
                Tu tarea es generar 5 preguntas √∫nicas de VERDADERO o FALSO sobre mitos y realidades comunes acerca de la donaci√≥n de √≥rganos y tejidos despu√©s de que una persona ha fallecido en M√©xico.
                Devuelve la respuesta como un array JSON de 5 objetos con las propiedades: "question" (string), "isTrue" (boolean), "explanation" (string).
                Las explicaciones deben ser breves, claras y fundamentadas en informaci√≥n oficial (Ley General de Salud, CENATRA). No uses asteriscos.
                Var√≠a la dificultad de las preguntas para que sea educativo y desafiante. 
                Aseg√∫rate de que las preguntas sean diferentes cada vez y cubran diversos aspectos de la donaci√≥n.
            `;
            
            const messages = [
                { role: "system", content: "Responde √∫nicamente con un array JSON v√°lido de 5 objetos." },
                { role: "user", content: quizGenerationPrompt }
            ];

            try {
                console.log(`Generating quiz questions for round ${currentRound}...`);
                const result = await callOpenAI(messages);
                
                if (result.choices?.[0]?.message?.content) {
                    console.log('Raw API response:', result.choices[0].message.content);
                    
                    // Intentar parsear el JSON
                    try {
                        const newQuestions = JSON.parse(result.choices[0].message.content);
                        console.log('Parsed questions:', newQuestions);
                        
                        if (newQuestions.length > 0) {
                            // Agregar las nuevas preguntas al array existente
                            quizQuestions = quizQuestions.concat(newQuestions);
                            displayQuizQuestion();
                        } else {
                            throw new Error("Generated question array is empty.");
                        }
                    } catch (parseError) {
                        console.error("JSON Parse Error:", parseError);
                        console.log("Content that failed to parse:", result.choices[0].message.content);
                        throw new Error("Invalid JSON format from API");
                    }
                } else {
                     console.error("Empty or invalid response structure:", result);
                     throw new Error("Empty response from API for quiz questions.");
                }
            } catch (error) {
                console.error("Error generating quiz questions:", error);
                console.log("Using fallback questions...");
                
                // Usar preguntas de respaldo si falla la IA
                useFallbackQuestions();
            }
        }
        
        function useFallbackQuestions() {
            console.log("Using fallback questions for round", currentRound);
            
            // Calcular qu√© preguntas usar para esta ronda
            const startIndex = (currentRound - 1) * QUESTIONS_PER_ROUND;
            const endIndex = startIndex + QUESTIONS_PER_ROUND;
            
            // Mezclar las preguntas de respaldo y tomar las que corresponden a esta ronda
            const shuffledFallback = [...fallbackQuestions].sort(() => Math.random() - 0.5);
            const roundQuestions = shuffledFallback.slice(startIndex, endIndex);
            
            // Si no hay suficientes preguntas en fallback, repetir algunas
            while (roundQuestions.length < QUESTIONS_PER_ROUND && shuffledFallback.length > 0) {
                const additionalQuestions = shuffledFallback.slice(0, QUESTIONS_PER_ROUND - roundQuestions.length);
                roundQuestions.push(...additionalQuestions);
            }
            
            // Agregar las preguntas de respaldo al array principal
            quizQuestions = quizQuestions.concat(roundQuestions);
            
            quizQuestion.innerHTML = `
                <div class="text-center">
                    <p class="text-yellow-600 mb-4">‚ö†Ô∏è Conexi√≥n limitada</p>
                    <p class="text-slate-600 mb-4">Usando preguntas predefinidas para continuar el quiz.</p>
                </div>
            `;
            
            // Mostrar la primera pregunta despu√©s de un breve delay
            setTimeout(() => {
                displayQuizQuestion();
            }, 2000);
        }

        function displayQuizQuestion() {
            if (currentQuizQuestionIndex >= quizQuestions.length) {
                endQuiz();
                return;
            }

            const questionData = quizQuestions[currentQuizQuestionIndex];
            const questionInRound = (currentQuizQuestionIndex % QUESTIONS_PER_ROUND) + 1;
            
            quizProgress.textContent = `Pregunta ${questionInRound} de ${QUESTIONS_PER_ROUND}`;
            quizRoundInfo.textContent = `Ronda ${currentRound} de ${TOTAL_ROUNDS}`;
            quizQuestion.textContent = questionData.question;
            
            quizAnswerButtons.innerHTML = '';
            quizFeedback.classList.remove('visible');
            quizNavigation.innerHTML = '';

            const trueBtn = document.createElement('button');
            trueBtn.textContent = "‚úÖ Verdadero";
            trueBtn.className = 'quiz-answer-btn w-full text-lg font-bold p-4 border-2 border-gray-300 rounded-lg hover:bg-gray-100';
            trueBtn.onclick = () => handleQuizAnswer(true, questionData, trueBtn, falseBtn);
            
            const falseBtn = document.createElement('button');
            falseBtn.textContent = "‚ùå Falso";
            falseBtn.className = 'quiz-answer-btn w-full text-lg font-bold p-4 border-2 border-gray-300 rounded-lg hover:bg-gray-100';
            falseBtn.onclick = () => handleQuizAnswer(false, questionData, falseBtn, trueBtn);

            quizAnswerButtons.appendChild(trueBtn);
            quizAnswerButtons.appendChild(falseBtn);
        }

        function handleQuizAnswer(userAnswer, questionData, selectedBtn, otherBtn) {
            selectedBtn.disabled = true;
            otherBtn.disabled = true;

            const isCorrect = (userAnswer === questionData.isTrue);
            
            if (isCorrect) {
                quizScore++;
                selectedBtn.classList.add('correct');
            } else {
                selectedBtn.classList.add('incorrect');
                if (questionData.isTrue) {
                    otherBtn.classList.add('correct');
                } else {
                    otherBtn.classList.add('correct');
                }
            }
            
            quizFeedbackText.textContent = questionData.explanation;
            quizFeedback.classList.add('visible');

            const nextButton = document.createElement('button');
            const questionInRound = (currentQuizQuestionIndex % QUESTIONS_PER_ROUND) + 1;
            
            if (questionInRound === QUESTIONS_PER_ROUND && currentRound < TOTAL_ROUNDS) {
                nextButton.textContent = 'Ver resultados de la ronda üìä';
                nextButton.onclick = () => showPartialResults();
            } else if (currentQuizQuestionIndex === quizQuestions.length - 1) {
                nextButton.textContent = 'Ver Resultados Finales üèÜ';
                nextButton.onclick = () => endQuiz();
            } else {
                nextButton.textContent = 'Siguiente Pregunta ‚û°Ô∏è';
                nextButton.onclick = () => {
                    currentQuizQuestionIndex++;
                    displayQuizQuestion();
                };
            }
            
            nextButton.className = 'bg-[var(--vida-btn-green)] text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-[var(--vida-btn-green-hover)] transition-all';
            quizNavigation.innerHTML = '';
            quizNavigation.appendChild(nextButton);
        }

        function showPartialResults() {
            const roundStartIndex = (currentRound - 1) * QUESTIONS_PER_ROUND;
            const roundEndIndex = currentRound * QUESTIONS_PER_ROUND;
            const roundQuestionsCount = QUESTIONS_PER_ROUND;
            
            // Calcular puntaje de la ronda actual
            let roundScore = 0;
            for (let i = roundStartIndex; i < roundEndIndex && i < quizQuestions.length; i++) {
                const questionData = quizQuestions[i];
                // Necesitamos una forma de saber si la respuesta fue correcta
                // Por simplicidad, calculamos basado en el puntaje total acumulado
            }
            
            // Aproximaci√≥n del puntaje de la ronda
            const previousRoundsTotalScore = roundScores.reduce((sum, score) => sum + score, 0);
            roundScore = quizScore - previousRoundsTotalScore;
            roundScores.push(roundScore);
            
            quizActiveView.classList.add('hidden');
            quizPartialResultsView.classList.remove('hidden');
            
            roundScoreText.textContent = `Ronda ${currentRound}: ${roundScore} de ${roundQuestionsCount} correctas`;
            totalProgressText.textContent = `Progreso total: ${quizScore} de ${currentQuizQuestionIndex + 1} preguntas`;
            
            // Feedback basado en el rendimiento de la ronda
            let feedback = '';
            const percentage = (roundScore / roundQuestionsCount) * 100;
            if (percentage >= 80) {
                feedback = '¬°Excelente! Tienes un gran conocimiento sobre donaci√≥n de √≥rganos.';
            } else if (percentage >= 60) {
                feedback = '¬°Bien hecho! Vas por buen camino, sigue as√≠.';
            } else if (percentage >= 40) {
                feedback = 'Vas aprendiendo. Cada pregunta te acerca m√°s a la verdad.';
            } else {
                feedback = 'No te preocupes, lo importante es aprender. ¬°Contin√∫a!';
            }
            roundFeedback.textContent = feedback;
            
            currentQuizQuestionIndex++;
            currentRound++;
        }

        function endQuiz() {
            quizActiveView.classList.add('hidden');
            quizResultsView.classList.remove('hidden');
            
            const finalPercentage = (quizScore / TOTAL_QUESTIONS) * 100;
            quizScoreText.textContent = `Obtuviste ${quizScore} de ${TOTAL_QUESTIONS} respuestas correctas (${finalPercentage.toFixed(1)}%)`;
            
            // Feedback final detallado
            let finalFeedbackText = '';
            if (finalPercentage >= 90) {
                finalFeedbackText = '¬°Eres un experto en donaci√≥n de √≥rganos! Tu conocimiento puede ayudar a salvar vidas.';
            } else if (finalPercentage >= 75) {
                finalFeedbackText = '¬°Excelente! Tienes un s√≥lido conocimiento sobre donaci√≥n de √≥rganos.';
            } else if (finalPercentage >= 60) {
                finalFeedbackText = '¬°Bien hecho! Tienes buenas bases, sigue aprendiendo para convertirte en un embajador de la donaci√≥n.';
            } else if (finalPercentage >= 45) {
                finalFeedbackText = 'Vas por buen camino. Cada respuesta te acerca m√°s a comprender la importancia de la donaci√≥n.';
            } else {
                finalFeedbackText = 'El conocimiento es poder. Sigue aprendiendo sobre donaci√≥n de √≥rganos para ayudar a desmitificar este tema tan importante.';
            }
            finalFeedback.textContent = finalFeedbackText;
        }

    </script>
</body>
</html>
